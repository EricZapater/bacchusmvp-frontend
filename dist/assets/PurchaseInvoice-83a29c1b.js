import{d as J,z as ee,o as Q,r as B,j as X,h as y,a as R,c as H,k as t,e as n,i as l,y as z,n as M,s as L,D as k,l as G,p as re,b as ie,f as ue,I as te,F as x,m as O,w as _,P as W,C as $,v as de,g as ce,u as me,G as pe}from"./index-7e4c2741.js";import{a as oe,u as K}from"./purchaseInvoices-6b764774.js";import{g as ae,f as ve}from"./functions-fa75c0c2.js";import{F as Ie}from"./FileEntityPicker-b82d8886.js";import{c as se,a as Z,F as ne,d as be}from"./form-validator-5a5505d1.js";import{l as q}from"./lodash-7142707f.js";import"./index-81b297f5.js";import"./base.service-64a7477a.js";import"./index-059d08c4.js";import"./suppliers.service-4b3a1f05.js";import"./v4-a960c1f4.js";import"./file.service-f597bc32.js";const U=C=>(re("data-v-96908432"),C=C(),ie(),C),fe={key:0},_e={class:"four-columns"},he=U(()=>n("label",{class:"block text-900 mb-2"},"Exercici",-1)),Ae=U(()=>n("label",{class:"block text-900 mb-2"},"Sèrie",-1)),xe=U(()=>n("label",{class:"block text-900 mb-2"},"Estat",-1)),ye={class:"four-columns"},Ve={class:"mt-1"},De=U(()=>n("label",{class:"block text-900 mb-2"},"Proveïdor",-1)),ge={class:"mt-1"},we={class:"mt-1"},Te=U(()=>n("label",{class:"block text-900 mb-2"},"Data Factura",-1)),Ee={class:"mt-1"},Fe=U(()=>n("label",{class:"block text-900 mb-2"},"Forma de pagament",-1)),Ce={class:"four-columns"},Pe={class:"mt-1"},Se={class:"mt-1"},ke={class:"mt-1"},Ue={class:"four-columns"},Ne={class:"mt-1"},Re=U(()=>n("label",{class:"block text-900 mb-2"},"Base",-1)),Be={class:"summary-field"},Me={class:"mt-1"},$e=U(()=>n("label",{class:"block text-900 mb-2"},"Impostos",-1)),Le={class:"summary-field"},Ye={class:"mt-1"},ze=U(()=>n("label",{class:"block text-900 mb-2"},"Total",-1)),Ge={class:"summary-field"},je=J({__name:"FormPurchaseInvoice",emits:["submit","cancel"],setup(C,{expose:w,emit:p}){const D=oe(),g=K(),{purchaseInvoice:e}=ee(D);Q(()=>{setTimeout(()=>{e.value&&e.value.purchaseInvoiceImports.length>0&&(e.value.taxAmount=h())},500)});const E=se().shape({exerciceId:Z().required("L'exercici es obligatori"),supplierId:Z().required("El proveïdor es obligatori")}),m=B({result:!1,errors:{}}),s=()=>{const c=new ne(E);m.value=c.validate(e.value)},V=()=>{var c;return((c=e.value)==null?void 0:c.purchaseInvoiceImports.length)===0?(a.add({severity:"warn",summary:"Formulari inválid",detail:"Ha d'introduir els imports de factura",life:5e3}),!1):!0};let b=!1;Q(()=>{setTimeout(()=>{b=!0},500)});const a=X(),u=async()=>{if(s(),m.value.result){if(!V())return;p("submit",e.value)}else{let c="";Object.entries(m.value.errors).forEach(o=>{c+=`${o[1].map(f=>f)}.   `}),a.add({severity:"warn",summary:"Formulari inválid",detail:c,life:5e3})}},v=()=>{var o;const c=(o=g.masterData.suppliers)==null?void 0:o.find(f=>{var F;return f.id===((F=e.value)==null?void 0:F.supplierId)});c&&(e.value.paymentMethodId=c.paymentMethodId,I())},I=async()=>{if(b){if(e.value){let c=0,o=0,f=0,F=0,r=0,d=0,i=0,A=0,T=0,P=0;c=Y(),F=h(),e.value.transportAmount&&(o=parseFloat(e.value.transportAmount.toFixed(2))),e.value.discountPercentage&&(i=parseFloat(e.value.discountPercentage.toFixed(2))),e.value.extraTaxPercentatge&&(T=e.value.extraTaxPercentatge),f=(c+o)*1,P=f*(T/100),A=f+F*1-P*1,d=A*(1*i)/100,r=parseFloat((A-d).toFixed(2)),e.value.baseAmount=c,e.value.transportAmount=o,e.value.subtotal=f,e.value.taxAmount=F,e.value.grossAmount=A,e.value.netAmount=r,e.value.discountPercentage=i,e.value.discountAmount=d,e.value.extraTaxPercentatge=T,e.value.extraTaxAmount=P,e.value.purchaseInvoiceDueDates=await D.GetDueDates(e.value)}console.log("calcAmounts",e.value)}},Y=()=>{let c=0;return e.value&&e.value.purchaseInvoiceImports.forEach(o=>c+=o.baseAmount),c},h=()=>{let c=0;return e.value&&e.value.purchaseInvoiceImports.forEach(o=>c+=o.taxAmount),c};return w({submitForm:u,calcAmounts:I}),(c,o)=>{const f=y("Dropdown"),F=y("Calendar");return R(),H("div",null,[t(e)?(R(),H("form",fe,[n("section",_e,[l(z,{label:"Num. Fra. Intern",id:"number",modelValue:t(e).number,"onUpdate:modelValue":o[0]||(o[0]=r=>t(e).number=r),disabled:""},null,8,["modelValue"]),n("div",null,[he,l(f,{modelValue:t(e).exerciceId,"onUpdate:modelValue":o[1]||(o[1]=r=>t(e).exerciceId=r),editable:"",options:t(g).masterData.exercises,optionValue:"id",optionLabel:"name",class:M(["w-full",{"p-invalid":m.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),n("div",null,[Ae,l(f,{modelValue:t(e).purchaseInvoiceSerieId,"onUpdate:modelValue":o[2]||(o[2]=r=>t(e).purchaseInvoiceSerieId=r),editable:"",options:t(g).masterData.series,optionValue:"id",optionLabel:"name",class:M(["w-full",{"p-invalid":m.value.errors.purchaseInvoiceSerieId}])},null,8,["modelValue","options","class"])]),n("div",null,[xe,l(f,{modelValue:t(e).purchaseInvoiceStatusId,"onUpdate:modelValue":o[3]||(o[3]=r=>t(e).purchaseInvoiceStatusId=r),editable:"",options:t(g).masterData.statuses,optionValue:"id",optionLabel:"name",class:M(["w-full",{"p-invalid":m.value.errors.purchaseInvoiceStatusId}])},null,8,["modelValue","options","class"])])]),n("section",ye,[n("div",Ve,[De,l(f,{modelValue:t(e).supplierId,"onUpdate:modelValue":o[4]||(o[4]=r=>t(e).supplierId=r),editable:"",options:t(g).masterData.suppliers,optionValue:"id",optionLabel:"comercialName",onChange:v,class:M(["w-full",{"p-invalid":m.value.errors.supplierId}])},null,8,["modelValue","options","class"])]),n("div",ge,[l(z,{label:"Num. Fra. Proveïdor",id:"supplierNumber",modelValue:t(e).supplierNumber,"onUpdate:modelValue":o[5]||(o[5]=r=>t(e).supplierNumber=r)},null,8,["modelValue"])]),n("div",we,[Te,l(F,{id:"purchaseInvoiceDate",modelValue:t(e).purchaseInvoiceDate,"onUpdate:modelValue":o[6]||(o[6]=r=>t(e).purchaseInvoiceDate=r),onDateSelect:o[7]||(o[7]=r=>I())},null,8,["modelValue"])]),n("div",Ee,[Fe,l(f,{modelValue:t(e).paymentMethodId,"onUpdate:modelValue":[o[8]||(o[8]=r=>t(e).paymentMethodId=r),o[9]||(o[9]=r=>I())],editable:"",options:t(g).masterData.paymentMethods,optionValue:"id",optionLabel:"name",class:M(["w-full",{"p-invalid":m.value.errors.paymentmethod}])},null,8,["modelValue","options","class"])])]),n("section",Ce,[n("div",Pe,[l(z,{type:t(L).CURRENCY,label:"Ports",id:"transportAmount",modelValue:t(e).transportAmount,"onUpdate:modelValue":[o[10]||(o[10]=r=>t(e).transportAmount=r),o[11]||(o[11]=r=>I())]},null,8,["type","modelValue"])]),n("div",Se,[l(z,{type:t(L).NUMERIC,label:"% IRPF",id:"extraTaxPercentatge",modelValue:t(e).extraTaxPercentatge,"onUpdate:modelValue":[o[12]||(o[12]=r=>t(e).extraTaxPercentatge=r),o[13]||(o[13]=r=>I())]},null,8,["type","modelValue"])]),n("div",ke,[l(z,{type:t(L).NUMERIC,label:"% Dto.",id:"discountPercentage",modelValue:t(e).discountPercentage,"onUpdate:modelValue":[o[14]||(o[14]=r=>t(e).discountPercentage=r),o[15]||(o[15]=r=>I())]},null,8,["type","modelValue"])])]),n("section",Ue,[n("div",Ne,[Re,n("span",Be,k(t(e).baseAmount)+" €",1)]),n("div",Me,[$e,n("span",Le,k(t(e).taxAmount)+" €",1)]),n("div",Ye,[ze,n("span",Ge,k(t(e).netAmount)+" €",1)])])])):G("",!0)])}}});const qe=ue(je,[["__scopeId","data-v-96908432"]]),Oe={key:0},He={class:"two-columns"},Je=n("label",{class:"block text-900 mb-2"},"IVA",-1),Ke={class:"two-columns"},Qe=J({__name:"FormPurchaseInvoiceImport",props:{formAction:{},invoiceImport:{}},emits:["submit"],setup(C,{emit:w}){const p=C,D=K(),g=X(),e=te(()=>p.formAction===x.CREATE?"Afegir":"Modificar"),E=()=>{const a=D.masterData.taxes.find(u=>u.id===p.invoiceImport.taxId);if(a&&q.isNumber(p.invoiceImport.baseAmount)){const u=p.invoiceImport.baseAmount,v=u/100*a.percentatge,I=u+v;p.invoiceImport.baseAmount=u,p.invoiceImport.taxAmount=q.round(v,2),p.invoiceImport.netAmount=q.round(I,2),console.log("netAmount, rounded netAmount",I,q.round(I,2))}},m=se().shape({baseAmount:be().required("L'import base és obligatori").min(1,"L'import base ha de ser un número positiu")}),s=B({result:!1,errors:{}}),V=()=>{const a=new ne(m);s.value=a.validate(p.invoiceImport)},b=async()=>{if(V(),s.value.result)w("submit",p.invoiceImport);else{let a="";Object.entries(s.value.errors).forEach(u=>{a+=`${u[1].map(v=>v)}.   `}),g.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}};return(a,u)=>{const v=y("Dropdown"),I=y("BaseInput"),Y=y("Button");return a.invoiceImport?(R(),H("form",Oe,[n("section",He,[n("div",null,[Je,l(v,{modelValue:a.invoiceImport.taxId,"onUpdate:modelValue":[u[0]||(u[0]=h=>a.invoiceImport.taxId=h),u[1]||(u[1]=h=>E())],editable:"",options:t(D).masterData.taxes,optionValue:"id",optionLabel:"name"},null,8,["modelValue","options"])]),l(I,{class:M(["mb-2",{"p-invalid":s.value.errors.baseAmount}]),label:"Import Base",modelValue:a.invoiceImport.baseAmount,"onUpdate:modelValue":[u[2]||(u[2]=h=>a.invoiceImport.baseAmount=h),u[3]||(u[3]=h=>E())],type:t(L).CURRENCY},null,8,["modelValue","type","class"])]),n("section",Ke,[l(I,{class:"mb-2",label:"Import Impost",modelValue:a.invoiceImport.taxAmount,"onUpdate:modelValue":u[4]||(u[4]=h=>a.invoiceImport.taxAmount=h),type:t(L).CURRENCY,disabled:""},null,8,["modelValue","type"]),l(I,{class:"mb-2",label:"Total",modelValue:a.invoiceImport.netAmount,"onUpdate:modelValue":u[5]||(u[5]=h=>a.invoiceImport.netAmount=h),type:t(L).CURRENCY,disabled:""},null,8,["modelValue","type"])]),l(Y,{label:e.value,onClick:b,style:{float:"right"}},null,8,["label"])])):G("",!0)}}}),We=["onClick"],Xe=J({__name:"TablePurchaseInvoiceImports",props:{purchaseInvoiceImports:{}},emits:["add","edit","delete"],setup(C,{emit:w}){const p=C,D=K(),g=s=>{var b;const V=(b=D.masterData.taxes)==null?void 0:b.find(a=>a.id===s);if(V)return V.percentatge},e=()=>{var b;const s=(b=D.masterData.taxes)==null?void 0:b.find(a=>a.name.includes("21")),V={id:ae(),baseAmount:null,taxId:s?s.id:"",taxAmount:0,netAmount:0,purchaseInvoiceId:""};w("add",V)},E=s=>{s.originalEvent.target.className.includes("grid_delete_column_button")||w("edit",s.data)},m=(s,V)=>{w("delete",V)};return(s,V)=>{const b=y("Button"),a=y("Column"),u=y("DataTable");return R(),O(u,{onRowClick:E,value:p.purchaseInvoiceImports,tableStyle:"min-width: 100%"},{default:_(()=>[l(b,{onClick:e,rounded:"",icon:t(W).PLUS,class:"grid_add_row_button",style:{"margin-right":"1.5rem"}},null,8,["icon"]),l(a,{field:"baseAmount",header:"Base",style:{width:"25%"}},{body:_(v=>[$(k(v.data.baseAmount)+" € ",1)]),_:1}),l(a,{field:"taxId",header:"% IVA",style:{width:"25%"}},{body:_(v=>[$(k(g(v.data.taxId)),1)]),_:1}),l(a,{field:"taxAmount",header:"Cuota IVA",style:{width:"25%"}},{body:_(v=>[$(k(v.data.taxAmount)+" € ",1)]),_:1}),l(a,{field:"netAmount",header:"Total",style:{width:"25%"}},{body:_(v=>[$(k(v.data.netAmount)+" € ",1)]),_:1}),l(a,{style:{width:"10%"}},{body:_(v=>[n("i",{class:M([t(W).TIMES,"grid_delete_column_button"]),onClick:I=>m(I,v.data)},null,10,We)]),_:1})]),_:1},8,["value"])}}}),ct=J({__name:"PurchaseInvoice",setup(C){const w=B(),p=B(x.EDIT),D=de(),g=ce(),e=me(),E=K(),m=oe(),{purchaseInvoice:s}=ee(m),V=te(()=>a.value===x.CREATE?"Introducció import":"Modificació import"),b=B(!1),a=B(x.EDIT),u=B(void 0),v=async()=>{let d="";await m.GetById(D.params.id),s.value?(p.value=x.EDIT,d=`Factura de compra: ${s.value.number}`,s.value.purchaseInvoiceDate=new Date(s.value.purchaseInvoiceDate)):(p.value=x.CREATE,m.setNewPurchaseInvoice(D.params.id),d="Alta de factures de compra",I()),e.setMenuItem({icon:W.POUND,backButtonVisible:!0,title:d})},I=()=>{var d,i,A;if(s.value){const T=(d=E.masterData.exercises)==null?void 0:d.find(N=>N.name===new Date().getFullYear().toString());T&&(s.value.exerciceId=T.id);const P=(i=E.masterData.series)==null?void 0:i.find(N=>N.name==="Nacional");P&&(s.value.purchaseInvoiceSerieId=P.id);const j=(A=E.masterData.statuses)==null?void 0:A.find(N=>N.name==="Nova");j&&(s.value.purchaseInvoiceStatusId=j.id)}};Q(async()=>{await v()});const Y=()=>{w.value.submitForm()},h=(d,i)=>{d===x.CREATE&&(i.id=ae()),i.purchaseInvoiceId=s.value.id,u.value=i,a.value=d,b.value=!0},c=X(),o=async d=>{let i=!1,A="";p.value===x.CREATE?(i=await m.Create(d),A=i?"Factura creada":"Error al crear la factura"):(i=await m.Update(d),A=i?"Factura actualizada":"Error al actualizar la factura"),c.add({life:5e3,severity:i?"success":"error",summary:A}),i&&g.back()},f=async d=>{var i;a.value===x.CREATE?(p.value===x.EDIT&&await m.CreateInvoiceImport(d),(i=s.value)==null||i.purchaseInvoiceImports.push(d)):a.value===x.EDIT&&p.value===x.EDIT&&await m.UpdateInvoiceImport(d),r()},F=async d=>{console.log("deleteInvoiceImport"),p.value===x.EDIT&&await m.DeleteInvoiceImport(d);const i=s.value.purchaseInvoiceImports.filter(A=>A.id!==d.id);s.value.purchaseInvoiceImports=i,r()},r=()=>{w.value.calcAmounts(),b.value=!1};return(d,i)=>{const A=y("Button"),T=y("TabPanel"),P=y("Column"),j=y("DataTable"),N=y("TabView"),le=y("Dialog");return R(),H(pe,null,[l(A,{label:"Guardar",class:"grid_add_row_button",onClick:Y}),l(N,null,{default:_(()=>[t(s)?(R(),O(T,{key:0,header:"Factura"},{default:_(()=>[l(qe,{ref_key:"purchaseInvoiceForm",ref:w,purchaseInvoice:t(s),onSubmit:o},null,8,["purchaseInvoice"]),l(N,null,{default:_(()=>[l(T,{header:"Imports"},{default:_(()=>[l(Xe,{"purchase-invoice-imports":t(s).purchaseInvoiceImports,onAdd:i[0]||(i[0]=S=>h(t(x).CREATE,S)),onEdit:i[1]||(i[1]=S=>h(t(x).EDIT,S)),onDelete:F},null,8,["purchase-invoice-imports"])]),_:1}),l(T,{header:"Venciments"},{default:_(()=>[l(j,{value:t(s).purchaseInvoiceDueDates,tableStyle:"min-width: 100%"},{default:_(()=>[l(P,{field:"dueDate",header:"Venciment",style:{width:"50%"}},{body:_(S=>[$(k(t(ve)(S.data.dueDate)),1)]),_:1}),l(P,{field:"amount",header:"Import",style:{width:"50%"}},{body:_(S=>[$(k(S.data.amount)+" € ",1)]),_:1})]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})):G("",!0),l(T,{header:"Fitxers"},{default:_(()=>[t(s)?(R(),O(Ie,{key:0,title:"Factures",entity:"PurchaseInvoice",id:t(D).params.id},null,8,["id"])):G("",!0)]),_:1})]),_:1}),u.value?(R(),O(le,{key:0,closable:!0,visible:b.value,"onUpdate:visible":i[2]||(i[2]=S=>b.value=S),header:V.value,position:"bottom"},{default:_(()=>[l(Qe,{formAction:a.value,invoiceImport:u.value,onSubmit:f},null,8,["formAction","invoiceImport"])]),_:1},8,["visible","header"])):G("",!0)],64)}}});export{ct as default};

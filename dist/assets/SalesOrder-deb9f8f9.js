import{d as X,j as Y,z as W,H as Z,r as U,h as C,a as O,c as B,k as t,e as n,i as l,n as E,s as L,y as H,l as k,p as pe,b as fe,f as be,w as f,D as V,F as T,m as M,L as ye,C as P,P as ee,v as _e,g as De,u as Oe,o as Ie,G as Se}from"./index-9ee31eec.js";import{c as Ve,f as Q,g as J}from"./functions-afe9fe15.js";import{u as te}from"./order-ed4d5f60.js";import{u as ae}from"./reference-b31f5c29.js";import{u as se}from"./customers-a1aa4021.js";import{u as le}from"./exercise-63354d5d.js";import{u as oe}from"./plantmodel-0c53976d.js";import{u as re}from"./lifecycle-decdfcd8.js";import{u as Ce}from"./tax-553767a1.js";import{c as ie,a as G,F as ne,d as Ne}from"./form-validator-7a510593.js";import{u as de}from"./deliveryNote-901a3a5d.js";import{_ as we}from"./FormReference.vue_vue_type_script_setup_true_lang-b9aed1e7.js";import{F as Te}from"./FileEntityPicker-695a9351.js";import"./v4-a960c1f4.js";import"./index-834c5157.js";import"./base.service-aa9daa2d.js";import"./reference.service-8d98e13b.js";import"./index-e87db629.js";import"./referenceType-6c53caf6.js";import"./file.service-cd856b7f.js";const z=g=>(pe("data-v-f0f650fd"),g=g(),fe(),g),ge={key:0},xe={class:"four-columns"},Ee={class:"mt-1"},ke=z(()=>n("label",{class:"block text-900 mb-2"},"Exercici",-1)),$e={class:"mt-1"},he={class:"mt-1"},Re=z(()=>n("label",{class:"block text-900 mb-2"},"Data Comanda",-1)),Fe={class:"mt-2"},Ue=z(()=>n("label",{class:"block text-900 mb-2"},"Estat",-1)),Be={class:"four-columns"},Ae={class:"mt-2"},Le=z(()=>n("label",{class:"block text-900 mb-2"},"Origen",-1)),qe={class:"mt-2"},Me=z(()=>n("label",{class:"block text-900 mb-2"},"Client",-1)),ze={class:"mt-2"},je={class:"mt-2"},Ge=X({__name:"FormSalesOrder",emits:["submit","cancel"],setup(g,{expose:x,emit:c}){const $=te(),h=se(),_=oe(),b=le(),y=re(),R=de(),m=Y(),{salesOrder:e}=W($),I=Z(()=>R.deliveryNote?R.deliveryNote.number:""),a=ie().shape({siteId:G().required("L'origen es obligatori"),customerId:G().required("El client es obligatori"),statusId:G().required("L'estat es obligatori"),exerciseId:G().required("L'exercici es obligatori")}),o=U({result:!1,errors:{}}),u=()=>{const i=new ne(a);o.value=i.validate(e.value)};x({submitForm:async()=>{if(u(),o.value.result)e.value.salesOrderDate=Ve(e.value.salesOrderDate),c("submit",e.value);else{let i="";Object.entries(o.value.errors).forEach(s=>{i+=`${s[1].map(D=>D)}.   `}),m.add({severity:"warn",summary:"Formulari inválid",detail:i,life:5e3})}}});const F=()=>{var s;const i=(s=h.customers)==null?void 0:s.find(D=>{var w;return D.id===((w=e.value)==null?void 0:w.customerId)});i&&e.value&&(e.value.customerCode=i.code,e.value.customerComercialName=i.comercialName,e.value.customerTaxName=i.taxName,e.value.customerVatNumber=i.vatNumber,e.value.customerAccountNumber=i.accountNumber),console.log(e.value)},r=()=>{var s;const i=(s=_.sites)==null?void 0:s.find(D=>{var w;return D.id===((w=e.value)==null?void 0:w.siteId)});i&&e.value&&(e.value.name=i.name,e.value.address=i.address,e.value.city=i.city,e.value.postalCode=i.postalCode,e.value.region=i.region,e.value.country=i.country,e.value.vatNumber=i.vatNumber)};return(i,s)=>{var q;const D=C("Dropdown"),w=C("Calendar");return O(),B("div",null,[t(e)?(O(),B("form",ge,[n("section",xe,[n("div",Ee,[ke,l(D,{modelValue:t(e).exerciseId,"onUpdate:modelValue":s[0]||(s[0]=v=>t(e).exerciseId=v),editable:"",options:t(b).exercises,optionValue:"id",optionLabel:"name",class:E(["w-full",{"p-invalid":o.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),n("div",$e,[l(H,{type:t(L).TEXT,label:"Num. Comanda",id:"salesOrderNumber",modelValue:t(e).salesOrderNumber,"onUpdate:modelValue":s[1]||(s[1]=v=>t(e).salesOrderNumber=v),disabled:""},null,8,["type","modelValue"])]),n("div",he,[Re,l(w,{modelValue:t(e).salesOrderDate,"onUpdate:modelValue":s[2]||(s[2]=v=>t(e).salesOrderDate=v),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),n("div",Fe,[Ue,l(D,{modelValue:t(e).statusId,"onUpdate:modelValue":s[3]||(s[3]=v=>t(e).statusId=v),editable:"",options:(q=t(y).lifecycle)==null?void 0:q.statuses,optionValue:"id",optionLabel:"name",class:E(["w-full",{"p-invalid":o.value.errors.statusId}])},null,8,["modelValue","options","class"])])]),n("section",Be,[n("div",Ae,[Le,l(D,{modelValue:t(e).siteId,"onUpdate:modelValue":[s[4]||(s[4]=v=>t(e).siteId=v),s[5]||(s[5]=v=>r())],editable:"",options:t(_).sites,optionValue:"id",optionLabel:"name",class:E(["w-full",{"p-invalid":o.value.errors.siteId}])},null,8,["modelValue","options","class"])]),n("div",qe,[Me,l(D,{modelValue:t(e).customerId,"onUpdate:modelValue":[s[6]||(s[6]=v=>t(e).customerId=v),s[7]||(s[7]=v=>F())],editable:"",options:t(h).customers,optionValue:"id",optionLabel:"comercialName",class:E(["w-full",{"p-invalid":o.value.errors.customerId}])},null,8,["modelValue","options","class"])]),n("div",ze,[l(H,{type:t(L).TEXT,label:"Comanda Client",id:"customerSalesOrderNumber",modelValue:t(e).customerSalesOrderNumber,"onUpdate:modelValue":s[8]||(s[8]=v=>t(e).customerSalesOrderNumber=v)},null,8,["type","modelValue"])]),n("div",je,[l(H,{type:t(L).TEXT,disabled:!0,label:"Albarà Entrega",id:"deliveryNote",modelValue:I.value,"onUpdate:modelValue":s[9]||(s[9]=v=>I.value=v)},null,8,["type","modelValue"])])])])):k("",!0)])}}});const Xe=be(Ge,[["__scopeId","data-v-f0f650fd"]]),He={key:0},Pe={class:"mb-2"},Qe=n("label",{class:"block text-900 mb-2"},"Referència",-1),Je={key:0,class:"flex align-items-center"},Ye={key:0,class:"flex align-items-center"},Ke={class:"two-columns"},We=X({__name:"FormSalesOrderDetail",props:{formAction:{},salesOrderDetail:{}},emits:["submit"],setup(g,{emit:x}){const c=g,$=ae(),h=Y(),_=Z(()=>c.formAction===T.CREATE?"Afegir":"Modificar"),b=()=>{const a=$.references.find(o=>o.id===c.salesOrderDetail.referenceId);a&&(c.salesOrderDetail.description=`${a.code} (${a.version}) - ${a.description}`,c.salesOrderDetail.isInvoiced=!1,c.salesOrderDetail.isDelivered=!1,c.salesOrderDetail.unitCost=a==null?void 0:a.cost,c.salesOrderDetail.unitPrice=a==null?void 0:a.price,y())},y=()=>{c.salesOrderDetail.amount=c.salesOrderDetail.unitPrice*c.salesOrderDetail.quantity,c.salesOrderDetail.totalCost=c.salesOrderDetail.unitCost*c.salesOrderDetail.quantity},R=ie().shape({quantity:Ne().required("La quantitat és obligatoria").min(1,"La quantitat ha de ser un número positiu")}),m=U({result:!1,errors:{}}),e=()=>{const a=new ne(R);m.value=a.validate(c.salesOrderDetail)},I=async()=>{if(e(),m.value.result)x("submit",c.salesOrderDetail);else{let a="";Object.entries(m.value.errors).forEach(o=>{a+=`${o[1].map(u=>u)}.   `}),h.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}};return(a,o)=>{const u=C("Dropdown"),N=C("BaseInput"),F=C("Button");return a.salesOrderDetail?(O(),B("form",He,[n("div",Pe,[Qe,l(u,{modelValue:a.salesOrderDetail.referenceId,"onUpdate:modelValue":[o[0]||(o[0]=r=>a.salesOrderDetail.referenceId=r),o[1]||(o[1]=r=>b())],editable:"",options:t($).references,optionValue:"id",optionLabel:"description",class:E(["w-full",{"p-invalid":m.value.errors.referenceId}])},{value:f(r=>[r.value?(O(),B("div",Je,V(r.value.code)+" ("+V(r.value.version)+") - "+V(r.value.description),1)):k("",!0)]),option:f(r=>[r.option?(O(),B("div",Ye,V(r.option.code)+" ("+V(r.option.version)+") - "+V(r.option.description),1)):k("",!0)]),_:1},8,["modelValue","options","class"])]),n("section",Ke,[n("div",null,[l(N,{class:E(["mb-2",{"p-invalid":m.value.errors.quantity}]),label:"Quantitat",modelValue:a.salesOrderDetail.quantity,"onUpdate:modelValue":[o[2]||(o[2]=r=>a.salesOrderDetail.quantity=r),o[3]||(o[3]=r=>y())],type:t(L).NUMERIC},null,8,["modelValue","type","class"])]),n("div",null,[l(N,{class:E(["mb-2",{"p-invalid":m.value.errors.amount}]),label:"Total",modelValue:a.salesOrderDetail.amount,"onUpdate:modelValue":o[4]||(o[4]=r=>a.salesOrderDetail.amount=r),type:t(L).CURRENCY,disabled:""},null,8,["modelValue","type","class"])])]),n("section",null,[n("div",null,[l(N,{class:E(["mb-2",{"p-invalid":m.value.errors.description}]),label:"Descripció línea",modelValue:a.salesOrderDetail.description,"onUpdate:modelValue":o[5]||(o[5]=r=>a.salesOrderDetail.description=r),type:t(L).TEXT},null,8,["modelValue","type","class"])])]),l(F,{label:_.value,onClick:I,style:{float:"right"}},null,8,["label"])])):k("",!0)}}}),Ze=["onClick"],et=X({__name:"TableSalesOrderDetails",props:{salesOrderDetails:{}},emits:["edit","delete"],setup(g,{emit:x}){const c=g,$=_=>{_.originalEvent.target.className.includes("grid_delete_column_button")||x("edit",_.data)},h=(_,b)=>{x("delete",b)};return(_,b)=>{const y=C("Column"),R=C("DataTable");return O(),M(R,{onRowClick:$,value:c.salesOrderDetails,tableStyle:"min-width: 100%",class:"p-datatable-sm"},{header:f(()=>[ye(_.$slots,"header")]),default:f(()=>[l(y,{field:"quantity",header:"Quantitat",style:{width:"10%"}}),l(y,{header:"Referencia",style:{width:"25%"}},{body:f(m=>[P(V(m.data.reference.code)+" ("+V(m.data.reference.version)+") - "+V(m.data.reference.description),1)]),_:1}),l(y,{field:"description",header:"Descripció",style:{width:"25%"}}),l(y,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:f(m=>[P(V(m.data.unitPrice)+" € ",1)]),_:1}),l(y,{field:"amount",header:"Total",style:{width:"10%"}},{body:f(m=>[P(V(m.data.amount)+" € ",1)]),_:1}),l(y,{style:{width:"10%"}},{body:f(m=>[m.data.isDelivered?k("",!0):(O(),B("i",{key:0,class:E([t(ee).TIMES,"grid_delete_column_button"]),onClick:e=>h(e,m.data)},null,10,Ze))]),_:1})]),_:3},8,["value"])}}}),tt={class:"flex flex-wrap align-items-center justify-content-between gap-2"},at=n("span",{class:"text-l text-900 font-bold"},"Linies de la comanda",-1),st="Línia de comanda",Ct=X({__name:"SalesOrder",setup(g){const x=U(),c=U(T.EDIT),$=_e(),h=De(),_=Oe(),b=te(),y=se(),R=oe(),m=le(),e=re(),I=ae(),a=de(),o=Ce(),{salesOrder:u}=W(b),N=U(!1),F=U(T.EDIT),r=U(void 0),i=U(0),s=async()=>{await b.GetById($.params.id),I.fetchReferencesByModule("sales"),e.fetchOneByName("SalesOrder"),R.fetchSites(),m.fetchAll(),y.fetchCustomers(),o.fetchAll();let p="";u.value&&(c.value=T.EDIT,p=`Comanda ${u.value.salesOrderNumber}`,u.value.salesOrderDate=Q(u.value.salesOrderDate),u.value.deliveryNoteId?a.GetById(u.value.deliveryNoteId):a.deliveryNote&&(a.deliveryNote=void 0)),_.setMenuItem({icon:ee.BUILDING,backButtonVisible:!0,title:p})};Ie(async()=>{await s()});const D=()=>{x.value.submitForm()},w=(p,d)=>{p===T.CREATE&&(d={id:J(),referenceId:"",quantity:0,unitCost:0,unitPrice:0,totalCost:0,amount:0,salesOrderHeaderId:"",description:"",estimatedDeliveryDate:new Date,isDelivered:!1,isInvoiced:!1},I.setNewReference(J())),d.salesOrderHeaderId=u.value.id,r.value=d,F.value=p,N.value=!0},q=Y(),v=async p=>{let d=!1,S="";d=await b.Update(p.id,p),S=d?"Comanda actualitzada":"Error a l'actualitzar la comanda",q.add({life:5e3,severity:d?"success":"error",summary:S}),d&&h.back()},ue=async p=>{F.value===T.CREATE?await b.CreateDetail(p):F.value===T.EDIT&&await b.UpdateDetail(p),N.value=!1,u.value.salesOrderDate=Q(u.value.salesOrderDate)},ce=async p=>{c.value===T.EDIT&&await b.DeleteDetail(p);const d=u.value.salesOrderDetails.filter(S=>S.id!==p.id);u.value.salesOrderDetails=d,N.value=!1,u.value.salesOrderDate=Q(u.value.salesOrderDate)},me=async p=>{let d=!1,S="";d=await I.createReference(p),d?S="Referència creada correctament":S="La referència + versió introduïda ja existeix",q.add({severity:d?"success":"warn",summary:S,life:5e3}),d&&(I.setNewReference(J()),i.value=0)};return(p,d)=>{const S=C("Button"),j=C("TabPanel"),K=C("TabView"),ve=C("Dialog");return O(),B(Se,null,[l(S,{label:"Guardar",class:"grid_add_row_button",size:"small",onClick:D}),l(Xe,{class:"mt-3 mb-3",ref_key:"salesOrderForm",ref:x,salesOrder:"salesOrder",onSubmit:v},null,512),l(K,null,{default:f(()=>[l(j,{header:"Detall"},{default:f(()=>[t(u)?(O(),M(et,{key:0,salesOrderDetails:t(u).salesOrderDetails,onEdit:d[1]||(d[1]=A=>w(t(T).EDIT,A)),onDelete:ce},{header:f(()=>[n("div",tt,[at,n("div",null,[l(S,{disabled:t(a).deliveryNote!==void 0,size:"small",label:"Afegir línea",onClick:d[0]||(d[0]=A=>w(t(T).CREATE,{}))},null,8,["disabled"])])])]),_:1},8,["salesOrderDetails"])):k("",!0)]),_:1}),l(j,{header:"Fitxers"},{default:f(()=>[t(u)?(O(),M(Te,{key:0,entity:"SalesOrder",id:t(u).id,title:""},null,8,["id"])):k("",!0)]),_:1})]),_:1}),l(ve,{closable:!0,visible:N.value,"onUpdate:visible":d[3]||(d[3]=A=>N.value=A),header:st,modal:!0},{default:f(()=>[l(K,{activeIndex:i.value,"onUpdate:activeIndex":d[2]||(d[2]=A=>i.value=A)},{default:f(()=>[l(j,{header:"Línea"},{default:f(()=>[r.value?(O(),M(We,{key:0,formAction:F.value,salesOrderDetail:r.value,onSubmit:ue},null,8,["formAction","salesOrderDetail"])):k("",!0)]),_:1}),l(j,{header:"Referencia"},{default:f(()=>[t(I).reference?(O(),M(we,{key:0,module:"sales",reference:t(I).reference,onSubmit:me},null,8,["reference"])):k("",!0)]),_:1})]),_:1},8,["activeIndex"])]),_:1},8,["visible"])],64)}}});export{Ct as default};

import{_ as ie}from"./ExerciseDatePicker.vue_vue_type_script_setup_true_lang-8487d95d.js";import{d as K,j as X,r as U,h as I,a as j,c as H,e as r,i as l,k as u,n as Q,s as z,y as G,l as Z,g as ne,u as de,x as ue,E as ce,o as pe,P as S,H as x,w as v,G as me,C as b,D as h}from"./index-24f08e74.js";import{a as Y,h as fe,_ as ve,g as we}from"./functions-2e154ea4.js";import{u as ke}from"./exercise-f64c6941.js";import{u as he}from"./productionpart-7cf70ac3.js";import{u as ee}from"./plantmodel-0148afc8.js";import{u as te}from"./workorder-9a7a3058.js";import{c as be,a as F,d as J,F as Ie}from"./form-validator-f8953ae6.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./index-7ee43446.js";import"./base.service-492ead1b.js";import"./reference.service-6a1ff264.js";import"./index-ea6ec1c8.js";const ye={key:0},Pe={class:"three-columns mt-2"},Ce=r("label",{class:"block text-900 mb-2"},"Operari",-1),_e=r("label",{class:"block text-900 mb-2"},"Màquina",-1),Oe=r("label",{class:"block text-900 mb-2"},"Data Tíquet",-1),ge={class:"mt-2"},Ve=r("label",{class:"block text-900 mb-2"},"Ordre Fabricació | Fase | Activitat",-1),De={class:"two-columns mt-2"},qe=r("br",null,null,-1),Se={class:"flex-right"},xe=K({__name:"FormProductionPart",props:{productionPart:{},avoidWorkOrderRefresh:{type:Boolean}},emits:["submit","cancel"],setup(A,{emit:W}){const d=A,T=X(),w=ee(),_=te(),i=U(void 0),V=()=>{i.value.value&&(d.productionPart.workOrderId=i.value.value.workOrderId,d.productionPart.workOrderPhaseId=i.value.value.workOrderPhaseId,d.productionPart.workOrderPhaseDetailId=i.value.value.workOrderPhaseDetailId)},M=be().shape({operatorId:F().required("Escull un operari"),workcenterId:F().required("Escull una màquina"),workOrderId:F().required("Escull una ordre de fabricació"),workOrderPhaseId:F().required("Escull una fase"),workOrderPhaseDetailId:F().required("Escull una activitat"),quantity:J().required("Has d'introduir una quantitat entera (pot ser 0)").integer(),time:J().required("Has d'introduir el temps i ha de ser major que 0").moreThan(0)}),y=U({result:!1,errors:{}}),c=()=>{const a=new Ie(M);y.value=a.validate(d.productionPart)},O=async a=>{d.avoidWorkOrderRefresh||(i.value=void 0,await _.fetchByWorkcenterId(a))},N=async()=>{if(c(),y.value.result)W("submit",d.productionPart);else{let a="";Object.entries(y.value.errors).forEach(s=>{a+=`${s[1].map(P=>P)}.   `}),T.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}};return(a,s)=>{var D,g,E;const P=I("Dropdown"),L=I("Calendar"),$=I("Button");return a.productionPart?(j(),H("form",ye,[r("section",Pe,[r("div",null,[Ce,l(P,{modelValue:a.productionPart.operatorId,"onUpdate:modelValue":s[0]||(s[0]=o=>a.productionPart.operatorId=o),editable:"",filter:!0,options:(D=u(w).operators)==null?void 0:D.sort((o,C)=>o.surname.localeCompare(C.surname)).map(o=>({value:o.id,label:o.name+" "+o.surname})),optionValue:"value",optionLabel:"label",class:Q(["w-full",{"p-invalid":y.value.errors.operatorid}])},null,8,["modelValue","options","class"])]),r("div",null,[_e,l(P,{modelValue:a.productionPart.workcenterId,"onUpdate:modelValue":s[1]||(s[1]=o=>a.productionPart.workcenterId=o),editable:"",filter:!0,options:(g=u(w).workcenters)==null?void 0:g.sort((o,C)=>o.description.localeCompare(C.description)),optionValue:"id",optionLabel:"description",class:"w-full",onChange:s[2]||(s[2]=o=>O(a.productionPart.workcenterId))},null,8,["modelValue","options"])]),r("div",null,[Oe,l(L,{modelValue:a.productionPart.date,"onUpdate:modelValue":s[3]||(s[3]=o=>a.productionPart.date=o),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),r("section",ge,[r("div",null,[Ve,l(P,{modelValue:i.value,"onUpdate:modelValue":s[4]||(s[4]=o=>i.value=o),editable:"",filter:!0,options:(E=u(_).detailedWorkOrders)==null?void 0:E.sort((o,C)=>o.workOrderCode.localeCompare(C.workOrderCode)).map(o=>({label:o.workOrderCode+"  ("+o.referenceDescription+") - "+o.workOrderPhaseCode+"  ("+o.workOrderPhaseDescription+") | "+o.machineStatusDescription,value:o})),optionLabel:"label",class:Q(["w-full",{"p-invalid":y.value.errors.workOrderId}]),onChange:V},null,8,["modelValue","options","class"])])]),r("section",De,[r("div",null,[l(G,{type:u(z).NUMERIC,label:"Quantitat",id:"quantity",modelValue:a.productionPart.quantity,"onUpdate:modelValue":s[5]||(s[5]=o=>a.productionPart.quantity=o)},null,8,["type","modelValue"])]),r("div",null,[l(G,{type:u(z).NUMERIC,label:"Temps total (minuts)",id:"time",modelValue:a.productionPart.time,"onUpdate:modelValue":s[6]||(s[6]=o=>a.productionPart.time=o)},null,8,["type","modelValue"])])]),qe,r("div",Se,[l($,{label:"Guardar",size:"small",onClick:N})])])):Z("",!0)}}}),Fe={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Te={class:"datatable-filter-5"},$e={class:"filter-field"},Ee={class:"filter-field"},Be=r("label",null,"Operari",-1),Ue={class:"filter-field"},We=r("label",null,"Màquina",-1),Me={class:"filter-field"},Ne=r("label",null,"OF",-1),Le=["onClick"],Re={key:0,class:"flex-right"},je=r("br",null,null,-1),at=K({__name:"ProductionParts",setup(A){const W=ne(),d=de(),T=X(),w=he(),_=ke(),i=ee(),V=te(),M=ue(),y=()=>{var p;const e=new Date().getFullYear().toString(),t=(p=_.exercises)==null?void 0:p.find(m=>m.name===e);t&&(d.exercisePicker.exercise=t,d.exercisePicker.dates=[new Date(d.exercisePicker.exercise.startDate),new Date(d.exercisePicker.exercise.endDate)])},c=U({operatorId:"",workcenterId:"",workorderId:""}),O=async()=>{if(d.exercisePicker.dates){const e=Y(d.exercisePicker.dates[0]),t=Y(d.exercisePicker.dates[1]);await w.fetchFiltered(e,t,c.value.workcenterId,c.value.operatorId,c.value.workorderId),await V.fetchFiltered(e,t)}else T.add({severity:"info",summary:"Filtre invàlid",detail:"Seleccioni un període",life:5e3})},N=()=>{d.cleanExercisePicker(),c.value.workcenterId="",c.value.operatorId=""},a=ce({visible:!1,title:"Crear tíquet de producció",closable:!0,position:"center",modal:!0});pe(async()=>{d.setMenuItem({icon:S.CLOUD,title:"Tíquets de producció"}),i.fetchWorkcenters(),i.fetchOperators(),i.fetchOperatorTypes(),i.fetchMachineStatuses(),await i.fetchWorkcenterCosts(),await _.fetchActive(),y(),O(),V.detailedWorkOrders=void 0});const s=x(()=>{if(w.productionParts)return w.productionParts.map(e=>({...e,personalCost:oe(e),workcenterCost:C(e)}))}),P=x(()=>{if(w.productionParts)return w.productionParts.reduce((e,t)=>e+t.time,0)}),L=x(()=>{if(w.productionParts)return w.productionParts.reduce((e,t)=>e+t.quantity,0)}),$=x(()=>{if(s.value&&s.value.length>0)return s.value.reduce((e,t)=>e+(t.personalCost?t.personalCost:0),0)}),D=x(()=>{if(s.value&&s.value.length>0)return s.value.reduce((e,t)=>e+(t.workcenterCost?t.workcenterCost:0),0)}),g=U({}),E=()=>({id:we(),operatorId:"",workcenterId:"",workOrderId:"",workOrderPhaseId:"",workOrderPhaseDetailId:"",time:0,quantity:0,date:new Date}),o=e=>{if(e.workOrder&&e.workOrderPhase&&e.workOrderPhaseDetail){const t=i.getMachineStatusNameById(e.workOrderPhaseDetail.machineStatusId);return`${e.workOrder.code} - ${e.workOrderPhase.code} (${e.workOrderPhase.description}) - ${t}`}},C=e=>{var p;if(!e.workOrderPhaseDetail)return 0;console.log(e);let t=(p=i.workcentercosts)==null?void 0:p.find(m=>m.workcenterId===e.workcenterId&&m.machineStatusId===e.workOrderPhaseDetail.machineStatusId);if(t){const m=t.cost*e.time/60;return ve.round(m,2)}return 0},oe=e=>{var m,k;let t=(m=i.operators)==null?void 0:m.find(q=>q.id===e.operatorId),p=(k=i.operatorTypes)==null?void 0:k.find(q=>q.id===(t==null?void 0:t.operatorTypeId));return p?p.cost*e.time/60:0},re=()=>{g.value=E(),a.visible=!0},ae=async()=>{a.visible=!1,await w.create(g.value)&&(W.push({path:"/productionpart"}),O())},se=(e,t)=>{M.require({target:e.currentTarget,message:"Està segur que vol eliminar el tíquet de producció?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{await w.delete(t.id)&&(T.add({severity:"success",summary:"Eliminat",life:3e3}),await O())}})};return(e,t)=>{const p=I("Dropdown"),m=I("Button"),k=I("Column"),q=I("DataTable"),le=I("Dialog");return j(),H(me,null,[l(q,{value:s.value,class:"p-datatable-sm small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"80vh","sort-order":1,"sort-field":"date",paginator:"",rows:25},{header:v(()=>{var n,B;return[r("div",Fe,[r("div",Te,[r("div",$e,[l(ie,{exercises:u(_).exercises},null,8,["exercises"])]),r("div",Ee,[Be,l(p,{modelValue:c.value.operatorId,"onUpdate:modelValue":t[0]||(t[0]=f=>c.value.operatorId=f),editable:"",filter:!0,options:(n=u(i).operators)==null?void 0:n.sort((f,R)=>f.surname.localeCompare(R.surname)).map(f=>({value:f.id,label:f.surname+", "+f.name})),optionValue:"value",optionLabel:"label",class:"w-full"},null,8,["modelValue","options"])]),r("div",Ue,[We,l(p,{modelValue:c.value.workcenterId,"onUpdate:modelValue":t[1]||(t[1]=f=>c.value.workcenterId=f),editable:"",filter:!0,options:(B=u(i).workcenters)==null?void 0:B.sort((f,R)=>f.description.localeCompare(R.description)),optionValue:"id",optionLabel:"description",class:"w-full"},null,8,["modelValue","options"])]),r("div",Me,[Ne,l(p,{modelValue:c.value.workorderId,"onUpdate:modelValue":t[2]||(t[2]=f=>c.value.workorderId=f),editable:"",filter:!0,options:u(V).workorders,optionValue:"id",optionLabel:"code",class:"w-full"},null,8,["modelValue","options"])]),r("div",null,[l(m,{class:"datatable-button mr-2",icon:u(S).FILTER,rounded:"",raised:"",onClick:O},null,8,["icon"]),l(m,{class:"datatable-button mr-2",icon:u(S).FILTER_SLASH,rounded:"",raised:"",onClick:N},null,8,["icon"]),l(m,{icon:u(S).PLUS,rounded:"",raised:"",onClick:re},null,8,["icon"])])])])]}),empty:v(()=>[b(" No s'han trobat tiquets. ")]),loading:v(()=>[b(" Carregant tiquets. Si us plau espera. ")]),footer:v(()=>[s.value&&s.value.length>0?(j(),H("div",Re,[r("span",null,[b(" Temps: "+h(P.value)+" minuts / Quantitat: "+h(L.value)+" unitats ",1),je,b(" Cost operari: "+h($.value.toFixed(2))+" € / Cost màquina: "+h(D.value.toFixed(2))+" € = "+h(($.value+D.value).toFixed(2))+" € ",1)])])):Z("",!0)]),default:v(()=>[l(k,{field:"operatorId",header:"Operari",style:{width:"15%"}},{body:v(n=>[b(h(u(i).getOperatorNameById(n.data.operatorId)),1)]),_:1}),l(k,{field:"workcenterId",header:"Màquina",style:{width:"15%"}},{body:v(n=>[b(h(u(i).getWorkcenterNameById(n.data.workcenterId)),1)]),_:1}),l(k,{field:"workOrderId",header:"OF",style:{width:"20%"}},{body:v(n=>[b(h(o(n.data)),1)]),_:1}),l(k,{field:"date",header:"Data",style:{width:"15%"},sortable:""},{body:v(n=>[b(h(u(fe)(n.data.date)),1)]),_:1}),l(k,{field:"quantity",header:"Quantitat",style:{width:"5%"}}),l(k,{field:"time",header:"Temps (min)",style:{width:"10%"}}),l(k,{header:"Cost Operari",style:{width:"10%"},field:"personalCost"},{body:v(n=>[b(h(n.data.personalCost)+" € ",1)]),_:1}),l(k,{header:"Cost Màquina",style:{width:"10%"},field:"workcenterCost"},{body:v(n=>[b(h(n.data.workcenterCost)+" € ",1)]),_:1}),l(k,{style:{width:"5%"}},{body:v(n=>[r("i",{class:Q([u(S).TIMES,"grid_delete_column_button"]),onClick:B=>se(B,n.data)},null,10,Le)]),_:1})]),_:1},8,["value"]),l(le,{visible:a.visible,"onUpdate:visible":t[3]||(t[3]=n=>a.visible=n),header:a.title,closable:a.closable,modal:a.modal},{default:v(()=>[l(xe,{productionPart:g.value,"avoid-work-order-refresh":!1,onSubmit:ae},null,8,["productionPart"])]),_:1},8,["visible","header","closable","modal"])],64)}}});export{at as default};

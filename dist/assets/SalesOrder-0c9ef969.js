import{d as z,j as J,z as ae,H as re,r as V,h as I,a as y,c as E,k as t,e as c,i as o,s as x,y as W,n as A,l as B,p as ke,b as Ne,f as Ve,F as T,N as he,m as L,O as P,X as Te,K as se,D as j,x as Ee,w as b,C as H,P as M,G as le,v as Re,g as Be,u as $e,o as Fe}from"./index-30e64f83.js";import{c as xe,b as Ae,f as Q,g as K}from"./functions-20418450.js";import{u as oe}from"./order-69e375a2.js";import{u as Y}from"./reference-e2691777.js";import{u as ie}from"./customers-a131b859.js";import{u as ne}from"./exercise-da493b80.js";import{u as de}from"./plantmodel-23537ae7.js";import{u as ue}from"./lifecycle-a073a0e9.js";import{u as Ue}from"./tax-0865666b.js";import{c as ce,a as G,F as me,d as qe}from"./form-validator-497b2185.js";import{u as pe}from"./deliveryNote-f916e450.js";import{_ as Le}from"./DropdownReference.vue_vue_type_script_setup_true_lang-1c10b529.js";import{_ as Me}from"./FormCreateWorkorder.vue_vue_type_script_setup_true_lang-5d249785.js";import{u as ve}from"./workmaster-3ee45dce.js";import{u as fe}from"./workorder-5d8379d3.js";import{_ as We}from"./FormReference.vue_vue_type_script_setup_true_lang-2a29283b.js";import{F as Pe}from"./FileEntityPicker-5dcb6e3b.js";import{a as Ge,b as je}from"./report.service-f16a5ceb.js";import{S as ze}from"./index-3944e9b8.js";import"./v4-a960c1f4.js";import"./reference.service-385b31b8.js";import"./base.service-3e1c705c.js";import"./index-cb69ecf9.js";import"./index-b8eb6b9a.js";import"./referenceType-bb211f04.js";import"./file.service-9c85962b.js";import"./index-72524922.js";const X=p=>(ke("data-v-869804a6"),p=p(),Ne(),p),Xe={key:0},He={class:"four-columns mt-2"},Qe=X(()=>c("label",{class:"block text-900 mb-2"},"Exercici",-1)),Ke=X(()=>c("label",{class:"block text-900 mb-2"},"Data Comanda",-1)),Je={class:"four-columns mt-2"},Ye=X(()=>c("label",{class:"block text-900 mb-2"},"Estat",-1)),Ze=X(()=>c("label",{class:"block text-900 mb-2"},"Client",-1)),et=z({__name:"FormSalesOrder",emits:["submit","cancel"],setup(p,{expose:O,emit:n}){const D=oe(),v=ie();de();const h=ne(),w=ue(),f=pe(),g=J(),{salesOrder:a}=ae(D),_=re(()=>f.deliveryNote?f.deliveryNote.number:""),$=ce().shape({siteId:G().required("L'origen es obligatori"),customerId:G().required("El client es obligatori"),statusId:G().required("L'estat es obligatori"),exerciseId:G().required("L'exercici es obligatori")}),r=V({result:!1,errors:{}}),d=()=>{const i=new me($);r.value=i.validate(a.value)};O({submitForm:async()=>{if(d(),r.value.result)a.value.salesOrderDate=xe(a.value.salesOrderDate),n("submit",a.value);else{let i="";Object.entries(r.value.errors).forEach(e=>{i+=`${e[1].map(N=>N)}.   `}),g.add({severity:"warn",summary:"Formulari inválid",detail:i,life:5e3})}}});const m=()=>{var e;const i=(e=v.customers)==null?void 0:e.find(N=>{var C;return N.id===((C=a.value)==null?void 0:C.customerId)});i&&a.value&&(a.value.customerCode=i.code,a.value.customerComercialName=i.comercialName,a.value.customerTaxName=i.taxName,a.value.customerVatNumber=i.vatNumber,a.value.customerAccountNumber=i.accountNumber),console.log(a.value)};return(i,e)=>{var R;const N=I("Dropdown"),C=I("Calendar");return y(),E("div",null,[t(a)?(y(),E("form",Xe,[c("section",He,[c("div",null,[o(W,{type:t(x).TEXT,label:"Num. Comanda",id:"salesOrderNumber",modelValue:t(a).salesOrderNumber,"onUpdate:modelValue":e[0]||(e[0]=s=>t(a).salesOrderNumber=s),disabled:""},null,8,["type","modelValue"])]),c("div",null,[o(W,{type:t(x).TEXT,label:"Num. Pressupost",id:"budgetNumber",modelValue:t(a).budgetNumber,"onUpdate:modelValue":e[1]||(e[1]=s=>t(a).budgetNumber=s),disabled:""},null,8,["type","modelValue"])]),c("div",null,[Qe,o(N,{modelValue:t(a).exerciseId,"onUpdate:modelValue":e[2]||(e[2]=s=>t(a).exerciseId=s),editable:"",options:t(h).exercises,optionValue:"id",optionLabel:"name",class:A(["w-full",{"p-invalid":r.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),c("div",null,[Ke,o(C,{modelValue:t(a).salesOrderDate,"onUpdate:modelValue":e[3]||(e[3]=s=>t(a).salesOrderDate=s),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),c("section",Je,[c("div",null,[Ye,o(N,{modelValue:t(a).statusId,"onUpdate:modelValue":e[4]||(e[4]=s=>t(a).statusId=s),editable:"",options:(R=t(w).lifecycle)==null?void 0:R.statuses,optionValue:"id",optionLabel:"name",class:A(["w-full",{"p-invalid":r.value.errors.statusId}])},null,8,["modelValue","options","class"])]),c("div",null,[Ze,o(N,{modelValue:t(a).customerId,"onUpdate:modelValue":[e[5]||(e[5]=s=>t(a).customerId=s),e[6]||(e[6]=s=>m())],editable:"",options:t(v).customers,optionValue:"id",optionLabel:"comercialName",class:A(["w-full",{"p-invalid":r.value.errors.customerId}])},null,8,["modelValue","options","class"])]),c("div",null,[o(W,{type:t(x).TEXT,label:"Comanda Client",id:"customerSalesOrderNumber",modelValue:t(a).customerSalesOrderNumber,"onUpdate:modelValue":e[7]||(e[7]=s=>t(a).customerSalesOrderNumber=s)},null,8,["type","modelValue"])]),c("div",null,[o(W,{type:t(x).TEXT,disabled:!0,label:"Albarà Entrega",id:"deliveryNote",modelValue:_.value,"onUpdate:modelValue":e[8]||(e[8]=s=>_.value=s)},null,8,["type","modelValue"])])])])):B("",!0)])}}});const tt=Ve(et,[["__scopeId","data-v-869804a6"]]),at={key:0},rt={class:"mb-2"},st={class:"two-columns"},lt=z({__name:"FormSalesOrderDetail",props:{formAction:{},salesOrderDetail:{}},emits:["submit"],setup(p,{emit:O}){const n=p,D=Y(),v=J(),h=re(()=>n.formAction===T.CREATE?"Afegir":"Modificar"),w=()=>{const r=D.references.find(d=>d.id===n.salesOrderDetail.referenceId);r&&(n.salesOrderDetail.description=r.description,n.salesOrderDetail.isInvoiced=!1,n.salesOrderDetail.isDelivered=!1,n.salesOrderDetail.unitCost=r==null?void 0:r.cost,n.salesOrderDetail.unitPrice=r==null?void 0:r.price,f())},f=()=>{n.salesOrderDetail.amount=n.salesOrderDetail.unitPrice*n.salesOrderDetail.quantity,n.salesOrderDetail.totalCost=n.salesOrderDetail.unitCost*n.salesOrderDetail.quantity},g=ce().shape({quantity:qe().required("La quantitat és obligatoria").min(1,"La quantitat ha de ser un número positiu")}),a=V({result:!1,errors:{}}),_=()=>{const r=new me(g);a.value=r.validate(n.salesOrderDetail)},$=async()=>{if(_(),a.value.result)O("submit",n.salesOrderDetail);else{let r="";Object.entries(a.value.errors).forEach(d=>{r+=`${d[1].map(k=>k)}.   `}),v.add({severity:"warn",summary:"Formulari inválid",detail:r,life:5e3})}};return(r,d)=>{const k=I("BaseInput"),m=I("Button");return r.salesOrderDetail?(y(),E("form",at,[c("div",rt,[o(Le,{label:"Referència",modelValue:r.salesOrderDetail.referenceId,"onUpdate:modelValue":[d[0]||(d[0]=i=>r.salesOrderDetail.referenceId=i),d[1]||(d[1]=i=>w())],fullName:!0},null,8,["modelValue"])]),c("section",null,[c("div",null,[o(k,{class:A(["mb-2",{"p-invalid":a.value.errors.description}]),label:"Descripció",modelValue:r.salesOrderDetail.description,"onUpdate:modelValue":d[2]||(d[2]=i=>r.salesOrderDetail.description=i),type:t(x).TEXT},null,8,["modelValue","type","class"])])]),c("section",st,[c("div",null,[o(k,{class:A(["mb-2",{"p-invalid":a.value.errors.quantity}]),label:"Quantitat",modelValue:r.salesOrderDetail.quantity,"onUpdate:modelValue":[d[3]||(d[3]=i=>r.salesOrderDetail.quantity=i),d[4]||(d[4]=i=>f())],type:t(x).NUMERIC},null,8,["modelValue","type","class"])]),c("div",null,[o(k,{class:A(["mb-2",{"p-invalid":a.value.errors.amount}]),label:"Total",modelValue:r.salesOrderDetail.amount,"onUpdate:modelValue":d[5]||(d[5]=i=>r.salesOrderDetail.amount=i),type:t(x).CURRENCY,disabled:""},null,8,["modelValue","type","class"])])]),o(m,{label:h.value,onClick:$,style:{float:"right"}},null,8,["label"])])):B("",!0)}}});var be={name:"Tag",extends:he,props:{value:null,severity:null,rounded:Boolean,icon:String},computed:{containerClass(){return["p-tag p-component",{"p-tag-info":this.severity==="info","p-tag-success":this.severity==="success","p-tag-warning":this.severity==="warning","p-tag-danger":this.severity==="danger","p-tag-rounded":this.rounded}]},iconClass(){return["p-tag-icon",this.icon]}}};function ot(p,O,n,D,v,h){return y(),E("span",P({class:h.containerClass},p.ptm("root")),[p.$slots.icon?(y(),L(Te(p.$slots.icon),P({key:0,class:"p-tag-icon"},p.ptm("icon")),null,16)):n.icon?(y(),E("span",P({key:1,class:h.iconClass},p.ptm("icon")),null,16)):B("",!0),se(p.$slots,"default",{},()=>[c("span",P({class:"p-tag-value"},p.ptm("value")),j(n.value),17)])],16)}function it(p,O){O===void 0&&(O={});var n=O.insertAt;if(!(!p||typeof document>"u")){var D=document.head||document.getElementsByTagName("head")[0],v=document.createElement("style");v.type="text/css",n==="top"&&D.firstChild?D.insertBefore(v,D.firstChild):D.appendChild(v),v.styleSheet?v.styleSheet.cssText=p:v.appendChild(document.createTextNode(p))}}var nt=`
.p-tag {
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.p-tag-icon,
.p-tag-value,
.p-tag-icon.pi {
    line-height: 1.5;
}
.p-tag.p-tag-rounded {
    border-radius: 10rem;
}
`;it(nt);be.render=ot;const dt={key:0},ut={key:1},ct=["onClick"],mt=z({__name:"TableSalesOrderDetails",props:{salesOrder:{},salesOrderDetails:{}},emits:["edit","delete","createWorkOrder"],setup(p,{emit:O}){const n=p,D=Ee(),v=Y(),h=ve(),w=fe();var f=void 0;const g=V({closable:!0,modal:!0,title:"Generar ordre de fabricació",visible:!1}),a=V([]),_=V({workMasterId:"",plannedDate:"",plannedQuantity:0,comment:""}),$=m=>{n.salesOrder.deliveryNoteId||m.originalEvent.target.className.includes("grid_delete_column_button")||O("edit",m.data)},r=(m,i)=>{D.require({target:m.currentTarget,message:"Está segur que vol eliminar la referència?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{O("delete",i)}})},d=m=>{a.value=h.getByReferenceId(m.referenceId),_.value.workMasterId="",a.value.length>0&&(_.value.workMasterId=a.value[0].id),_.value.plannedQuantity=m.quantity,_.value.plannedDate="",_.value.comment="",f=m,g.value.visible=!0},k=()=>{const m={workOrderDto:_.value,orderDetail:f};g.value.visible=!1,O("createWorkOrder",m)};return(m,i)=>{const e=I("Column"),N=I("Button"),C=I("DataTable"),R=I("Dialog");return y(),E(le,null,[o(C,{onRowClick:$,value:m.salesOrderDetails,tableStyle:"min-width: 100%",class:"p-datatable-sm"},{header:b(()=>[se(m.$slots,"header")]),default:b(()=>[o(e,{field:"quantity",header:"Quantitat",style:{width:"10%"}}),o(e,{header:"Referencia",style:{width:"15%"}},{body:b(s=>[H(j(t(v).getShortNameById(s.data.referenceId)),1)]),_:1}),o(e,{field:"description",header:"Descripció",style:{width:"30%"}}),o(e,{field:"workOrderId",header:"Ordre fabr.",style:{width:"10%"}},{body:b(s=>[t(w).getWorkOrderCodeById(s.data.workOrderId)?(y(),E("div",dt,[o(t(be),{icon:t(M).CHECK_CIRCLE,severity:"success",value:t(w).getWorkOrderCodeById(s.data.workOrderId)},null,8,["icon","value"])])):(y(),E("div",ut,[o(N,{size:"small",icon:t(M).PLUS_CIRCLE,value:"Generar OF",onClick:U=>d(s.data)},null,8,["icon","onClick"])]))]),_:1}),o(e,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:b(s=>[H(j(s.data.unitPrice)+" € ",1)]),_:1}),o(e,{field:"amount",header:"Total",style:{width:"10%"}},{body:b(s=>[H(j(s.data.amount)+" € ",1)]),_:1}),m.salesOrder.deliveryNoteId?B("",!0):(y(),L(e,{key:0,style:{width:"5%"}},{body:b(s=>[s.data.isDelivered?B("",!0):(y(),E("i",{key:0,class:A([t(M).TIMES,"grid_delete_column_button"]),onClick:U=>r(U,s.data)},null,10,ct))]),_:1}))]),_:3},8,["value"]),o(R,{closable:g.value.closable,visible:g.value.visible,"onUpdate:visible":i[0]||(i[0]=s=>g.value.visible=s),header:g.value.title,modal:g.value.modal,style:{width:"50vw"}},{default:b(()=>[o(Me,{createWorkOrderDto:_.value,"filtered-work-masters":a.value,onSubmit:k},null,8,["createWorkOrderDto","filtered-work-masters"])]),_:1},8,["closable","visible","header","modal"])],64)}}}),pt={class:"flex flex-wrap align-items-center justify-content-between gap-2"},vt=c("span",{class:"text-l text-900 font-bold"},"Linies de la comanda",-1),ft="Línia de comanda",Pt=z({__name:"SalesOrder",setup(p){const O=V(),n=V(T.EDIT),D=Re(),v=Be(),h=$e(),w=J(),f=oe(),g=ie(),a=de(),_=ne(),$=ue(),r=Y(),d=pe(),k=ve(),m=fe(),i=Ue(),{salesOrder:e}=ae(f),N=[{label:"Descarregar",icon:M.FILE_WORD,command:()=>we()}],C=V(!1),R=V(T.EDIT),s=V(void 0),U=V(0),ye=async()=>{const u=D.params.id;await f.GetById(u),r.fetchReferencesByModule("sales"),$.fetchOneByName("SalesOrder"),a.fetchSites(),_.fetchAll(),g.fetchCustomers(),i.fetchAll(),m.fetchBySalesOrder(u),k.workmasters||k.fetchAllActives();let l="";e.value&&(n.value=T.EDIT,l=`Comanda ${e.value.salesOrderNumber}`,e.value.salesOrderDate=Q(e.value.salesOrderDate),e.value.deliveryNoteId?d.GetById(e.value.deliveryNoteId):d.deliveryNote&&(d.deliveryNote=void 0)),h.setMenuItem({icon:M.BUILDING,backButtonVisible:!0,title:l})};Fe(async()=>{await ye()});const Oe=()=>{O.value.submitForm()},Z=(u,l)=>{r.setNewReference(K()),u===T.CREATE&&(l={id:K(),referenceId:"",quantity:0,unitCost:0,unitPrice:0,totalCost:0,amount:0,salesOrderHeaderId:"",description:"",estimatedDeliveryDate:new Date,isDelivered:!1,isInvoiced:!1}),l.salesOrderHeaderId=e.value.id,s.value=l,R.value=u,C.value=!0},De=async u=>{let l=!1,S="";l=await f.Update(u.id,u),S=l?"Comanda actualitzada":"Error a l'actualitzar la comanda",w.add({life:5e3,severity:l?"success":"error",summary:S}),l&&v.back()},_e=async u=>{R.value===T.CREATE?await f.CreateDetail(u):R.value===T.EDIT&&await f.UpdateDetail(u),C.value=!1,e.value.salesOrderDate=Q(e.value.salesOrderDate)},Se=async u=>{n.value===T.EDIT&&await f.DeleteDetail(u);const l=e.value.salesOrderDetails.filter(S=>S.id!==u.id);e.value.salesOrderDetails=l,C.value=!1,e.value.salesOrderDate=Q(e.value.salesOrderDate)},ge=async u=>{let l=!1,S="";l=await r.createReference(u),l?S="Referència creada correctament":S="La referència + versió introduïda ja existeix",w.add({severity:l?"success":"warn",summary:S,life:5e3}),l&&(r.setNewReference(K()),U.value=0)},Ie=async u=>{const l=await m.create(u.workOrderDto);l.result?(u.orderDetail.workOrderId=l.content.id,await f.UpdateDetail(u.orderDetail)&&(w.add({severity:"success",summary:"Generació OF",detail:`Ordre de fabricació ${l.content.code} generada`}),m.fetchBySalesOrder(e.value.id))):w.add({severity:"error",summary:"Generació OF",detail:"Error al generar la ordre de fabricació"})},we=async()=>{var l;const u=await ze.SalesOrder.GetReportDataById(e.value.id);if(u){const S=`Comanda_${(l=e.value)==null?void 0:l.salesOrderNumber}.docx`,F=await new je().Download(u,Ge.Order,S);F?Ae(S,F):w.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}};return(u,l)=>{const S=I("SplitButton"),ee=I("Button"),F=I("TabPanel"),te=I("TabView"),Ce=I("Dialog");return y(),E(le,null,[o(S,{label:"Guardar",onClick:Oe,model:N,size:"small",class:"grid_add_row_button"}),o(tt,{class:"mt-3 mb-3",ref_key:"salesOrderForm",ref:O,salesOrder:"salesOrder",onSubmit:De},null,512),o(te,null,{default:b(()=>[o(F,{header:"Detall"},{default:b(()=>[t(e)?(y(),L(mt,{key:0,salesOrder:t(e),salesOrderDetails:t(e).salesOrderDetails,onEdit:l[1]||(l[1]=q=>Z(t(T).EDIT,q)),onDelete:Se,onCreateWorkOrder:Ie},{header:b(()=>[c("div",pt,[vt,c("section",null,[o(ee,{disabled:t(d).deliveryNote!==void 0,size:"small",label:"Afegir línea",onClick:l[0]||(l[0]=q=>Z(t(T).CREATE,{})),class:"mr-2"},null,8,["disabled"])])])]),_:1},8,["salesOrder","salesOrderDetails"])):B("",!0)]),_:1}),o(F,{header:"Fitxers"},{default:b(()=>[t(e)?(y(),L(Pe,{key:0,entity:"SalesOrder",id:t(e).id,title:""},null,8,["id"])):B("",!0)]),_:1})]),_:1}),o(Ce,{closable:!0,visible:C.value,"onUpdate:visible":l[3]||(l[3]=q=>C.value=q),header:ft,modal:!0},{default:b(()=>[o(te,{activeIndex:U.value,"onUpdate:activeIndex":l[2]||(l[2]=q=>U.value=q)},{default:b(()=>[o(F,{header:"Línea"},{default:b(()=>[s.value?(y(),L(lt,{key:0,formAction:R.value,salesOrderDetail:s.value,onSubmit:_e},null,8,["formAction","salesOrderDetail"])):B("",!0)]),_:1}),o(F,{header:"Referencia"},{default:b(()=>[t(r).reference?(y(),L(We,{key:0,module:"sales",reference:t(r).reference,onSubmit:ge},null,8,["reference"])):B("",!0)]),_:1})]),_:1},8,["activeIndex"])]),_:1},8,["visible"])],64)}}});export{Pt as default};

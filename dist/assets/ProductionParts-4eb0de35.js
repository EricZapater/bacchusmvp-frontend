import{_ as J}from"./ExerciseDatePicker.vue_vue_type_script_setup_true_lang-ea37c2c2.js";import{d as K,g as X,u as Z,j as ee,x as te,r as V,E as oe,o as re,P as b,H as C,h as y,c as F,i as o,w as n,G as ae,a as N,e as d,k as m,C as f,D as p,l as se,n as ie}from"./index-b2ab35ad.js";import{a as E,e as le,_ as ne,g as de}from"./functions-79f2dbc4.js";import{u as ce}from"./exercise-4d5ee514.js";import{u as ue,_ as me}from"./productionpart-a4d76bf6.js";import{u as pe}from"./plantmodel-0a2469ea.js";import{u as fe}from"./workorder-4149536c.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./index-4a6fd04a.js";import"./base.service-671ed665.js";import"./reference.service-53280129.js";import"./form-validator-f8953ae6.js";import"./index-234e8704.js";const we={class:"flex flex-wrap align-items-center justify-content-between gap-2"},ke={class:"datatable-filter-5"},he={class:"filter-field"},ve={class:"filter-field"},_e=d("label",null,"Operari",-1),be={class:"filter-field"},Ce=d("label",null,"Màquina",-1),ye={class:"filter-field"},Ie=d("label",null,"OF",-1),ge=["onClick"],Pe={key:0,class:"flex-right"},xe=d("br",null,null,-1),Re=K({__name:"ProductionParts",setup(De){const M=X(),w=Z(),S=ee(),k=ue(),P=ce(),a=pe(),x=fe(),B=te(),L=()=>{var s;const e=new Date().getFullYear().toString(),t=(s=P.exercises)==null?void 0:s.find(i=>i.name===e);t&&(w.exercisePicker.exercise=t,w.exercisePicker.dates=[new Date(w.exercisePicker.exercise.startDate),new Date(w.exercisePicker.exercise.endDate)])},u=V({operatorId:"",workcenterId:"",workorderId:""}),I=async()=>{if(w.exercisePicker.dates){const e=E(w.exercisePicker.dates[0]),t=E(w.exercisePicker.dates[1]);await k.fetchFiltered(e,t,u.value.workcenterId,u.value.operatorId,u.value.workorderId),await x.fetchFiltered(e,t)}else S.add({severity:"info",summary:"Filtre invàlid",detail:"Seleccioni un període",life:5e3})},W=()=>{w.cleanExercisePicker(),u.value.workcenterId="",u.value.operatorId=""},v=oe({visible:!1,title:"Crear tíquet de producció",closable:!0,position:"center",modal:!0});re(async()=>{w.setMenuItem({icon:b.CLOUD,title:"Tíquets de producció"}),a.fetchWorkcenters(),a.fetchOperators(),a.fetchOperatorTypes(),a.fetchMachineStatuses(),await a.fetchWorkcenterCosts(),await P.fetchActive(),L(),I(),x.detailedWorkOrders=void 0});const h=C(()=>{if(k.productionParts)return k.productionParts.map(e=>({...e,personalCost:j(e),workcenterCost:Q(e)}))}),U=C(()=>{if(k.productionParts)return k.productionParts.reduce((e,t)=>e+t.time,0)}),$=C(()=>{if(k.productionParts)return k.productionParts.reduce((e,t)=>e+t.quantity,0)}),T=C(()=>{if(h.value&&h.value.length>0)return h.value.reduce((e,t)=>e+(t.personalCost?t.personalCost:0),0)}),q=C(()=>{if(h.value&&h.value.length>0)return h.value.reduce((e,t)=>e+(t.workcenterCost?t.workcenterCost:0),0)}),D=V({}),R=()=>({id:de(),operatorId:"",workcenterId:"",workOrderId:"",workOrderPhaseId:"",workOrderPhaseDetailId:"",time:0,quantity:0,date:new Date}),H=e=>{if(e.workOrder&&e.workOrderPhase&&e.workOrderPhaseDetail){const t=a.getMachineStatusNameById(e.workOrderPhaseDetail.machineStatusId);return`${e.workOrder.code} - ${e.workOrderPhase.code} (${e.workOrderPhase.description}) - ${t}`}},Q=e=>{var s;if(!e.workOrderPhaseDetail)return 0;console.log(e);let t=(s=a.workcentercosts)==null?void 0:s.find(i=>i.workcenterId===e.workcenterId&&i.machineStatusId===e.workOrderPhaseDetail.machineStatusId);if(t){const i=t.cost*e.time/60;return ne.round(i,2)}return 0},j=e=>{var i,c;let t=(i=a.operators)==null?void 0:i.find(_=>_.id===e.operatorId),s=(c=a.operatorTypes)==null?void 0:c.find(_=>_.id===(t==null?void 0:t.operatorTypeId));return s?s.cost*e.time/60:0},A=()=>{D.value=R(),v.visible=!0},Y=async()=>{v.visible=!1,await k.create(D.value)&&(M.push({path:"/productionpart"}),I())},z=(e,t)=>{B.require({target:e.currentTarget,message:`Està segur que vol eliminar el tíquet de producció: ${t.id}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{await k.delete(t.id)&&(S.add({severity:"success",summary:"Eliminat",life:3e3}),await I())}})};return(e,t)=>{const s=y("Dropdown"),i=y("Button"),c=y("Column"),_=y("DataTable"),G=y("Dialog");return N(),F(ae,null,[o(_,{value:h.value,class:"p-datatable-sm small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"80vh","sort-order":1,"sort-field":"date",paginator:"",rows:25},{header:n(()=>{var r,g;return[d("div",we,[d("div",ke,[d("div",he,[o(J,{exercises:m(P).exercises},null,8,["exercises"])]),d("div",ve,[_e,o(s,{modelValue:u.value.operatorId,"onUpdate:modelValue":t[0]||(t[0]=l=>u.value.operatorId=l),editable:"",filter:!0,options:(r=m(a).operators)==null?void 0:r.sort((l,O)=>l.surname.localeCompare(O.surname)).map(l=>({value:l.id,label:l.surname+", "+l.name})),optionValue:"value",optionLabel:"label",class:"w-full"},null,8,["modelValue","options"])]),d("div",be,[Ce,o(s,{modelValue:u.value.workcenterId,"onUpdate:modelValue":t[1]||(t[1]=l=>u.value.workcenterId=l),editable:"",filter:!0,options:(g=m(a).workcenters)==null?void 0:g.sort((l,O)=>l.description.localeCompare(O.description)),optionValue:"id",optionLabel:"description",class:"w-full"},null,8,["modelValue","options"])]),d("div",ye,[Ie,o(s,{modelValue:u.value.workorderId,"onUpdate:modelValue":t[2]||(t[2]=l=>u.value.workorderId=l),editable:"",filter:!0,options:m(x).workorders,optionValue:"id",optionLabel:"code",class:"w-full"},null,8,["modelValue","options"])]),d("div",null,[o(i,{class:"datatable-button mr-2",icon:m(b).FILTER,rounded:"",raised:"",onClick:I},null,8,["icon"]),o(i,{class:"datatable-button mr-2",icon:m(b).FILTER_SLASH,rounded:"",raised:"",onClick:W},null,8,["icon"]),o(i,{icon:m(b).PLUS,rounded:"",raised:"",onClick:A},null,8,["icon"])])])])]}),empty:n(()=>[f(" No s'han trobat tiquets. ")]),loading:n(()=>[f(" Carregant tiquets. Si us plau espera. ")]),footer:n(()=>[h.value&&h.value.length>0?(N(),F("div",Pe,[d("span",null,[f(" Temps: "+p(U.value)+" minuts / Quantitat: "+p($.value)+" unitats ",1),xe,f(" Cost personal: "+p(T.value)+" € / Cost màquina: "+p(q.value)+" € = "+p(T.value+q.value)+" € ",1)])])):se("",!0)]),default:n(()=>[o(c,{field:"operatorId",header:"Operari",style:{width:"15%"}},{body:n(r=>[f(p(m(a).getOperatorNameById(r.data.operatorId)),1)]),_:1}),o(c,{field:"workcenterId",header:"Màquina",style:{width:"15%"}},{body:n(r=>[f(p(m(a).getWorkcenterNameById(r.data.workcenterId)),1)]),_:1}),o(c,{field:"workOrderId",header:"OF",style:{width:"20%"}},{body:n(r=>[f(p(H(r.data)),1)]),_:1}),o(c,{field:"date",header:"Data",style:{width:"15%"},sortable:""},{body:n(r=>[f(p(m(le)(r.data.date)),1)]),_:1}),o(c,{field:"quantity",header:"Quantitat",style:{width:"5%"}}),o(c,{field:"time",header:"Temps (min)",style:{width:"10%"}}),o(c,{header:"Cost Home",style:{width:"10%"},field:"personalCost"},{body:n(r=>[f(p(r.data.personalCost)+" € ",1)]),_:1}),o(c,{header:"Cost Màquina",style:{width:"10%"},field:"workcenterCost"},{body:n(r=>[f(p(r.data.workcenterCost)+" € ",1)]),_:1}),o(c,{style:{width:"5%"}},{body:n(r=>[d("i",{class:ie([m(b).TIMES,"grid_delete_column_button"]),onClick:g=>z(g,r.data)},null,10,ge)]),_:1})]),_:1},8,["value"]),o(G,{visible:v.visible,"onUpdate:visible":t[3]||(t[3]=r=>v.visible=r),header:v.title,closable:v.closable,modal:v.modal},{default:n(()=>[o(me,{productionPart:D.value,"avoid-work-order-refresh":!1,onSubmit:Y},null,8,["productionPart"])]),_:1},8,["visible","header","closable","modal"])],64)}}});export{Re as default};

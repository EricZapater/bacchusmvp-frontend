import{d as L,x as be,h as v,a as g,m as A,w as f,K as ye,i as s,C as G,D as z,k as t,c as N,n as $,P,l as k,j as W,z as ae,r as T,e as d,s as x,p as _e,b as ge,f as Se,H as Ie,F as _,v as De,g as we,u as Ve,o as Ce,G as Ee}from"./index-b40c6ded.js";import{c as te,b as Te,g as X}from"./functions-79f2dbc4.js";import{u as H}from"./reference-c2502c33.js";import{u as oe}from"./customers-bd42da68.js";import{u as Be}from"./exercise-a726b142.js";import{u as Re}from"./plantmodel-c31dbb24.js";import{u as se}from"./lifecycle-5c03d44c.js";import{u as Fe}from"./tax-fbfc0766.js";import{_ as ke}from"./FormReference.vue_vue_type_script_setup_true_lang-0a3e8b6b.js";import{a as he,b as $e}from"./report.service-a3f18829.js";import{S as xe}from"./index-fe53ec88.js";import{u as Ae}from"./workmaster-c8938f23.js";import{u as J}from"./budget-49c6bf56.js";import{c as le,a as Q,F as re,d as Ne}from"./form-validator-f8953ae6.js";import{_ as Ue}from"./DropdownReference.vue_vue_type_script_setup_true_lang-8fd6db31.js";import{u as qe}from"./order-3925256b.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./reference.service-9da581c8.js";import"./base.service-265c7e5a.js";import"./index-21bedaf3.js";import"./index-644471ec.js";import"./FileEntityPicker-146ae8c3.js";import"./file.service-062027ed.js";import"./referenceType-5740f469.js";import"./index-864ce237.js";const Pe=["onClick"],Le=L({__name:"TableBudgetDetails",props:{budget:{},details:{}},emits:["edit","delete"],setup(D,{emit:S}){const c=be(),w=J(),V=H(),B=e=>{e.originalEvent.target.className.includes("grid_delete_column_button")||S("edit",e.data)},b=(e,C)=>{c.require({target:e.currentTarget,message:"Está segur que vol eliminar la línea?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{S("delete",C)}})};return(e,C)=>{const u=v("Column"),R=v("DataTable");return g(),A(R,{onRowClick:B,value:e.details,tableStyle:"min-width: 100%",class:"p-datatable-sm"},{header:f(()=>[ye(e.$slots,"header")]),default:f(()=>[s(u,{field:"quantity",header:"Quantitat",style:{width:"10%"}}),s(u,{header:"Referencia",style:{width:"15%"}},{body:f(y=>[G(z(t(V).getShortNameById(y.data.referenceId)),1)]),_:1}),s(u,{field:"description",header:"Descripció",style:{width:"30%"}}),s(u,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:f(y=>[G(z(y.data.unitPrice)+" € ",1)]),_:1}),s(u,{field:"amount",header:"Total",style:{width:"10%"}},{body:f(y=>[G(z(y.data.amount)+" € ",1)]),_:1}),s(u,{style:{width:"5%"}},{body:f(y=>[t(w).order===void 0?(g(),N("i",{key:0,class:$([t(P).TIMES,"grid_delete_column_button"]),onClick:a=>b(a,y.data)},null,10,Pe)):k("",!0)]),_:1})]),_:3},8,["value"])}}}),M=D=>(_e("data-v-9af11046"),D=D(),ge(),D),Me={key:0},Oe={class:"four-columns mt-2"},je=M(()=>d("label",{class:"block text-900 mb-2"},"Data Alta",-1)),Ge=M(()=>d("label",{class:"block text-900 mb-2"},"Data Acceptació",-1)),ze={class:"three-columns mt-2"},Xe=M(()=>d("label",{class:"block text-900 mb-2"},"Estat",-1)),Qe=M(()=>d("label",{class:"block text-900 mb-2"},"Client",-1)),We=L({__name:"FormBudget",emits:["submit","cancel"],setup(D,{expose:S,emit:c}){const w=J(),V=oe(),B=se(),b=W(),{budget:e}=ae(w),C=le().shape({customerId:Q().required("El client es obligatori"),statusId:Q().required("L'estat es obligatori"),exerciseId:Q().required("L'exercici es obligatori")}),u=T({result:!1,errors:{}}),R=()=>{const r=new re(C);u.value=r.validate(e.value)};S({submitForm:async()=>{if(R(),u.value.result)a(),c("submit",e.value);else{let r="";Object.entries(u.value.errors).forEach(i=>{r+=`${i[1].map(I=>I)}.   `}),b.add({severity:"warn",summary:"Formulari inválid",detail:r,life:5e3})}}});const a=()=>{e.value&&(e.value.date=te(e.value.date),e.value.acceptanceDate&&(e.value.acceptanceDate=te(e.value.acceptanceDate)))};return(r,i)=>{var q,E;const I=v("BaseInput"),l=v("Calendar"),U=v("Dropdown");return g(),N("div",null,[t(e)?(g(),N("form",Me,[d("section",Oe,[d("div",null,[s(I,{type:t(x).TEXT,label:"Pressupost",id:"number",modelValue:t(e).number,"onUpdate:modelValue":i[0]||(i[0]=p=>t(e).number=p),disabled:""},null,8,["type","modelValue"])]),d("div",null,[je,s(l,{modelValue:t(e).date,"onUpdate:modelValue":i[1]||(i[1]=p=>t(e).date=p),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),d("div",null,[Ge,s(l,{modelValue:t(e).acceptanceDate,"onUpdate:modelValue":i[2]||(i[2]=p=>t(e).acceptanceDate=p),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),d("div",null,[s(I,{type:t(x).TEXT,disabled:!0,label:"Comanda",value:(q=t(w).order)==null?void 0:q.number},null,8,["type","value"])])]),d("section",ze,[d("div",null,[Xe,s(U,{modelValue:t(e).statusId,"onUpdate:modelValue":i[3]||(i[3]=p=>t(e).statusId=p),editable:"",options:(E=t(B).lifecycle)==null?void 0:E.statuses,optionValue:"id",optionLabel:"name",class:$(["w-full",{"p-invalid":u.value.errors.statusId}])},null,8,["modelValue","options","class"])]),d("div",null,[Qe,s(U,{modelValue:t(e).customerId,"onUpdate:modelValue":i[4]||(i[4]=p=>t(e).customerId=p),editable:"",options:t(V).customers,optionValue:"id",optionLabel:"comercialName",class:$(["w-full",{"p-invalid":u.value.errors.customerId}])},null,8,["modelValue","options","class"])]),d("div",null,[s(I,{type:t(x).NUMERIC,label:"Dies entrega",id:"deliveryDays",modelValue:t(e).deliveryDays,"onUpdate:modelValue":i[5]||(i[5]=p=>t(e).deliveryDays=p)},null,8,["type","modelValue"])])])])):k("",!0)])}}});const He=Se(We,[["__scopeId","data-v-9af11046"]]),Je={key:0},Ke={class:"mb-2"},Ye={class:"two-columns"},Ze=L({__name:"FormBudgetDetail",props:{formAction:{},detail:{}},emits:["submit"],setup(D,{emit:S}){const c=D,w=H(),V=W(),B=Ie(()=>c.formAction===_.CREATE?"Afegir":"Modificar"),b=()=>{const a=w.references.find(r=>r.id===c.detail.referenceId);a&&(c.detail.description=a.description,c.detail.unitCost=a==null?void 0:a.cost,c.detail.unitPrice=a==null?void 0:a.price,e())},e=()=>{c.detail.amount=c.detail.unitPrice*c.detail.quantity,c.detail.totalCost=c.detail.unitCost*c.detail.quantity},C=le().shape({quantity:Ne().required("La quantitat és obligatoria").min(1,"La quantitat ha de ser un número positiu")}),u=T({result:!1,errors:{}}),R=()=>{const a=new re(C);u.value=a.validate(c.detail)},y=async()=>{if(R(),u.value.result)S("submit",c.detail);else{let a="";Object.entries(u.value.errors).forEach(r=>{a+=`${r[1].map(i=>i)}.   `}),V.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}};return(a,r)=>{const i=v("BaseInput"),I=v("Button");return a.detail?(g(),N("form",Je,[d("div",Ke,[s(Ue,{label:"Referència",modelValue:a.detail.referenceId,"onUpdate:modelValue":[r[0]||(r[0]=l=>a.detail.referenceId=l),r[1]||(r[1]=l=>b())],fullName:!0},null,8,["modelValue"])]),d("section",null,[d("div",null,[s(i,{class:$(["mb-2",{"p-invalid":u.value.errors.description}]),label:"Descripció",modelValue:a.detail.description,"onUpdate:modelValue":r[2]||(r[2]=l=>a.detail.description=l),type:t(x).TEXT},null,8,["modelValue","type","class"])])]),d("section",Ye,[d("div",null,[s(i,{class:$(["mb-2",{"p-invalid":u.value.errors.quantity}]),label:"Quantitat",modelValue:a.detail.quantity,"onUpdate:modelValue":[r[3]||(r[3]=l=>a.detail.quantity=l),r[4]||(r[4]=l=>e())],type:t(x).NUMERIC},null,8,["modelValue","type","class"])]),d("div",null,[s(i,{class:$(["mb-2",{"p-invalid":u.value.errors.amount}]),label:"Total",modelValue:a.detail.amount,"onUpdate:modelValue":r[5]||(r[5]=l=>a.detail.amount=l),type:t(x).CURRENCY,disabled:""},null,8,["modelValue","type","class"])])]),s(I,{label:B.value,onClick:y,style:{float:"right"}},null,8,["label"])])):k("",!0)}}}),et={class:"flex flex-wrap align-items-center justify-content-between gap-2"},tt=d("span",{class:"text-l text-900 font-bold"},"Linies del pressupost",-1),at="Línia del pressupost",Rt=L({__name:"Budget",setup(D){const S=T(),c=T(_.EDIT),w=De(),V=we(),B=Ve(),b=W(),e=J(),C=oe(),u=Re(),R=Be(),y=se(),a=H(),r=Ae(),i=Fe(),I=qe(),{budget:l}=ae(e),U=[{label:"Descarregar",icon:P.FILE_WORD,command:()=>q()},{label:"Crear comanda",icon:P.FLAG_FILL,command:()=>pe()}],q=async()=>{var o;const n=await xe.Budget.GetReportDataById(l.value.id);if(n){const m=`Pressupost_${(o=l.value)==null?void 0:o.number}.docx`,F=await new $e().Download(n,he.Budget,m);F?Te(m,F):b.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla del pressupost"})}},E=T(!1),p=T(_.EDIT),O=T(void 0),j=T(0),ne=async()=>{const n=w.params.id;await e.GetById(n),await e.GetAssociatedSalesOrders(n),a.fetchReferencesByModule("sales"),y.fetchOneByName("Budget"),u.fetchSites(),R.fetchAll(),C.fetchCustomers(),i.fetchAll(),r.workmasters||r.fetchAllActives();let o="";l.value&&(c.value=_.EDIT,o=`Pressupost ${l.value.number}`),B.setMenuItem({icon:P.BUILDING,backButtonVisible:!0,title:o})};Ce(async()=>{await ne()});const ie=()=>{S.value.submitForm()},K=(n,o)=>{a.setNewReference(X()),n===_.CREATE&&(o={id:X(),referenceId:"",quantity:0,unitCost:0,unitPrice:0,totalCost:0,amount:0,budgetId:l.value.id,description:""}),O.value=o,p.value=n,E.value=!0},de=async n=>{let o=!1,m="";o=await e.Update(n.id,n),m=o?"Pressupost actualitzat correctament":"Error a l'actualitzar el pressupost",b.add({life:5e3,severity:o?"success":"error",summary:m}),o&&V.back()},ue=async n=>{p.value===_.CREATE?await e.CreateDetail(n):p.value===_.EDIT&&await e.UpdateDetail(n),E.value=!1},ce=async n=>{c.value===_.EDIT&&await e.DeleteDetail(n);const o=l.value.details.filter(m=>m.id!==n.id);l.value.details=o,E.value=!1},me=async n=>{let o=!1,m="";o=await a.createReference(n),o?m="Referència creada correctament":m="La referència + versió introduïda ja existeix",b.add({severity:o?"success":"warn",summary:m,life:5e3}),o&&(a.setNewReference(X()),j.value=0)},pe=async()=>{var n,o;if(e.order){b.add({severity:"warn",summary:"Aquest pressupost ja té una comanda associada",life:5e3});return}if(l.value){const m=await I.CreateFromBudget(l.value);m.result?(b.add({severity:"success",summary:`Comanda ${(n=m.content)==null?void 0:n.number} creada correctament`,life:5e3}),V.push(`/salesorder/${(o=m.content)==null?void 0:o.id}`)):b.add({severity:"error",summary:"Error al crear la comanda ",detail:m.errors[0],life:5e3})}};return(n,o)=>{const m=v("SplitButton"),Y=v("Button"),F=v("TabPanel"),fe=v("FileEntityPicker"),Z=v("TabView"),ve=v("Dialog");return g(),N(Ee,null,[s(m,{label:"Guardar",onClick:ie,model:U,size:"small",class:"grid_add_row_button"}),s(He,{class:"mt-3 mb-3",ref_key:"budgetForm",ref:S,onSubmit:de},null,512),s(Z,null,{default:f(()=>[s(F,{header:"Detall"},{default:f(()=>{var h;return[t(l)?(g(),A(Le,{key:0,budget:t(l),details:(h=t(l))==null?void 0:h.details,onEdit:o[1]||(o[1]=ee=>K(t(_).EDIT,ee)),onDelete:ce},{header:f(()=>[d("div",et,[tt,d("section",null,[s(Y,{size:"small",label:"Afegir línea",onClick:o[0]||(o[0]=ee=>K(t(_).CREATE,{})),class:"mr-2",disabled:t(e).order!==void 0},null,8,["disabled"])])])]),_:1},8,["budget","details"])):k("",!0)]}),_:1}),s(F,{header:"Fitxers"},{default:f(()=>[t(l)?(g(),A(fe,{key:0,entity:"Budget",id:t(l).id,title:""},null,8,["id"])):k("",!0)]),_:1})]),_:1}),s(ve,{closable:!0,visible:E.value,"onUpdate:visible":o[3]||(o[3]=h=>E.value=h),header:at,modal:!0},{default:f(()=>[s(Z,{activeIndex:j.value,"onUpdate:activeIndex":o[2]||(o[2]=h=>j.value=h)},{default:f(()=>[s(F,{header:"Línea"},{default:f(()=>[O.value?(g(),A(Ze,{key:0,formAction:p.value,detail:O.value,onSubmit:ue},null,8,["formAction","detail"])):k("",!0)]),_:1}),s(F,{header:"Referencia"},{default:f(()=>[t(a).reference?(g(),A(ke,{key:0,module:"sales",reference:t(a).reference,onSubmit:me},null,8,["reference"])):k("",!0)]),_:1})]),_:1},8,["activeIndex"])]),_:1},8,["visible"])],64)}}});export{Rt as default};

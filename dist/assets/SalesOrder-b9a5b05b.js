import{d as A,j as G,z as j,o as H,r as N,h as b,a as k,c as U,k as l,e as u,i,n as C,s as B,y as ee,l as $,p as te,b as se,f as ae,J as Q,F as _,m as M,w as S,P as z,C as L,D as P,v as le,g as oe,u as re,G as ie}from"./index-466d75c1.js";import{f as ne,g as X}from"./functions-224f323d.js";import{u as q}from"./salesOrder-f0e59711.js";import{u as de}from"./customers-1c14868a.js";import{u as ue}from"./exercise-2ec2ee3b.js";import{u as ce}from"./plantmodel-185a22da.js";import{u as me}from"./lifecycle-4708998a.js";import{c as J,a as x,F as Y,d as pe}from"./form-validator-6bc6aef4.js";import{u as K}from"./reference-b7d1b886.js";import"./v4-a960c1f4.js";import"./index-2b15c2fc.js";import"./reference.service-5bff21c4.js";import"./base.service-ebcf88a2.js";import"./index-5a1b8b33.js";const F=y=>(te("data-v-c2399e31"),y=y(),se(),y),ve={key:0},fe={class:"four-columns"},be={class:"mt-1"},_e=F(()=>u("label",{class:"block text-900 mb-2"},"Exercici",-1)),De={class:"mt-1"},ye={class:"mt-1"},Oe=F(()=>u("label",{class:"block text-900 mb-2"},"Data Comanda",-1)),Ie={class:"mt-1"},Ve=F(()=>u("label",{class:"block text-900 mb-2"},"Estat",-1)),Ce={class:"two-columns"},we={class:"mt-1"},Se=F(()=>u("label",{class:"block text-900 mb-2"},"Origen",-1)),ge={class:"mt-1"},Ee=F(()=>u("label",{class:"block text-900 mb-2"},"Client",-1)),Te=A({__name:"FormSalesOrder",emits:["submit","cancel"],setup(y,{expose:D,emit:n}){const w=q(),O=de(),I=ce(),m=ue(),p=me(),g=K(),d=G(),{salesOrder:e}=j(w);H(async()=>{await I.fetchSites(),await m.fetchAll(),await O.fetchCustomers(),g.fetchReferences(),await p.fetchOneByName("SalesOrder"),e.value.salesOrderDate=ne(e.value.salesOrderDate)});const v=J().shape({siteId:x().required("L'origen es obligatori"),customerId:x().required("El client es obligatori"),statusId:x().required("L'estat es obligatori"),exerciseId:x().required("L'exercici es obligatori")}),t=N({result:!1,errors:{}}),c=()=>{const s=new Y(v);t.value=s.validate(e.value)};D({submitForm:async()=>{if(c(),t.value.result)n("submit",e.value);else{let s="";Object.entries(t.value.errors).forEach(o=>{s+=`${o[1].map(a=>a)}.   `}),d.add({severity:"warn",summary:"Formulari inválid",detail:s,life:5e3})}}});const T=()=>{var o;const s=(o=O.customers)==null?void 0:o.find(a=>{var r;return a.id===((r=e.value)==null?void 0:r.customerId)});s&&e.value&&(e.value.customerCode=s.code,e.value.customerComercialName=s.comercialName,e.value.customerTaxName=s.taxName,e.value.customerVatNumber=s.vatNumber,e.value.customerAccountNumber=s.accountNumber),console.log(e.value)},R=()=>{var o;const s=(o=I.sites)==null?void 0:o.find(a=>{var r;return a.id===((r=e.value)==null?void 0:r.siteId)});s&&e.value&&(e.value.name=s.name,e.value.address=s.address,e.value.city=s.city,e.value.postalCode=s.postalCode,e.value.region=s.region,e.value.country=s.country,e.value.vatNumber=s.vatNumber)};return(s,o)=>{var V;const a=b("Dropdown"),r=b("Calendar");return k(),U("div",null,[l(e)?(k(),U("form",ve,[u("section",fe,[u("div",be,[_e,i(a,{modelValue:l(e).exerciseId,"onUpdate:modelValue":o[0]||(o[0]=f=>l(e).exerciseId=f),editable:"",options:l(m).exercises,optionValue:"id",optionLabel:"name",class:C(["w-full",{"p-invalid":t.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),u("div",De,[i(ee,{type:l(B).TEXT,label:"Num. Comanda",id:"salesOrderNumber",modelValue:l(e).salesOrderNumber,"onUpdate:modelValue":o[1]||(o[1]=f=>l(e).salesOrderNumber=f),disabled:""},null,8,["type","modelValue"])]),u("div",ye,[Oe,i(r,{modelValue:l(e).salesOrderDate,"onUpdate:modelValue":o[2]||(o[2]=f=>l(e).salesOrderDate=f),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),u("div",Ie,[Ve,i(a,{modelValue:l(e).statusId,"onUpdate:modelValue":o[3]||(o[3]=f=>l(e).statusId=f),editable:"",options:(V=l(p).lifecycle)==null?void 0:V.statuses,optionValue:"id",optionLabel:"name",class:C(["w-full",{"p-invalid":t.value.errors.statusId}])},null,8,["modelValue","options","class"])])]),u("section",Ce,[u("div",we,[Se,i(a,{modelValue:l(e).siteId,"onUpdate:modelValue":[o[4]||(o[4]=f=>l(e).siteId=f),o[5]||(o[5]=f=>R())],editable:"",options:l(I).sites,optionValue:"id",optionLabel:"name",class:C(["w-full",{"p-invalid":t.value.errors.siteId}])},null,8,["modelValue","options","class"])]),u("div",ge,[Ee,i(a,{modelValue:l(e).customerId,"onUpdate:modelValue":[o[6]||(o[6]=f=>l(e).customerId=f),o[7]||(o[7]=f=>T())],editable:"",options:l(O).customers,optionValue:"id",optionLabel:"comercialName",class:C(["w-full",{"p-invalid":t.value.errors.customerId}])},null,8,["modelValue","options","class"])])])])):$("",!0)])}}});const Ne=ae(Te,[["__scopeId","data-v-c2399e31"]]),ke={key:0},Re={class:"three-columns"},he=u("label",{class:"block text-900 mb-2"},"Referència",-1),Fe=A({__name:"FormSalesOrderReference",props:{formAction:{},salesOrderDetail:{}},emits:["submit"],setup(y,{emit:D}){const n=y;q();const w=K(),O=G(),I=Q(()=>n.formAction===_.CREATE?"Afegir":"Modificar"),m=()=>{const t=w.references.find(c=>c.id===n.salesOrderDetail.referenceId);t&&(n.salesOrderDetail.description=t==null?void 0:t.description,n.salesOrderDetail.isInvoiced=!1,n.salesOrderDetail.isServed=!1,n.salesOrderDetail.unitCost=t==null?void 0:t.cost,n.salesOrderDetail.unitPrice=t==null?void 0:t.price,p())},p=()=>{n.salesOrderDetail.amount=n.salesOrderDetail.unitPrice*n.salesOrderDetail.quantity,n.salesOrderDetail.totalCost=n.salesOrderDetail.unitCost*n.salesOrderDetail.quantity},g=J().shape({quantity:pe().required("La quantitat és obligatoria").min(1,"La quantitat ha de ser un número positiu")}),d=N({result:!1,errors:{}}),e=()=>{const t=new Y(g);d.value=t.validate(n.salesOrderDetail)},v=async()=>{if(e(),d.value.result)D("submit",n.salesOrderDetail);else{let t="";Object.entries(d.value.errors).forEach(c=>{t+=`${c[1].map(E=>E)}.   `}),O.add({severity:"warn",summary:"Formulari inválid",detail:t,life:5e3})}};return(t,c)=>{const E=b("Dropdown"),T=b("BaseInput"),R=b("Button");return t.salesOrderDetail?(k(),U("form",ke,[u("section",Re,[u("div",null,[he,i(E,{modelValue:t.salesOrderDetail.referenceId,"onUpdate:modelValue":[c[0]||(c[0]=s=>t.salesOrderDetail.referenceId=s),c[1]||(c[1]=s=>m())],editable:"",options:l(w).references,optionValue:"id",optionLabel:"description",class:C(["w-full",{"p-invalid":d.value.errors.referenceId}])},null,8,["modelValue","options","class"])]),u("div",null,[i(T,{class:C(["mb-2",{"p-invalid":d.value.errors.quantity}]),label:"Quantitat",modelValue:t.salesOrderDetail.quantity,"onUpdate:modelValue":[c[2]||(c[2]=s=>t.salesOrderDetail.quantity=s),c[3]||(c[3]=s=>p())],type:l(B).NUMERIC},null,8,["modelValue","type","class"])]),u("div",null,[i(T,{class:C(["mb-2",{"p-invalid":d.value.errors.amount}]),label:"Total",modelValue:t.salesOrderDetail.amount,"onUpdate:modelValue":c[4]||(c[4]=s=>t.salesOrderDetail.amount=s),type:l(B).CURRENCY,disabled:""},null,8,["modelValue","type","class"])])]),u("section",null,[u("div",null,[i(T,{class:C(["mb-2",{"p-invalid":d.value.errors.description}]),label:"Descripció",modelValue:t.salesOrderDetail.description,"onUpdate:modelValue":c[5]||(c[5]=s=>t.salesOrderDetail.description=s),type:l(B).TEXT},null,8,["modelValue","type","class"])])]),i(R,{label:I.value,onClick:v,style:{float:"right"}},null,8,["label"])])):$("",!0)}}}),xe=["onClick"],Be=A({__name:"TableSalesOrderReferences",props:{salesOrderDetails:{}},emits:["add","edit","delete"],setup(y,{emit:D}){const n=y;q();const w=()=>{const m={id:X(),referenceId:"",quantity:0,unitCost:0,unitPrice:0,totalCost:0,amount:0,salesOrderHeaderId:"",description:"",estimatedDeliveryDate:new Date,isServerd:!1,isInvoiced:!1};D("add",m)},O=m=>{m.originalEvent.target.className.includes("grid_delete_column_button")||D("edit",m.data)},I=(m,p)=>{D("delete",p)};return(m,p)=>{const g=b("Button"),d=b("Column"),e=b("DataTable");return k(),M(e,{onRowClick:O,value:n.salesOrderDetails,tableStyle:"min-width: 100%"},{default:S(()=>[i(g,{onClick:w,rounded:"",icon:l(z).PLUS,class:"grid_add_row_button",style:{"margin-right":"1.5rem"}},null,8,["icon"]),i(d,{field:"quantity",header:"Quantitat",style:{width:"10%"}}),i(d,{field:"description",header:"Descripció",style:{width:"30%"}}),i(d,{field:"unitCost",header:"Cost un.",style:{width:"10%"}},{body:S(v=>[L(P(v.data.unitCost)+" € ",1)]),_:1}),i(d,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:S(v=>[L(P(v.data.unitPrice)+" € ",1)]),_:1}),i(d,{field:"amount",header:"Total",style:{width:"10%"}},{body:S(v=>[L(P(v.data.amount)+" € ",1)]),_:1}),i(d,{style:{width:"10%"}},{body:S(v=>[u("i",{class:C([l(z).TIMES,"grid_delete_column_button"]),onClick:t=>I(t,v.data)},null,10,xe)]),_:1})]),_:1},8,["value"])}}}),Ye=A({__name:"SalesOrder",setup(y){const D=N(),n=N(_.EDIT),w=le(),O=oe(),I=re(),m=q(),{salesOrder:p}=j(m),g=Q(()=>e.value===_.CREATE?"Escull referència":"Modifica referència"),d=N(!1),e=N(_.EDIT),v=N(void 0),t=async()=>{await m.GetById(w.params.id);let a="";p.value&&(n.value=_.EDIT,a=`Comanda ${p.value.salesOrderNumber}`),I.setMenuItem({icon:z.BUILDING,backButtonVisible:!0,title:a})};H(async()=>{await t()});const c=()=>{D.value.submitForm()},E=(a,r)=>{a===_.CREATE&&(r.id=X()),r.salesOrderHeaderId=p.value.id,v.value=r,e.value=a,d.value=!0},T=G(),R=async a=>{let r=!1,V="";console.log(a.salesOrderDate),r=await m.Update(a.id,a),console.log("guardar comanda de venda: ",r),V=r?"Comanda actualitzada":"Error a l'actualitzar la comanda",T.add({life:5e3,severity:r?"success":"error",summary:V}),r&&O.back()},s=async a=>{e.value===_.CREATE?await m.CreateDetail(a):e.value===_.EDIT&&await m.UpdateDetail(a),d.value=!1},o=async a=>{n.value===_.EDIT&&await m.DeleteDetail(a);const r=p.value.salesOrderDetails.filter(V=>V.id!==a.id);p.value.salesOrderDetails=r,d.value=!1};return(a,r)=>{const V=b("Button"),f=b("TabPanel"),W=b("TabView"),Z=b("Dialog");return k(),U(ie,null,[i(V,{label:"Guardar",class:"grid_add_row_button",size:"small",onClick:c}),i(Ne,{class:"mt-3",ref_key:"salesOrderForm",ref:D,salesOrder:"salesOrder",onSubmit:R},null,512),i(W,null,{default:S(()=>[i(f,{header:"Referències"},{default:S(()=>[l(p)?(k(),M(Be,{key:0,salesOrderDetails:l(p).salesOrderDetails,onAdd:r[0]||(r[0]=h=>E(l(_).CREATE,h)),onEdit:r[1]||(r[1]=h=>E(l(_).EDIT,h)),onDelete:o},null,8,["salesOrderDetails"])):$("",!0)]),_:1})]),_:1}),i(Z,{closable:!0,visible:d.value,"onUpdate:visible":r[2]||(r[2]=h=>d.value=h),header:g.value,modal:!0},{default:S(()=>[v.value?(k(),M(Fe,{key:0,formAction:e.value,salesOrderDetail:v.value,onSubmit:s},null,8,["formAction","salesOrderDetail"])):$("",!0)]),_:1},8,["visible","header"])],64)}}});export{Ye as default};

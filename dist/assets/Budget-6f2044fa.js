import{d as P,x as be,h as _,a as I,m as x,w as b,K as ye,i as l,C as Z,D as ee,k as e,c as U,n as $,P as N,l as R,j as X,z as oe,r as T,e as d,s as A,p as _e,b as ge,f as Ie,H as Se,F as g,v as De,g as we,u as Ve,o as Ce,G as Ee}from"./index-7c1e9124.js";import{d as te,c as ae,b as Te,g as G}from"./functions-2e154ea4.js";import{u as Q}from"./reference-bdd6ffa5.js";import{u as se}from"./customers-392120c2.js";import{u as Be}from"./exercise-26ea44eb.js";import{u as Re}from"./plantmodel-3edf4c73.js";import{u as le}from"./lifecycle-ff781d30.js";import{u as ke}from"./tax-6478eba8.js";import{_ as Fe}from"./FormReference.vue_vue_type_script_setup_true_lang-7a57f9af.js";import{a as he,b as $e}from"./report.service-48ff6f81.js";import{S as Ae}from"./index-3286c236.js";import{u as xe}from"./workmaster-02628992.js";import{u as W}from"./budget-93b4e48b.js";import{L as Ue}from"./LinkReference-db98d0b3.js";import{c as re,a as z,F as ne,d as qe}from"./form-validator-f8953ae6.js";import{_ as Le}from"./DropdownReference.vue_vue_type_script_setup_true_lang-d98d09a8.js";import{u as Ne}from"./order-a9cf1e3b.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./reference.service-0677d75e.js";import"./base.service-14be693f.js";import"./index-bb0ab5e1.js";import"./index-b0477b25.js";import"./DropdownCustomers.vue_vue_type_script_setup_true_lang-f25c76f5.js";import"./FileEntityPicker-f7ae8736.js";import"./file.service-f7800d99.js";import"./referenceType-16270a14.js";import"./index-c3ba1681.js";const Pe=["onClick"],Me=P({__name:"TableBudgetDetails",props:{budget:{},details:{}},emits:["edit","delete"],setup(w,{emit:S}){const u=be(),V=W();Q();const C=c=>{c.originalEvent.target.className.includes("grid_delete_column_button")||S("edit",c.data)},B=(c,t)=>{u.require({target:c.currentTarget,message:"Está segur que vol eliminar la línea?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{S("delete",t)}})};return(c,t)=>{const y=_("Column"),p=_("DataTable");return I(),x(p,{onRowClick:C,value:c.details,tableStyle:"min-width: 100%",class:"p-datatable-sm",sortMode:"single",sortField:"reference.code",sortOrder:1},{header:b(()=>[ye(c.$slots,"header")]),default:b(()=>[l(y,{field:"quantity",header:"Quantitat",style:{width:"10%"}}),l(y,{header:"Referencia",field:"reference.code",sortable:"",style:{width:"15%"}},{body:b(v=>[l(Ue,{id:v.data.referenceId},null,8,["id"])]),_:1}),l(y,{field:"description",header:"Descripció",style:{width:"30%"}}),l(y,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:b(v=>[Z(ee(e(te)(v.data.unitPrice)),1)]),_:1}),l(y,{field:"amount",header:"Total",style:{width:"10%"}},{body:b(v=>[Z(ee(e(te)(v.data.amount)),1)]),_:1}),l(y,{style:{width:"5%"}},{body:b(v=>[e(V).order===void 0?(I(),U("i",{key:0,class:$([e(N).TIMES,"grid_delete_column_button"]),onClick:k=>B(k,v.data)},null,10,Pe)):R("",!0)]),_:1})]),_:3},8,["value"])}}}),M=w=>(_e("data-v-9af11046"),w=w(),ge(),w),Oe={key:0},je={class:"four-columns mt-2"},Ge=M(()=>d("label",{class:"block text-900 mb-2"},"Data Alta",-1)),ze=M(()=>d("label",{class:"block text-900 mb-2"},"Data Acceptació",-1)),Xe={class:"three-columns mt-2"},Qe=M(()=>d("label",{class:"block text-900 mb-2"},"Estat",-1)),We=M(()=>d("label",{class:"block text-900 mb-2"},"Client",-1)),He=P({__name:"FormBudget",emits:["submit","cancel"],setup(w,{expose:S,emit:u}){const V=W(),C=se(),B=le(),c=X(),{budget:t}=oe(V),y=re().shape({customerId:z().required("El client es obligatori"),statusId:z().required("L'estat es obligatori"),exerciseId:z().required("L'exercici es obligatori")}),p=T({result:!1,errors:{}}),v=()=>{const r=new ne(y);p.value=r.validate(t.value)};S({submitForm:async()=>{if(v(),p.value.result)a(),u("submit",t.value);else{let r="";Object.entries(p.value.errors).forEach(i=>{r+=`${i[1].map(D=>D)}.   `}),c.add({severity:"warn",summary:"Formulari inválid",detail:r,life:5e3})}}});const a=()=>{t.value&&(t.value.date=ae(t.value.date),t.value.acceptanceDate&&(t.value.acceptanceDate=ae(t.value.acceptanceDate)))};return(r,i)=>{var L,E;const D=_("BaseInput"),s=_("Calendar"),q=_("Dropdown");return I(),U("div",null,[e(t)?(I(),U("form",Oe,[d("section",je,[d("div",null,[l(D,{type:e(A).TEXT,label:"Pressupost",id:"number",modelValue:e(t).number,"onUpdate:modelValue":i[0]||(i[0]=f=>e(t).number=f),disabled:""},null,8,["type","modelValue"])]),d("div",null,[Ge,l(s,{modelValue:e(t).date,"onUpdate:modelValue":i[1]||(i[1]=f=>e(t).date=f),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),d("div",null,[ze,l(s,{modelValue:e(t).acceptanceDate,"onUpdate:modelValue":i[2]||(i[2]=f=>e(t).acceptanceDate=f),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),d("div",null,[l(D,{type:e(A).TEXT,disabled:!0,label:"Comanda",value:(L=e(V).order)==null?void 0:L.number},null,8,["type","value"])])]),d("section",Xe,[d("div",null,[Qe,l(q,{modelValue:e(t).statusId,"onUpdate:modelValue":i[3]||(i[3]=f=>e(t).statusId=f),editable:"",options:(E=e(B).lifecycle)==null?void 0:E.statuses,optionValue:"id",optionLabel:"name",class:$(["w-full",{"p-invalid":p.value.errors.statusId}])},null,8,["modelValue","options","class"])]),d("div",null,[We,l(q,{modelValue:e(t).customerId,"onUpdate:modelValue":i[4]||(i[4]=f=>e(t).customerId=f),editable:"",options:e(C).customers,optionValue:"id",optionLabel:"comercialName",class:$(["w-full",{"p-invalid":p.value.errors.customerId}])},null,8,["modelValue","options","class"])]),d("div",null,[l(D,{type:e(A).NUMERIC,label:"Dies entrega",id:"deliveryDays",modelValue:e(t).deliveryDays,"onUpdate:modelValue":i[5]||(i[5]=f=>e(t).deliveryDays=f)},null,8,["type","modelValue"])])])])):R("",!0)])}}});const Je=Ie(He,[["__scopeId","data-v-9af11046"]]),Ke={key:0},Ye={class:"mb-2"},Ze={class:"two-columns"},et=P({__name:"FormBudgetDetail",props:{formAction:{},budget:{},detail:{}},emits:["submit"],setup(w,{emit:S}){const u=w,V=Q(),C=X(),B=Se(()=>u.formAction===g.CREATE?"Afegir":"Modificar"),c=()=>{const a=V.references.find(r=>r.id===u.detail.referenceId);a&&(u.detail.description=a.description,u.detail.unitCost=a==null?void 0:a.cost,u.detail.unitPrice=a==null?void 0:a.price,t())},t=()=>{u.detail.amount=u.detail.unitPrice*u.detail.quantity,u.detail.totalCost=u.detail.unitCost*u.detail.quantity},y=re().shape({quantity:qe().required("La quantitat és obligatoria").min(1,"La quantitat ha de ser un número positiu")}),p=T({result:!1,errors:{}}),v=()=>{const a=new ne(y);p.value=a.validate(u.detail)},k=async()=>{if(v(),p.value.result)S("submit",u.detail);else{let a="";Object.entries(p.value.errors).forEach(r=>{a+=`${r[1].map(i=>i)}.   `}),C.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}};return(a,r)=>{const i=_("BaseInput"),D=_("Button");return a.detail?(I(),U("form",Ke,[d("div",Ye,[l(Le,{label:"Referència",modelValue:a.detail.referenceId,"onUpdate:modelValue":[r[0]||(r[0]=s=>a.detail.referenceId=s),r[1]||(r[1]=s=>c())],customerId:a.budget.customerId,fullName:!0},null,8,["modelValue","customerId"])]),d("section",null,[d("div",null,[l(i,{class:$(["mb-2",{"p-invalid":p.value.errors.description}]),label:"Descripció",modelValue:a.detail.description,"onUpdate:modelValue":r[2]||(r[2]=s=>a.detail.description=s),type:e(A).TEXT},null,8,["modelValue","type","class"])])]),d("section",Ze,[d("div",null,[l(i,{class:$(["mb-2",{"p-invalid":p.value.errors.quantity}]),label:"Quantitat",modelValue:a.detail.quantity,"onUpdate:modelValue":[r[3]||(r[3]=s=>a.detail.quantity=s),r[4]||(r[4]=s=>t())],type:e(A).NUMERIC},null,8,["modelValue","type","class"])]),d("div",null,[l(i,{class:$(["mb-2",{"p-invalid":p.value.errors.amount}]),label:"Total",modelValue:a.detail.amount,"onUpdate:modelValue":r[5]||(r[5]=s=>a.detail.amount=s),type:e(A).CURRENCY,disabled:""},null,8,["modelValue","type","class"])])]),l(D,{label:B.value,onClick:k,style:{float:"right"}},null,8,["label"])])):R("",!0)}}}),tt={class:"flex flex-wrap align-items-center justify-content-between gap-2"},at=d("span",{class:"text-l text-900 font-bold"},"Linies del pressupost",-1),ot="Línia del pressupost",ht=P({__name:"Budget",setup(w){const S=T(),u=T(g.EDIT),V=De(),C=we(),B=Ve(),c=X(),t=W(),y=se(),p=Re(),v=Be(),k=le(),a=Q(),r=xe(),i=ke(),D=Ne(),{budget:s}=oe(t),q=[{label:"Descarregar",icon:N.FILE_WORD,command:()=>L()},{label:"Crear comanda",icon:N.FLAG_FILL,command:()=>fe()}],L=async()=>{var o;const n=await Ae.Budget.GetReportDataById(s.value.id);if(n){const m=`Pressupost_${(o=s.value)==null?void 0:o.number}.docx`,F=await new $e().Download(n,he.Budget,m);F?Te(m,F):c.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla del pressupost"})}},E=T(!1),f=T(g.EDIT),O=T(void 0),j=T(0),ie=async()=>{const n=V.params.id;await t.GetById(n),await t.GetAssociatedSalesOrders(n),a.fetchReferencesByModule("sales"),k.fetchOneByName("Budget"),p.fetchSites(),v.fetchAll(),y.fetchCustomers(),i.fetchAll(),r.workmasters||r.fetchAllActives();let o="";s.value&&(u.value=g.EDIT,o=`Pressupost ${s.value.number}`),B.setMenuItem({icon:N.BUILDING,backButtonVisible:!0,title:o})};Ce(async()=>{await ie()});const de=()=>{S.value.submitForm()},H=(n,o)=>{a.setNewReference(G()),n===g.CREATE&&(o={id:G(),referenceId:"",quantity:0,unitCost:0,unitPrice:0,totalCost:0,amount:0,budgetId:s.value.id,description:""}),O.value=o,f.value=n,E.value=!0},ue=async n=>{let o=!1,m="";o=await t.Update(n.id,n),m=o?"Pressupost actualitzat correctament":"Error a l'actualitzar el pressupost",c.add({life:5e3,severity:o?"success":"error",summary:m}),o&&C.back()},ce=async n=>{f.value===g.CREATE?await t.CreateDetail(n):f.value===g.EDIT&&await t.UpdateDetail(n),E.value=!1},me=async n=>{u.value===g.EDIT&&await t.DeleteDetail(n);const o=s.value.details.filter(m=>m.id!==n.id);s.value.details=o,E.value=!1},pe=async n=>{let o=!1,m="";o=await a.createReference(n),o?m="Referència creada correctament":m="La referència + versió introduïda ja existeix",c.add({severity:o?"success":"warn",summary:m,life:5e3}),o&&(a.reference=void 0,a.setNewReference(G()),j.value=0)},fe=async()=>{var n,o;if(t.order){c.add({severity:"warn",summary:"Aquest pressupost ja té una comanda associada",life:5e3});return}if(s.value){const m=await D.CreateFromBudget(s.value);m.result?(c.add({severity:"success",summary:`Comanda ${(n=m.content)==null?void 0:n.number} creada correctament`,life:5e3}),C.push(`/salesorder/${(o=m.content)==null?void 0:o.id}`)):c.add({severity:"error",summary:"Error al crear la comanda ",detail:m.errors[0],life:5e3})}};return(n,o)=>{const m=_("SplitButton"),J=_("Button"),F=_("TabPanel"),K=_("TabView"),ve=_("Dialog");return I(),U(Ee,null,[l(m,{label:"Guardar",onClick:de,model:q,size:"small",class:"grid_add_row_button"}),l(Je,{class:"mt-3 mb-3",ref_key:"budgetForm",ref:S,onSubmit:ue},null,512),l(K,null,{default:b(()=>[l(F,{header:"Detall"},{default:b(()=>{var h;return[e(s)?(I(),x(Me,{key:0,budget:e(s),details:(h=e(s))==null?void 0:h.details,onEdit:o[1]||(o[1]=Y=>H(e(g).EDIT,Y)),onDelete:me},{header:b(()=>[d("div",tt,[at,d("section",null,[l(J,{size:"small",label:"Afegir línea",onClick:o[0]||(o[0]=Y=>H(e(g).CREATE,{})),class:"mr-2",disabled:e(t).order!==void 0},null,8,["disabled"])])])]),_:1},8,["budget","details"])):R("",!0)]}),_:1})]),_:1}),e(s)?(I(),x(ve,{key:0,closable:!0,visible:E.value,"onUpdate:visible":o[3]||(o[3]=h=>E.value=h),header:ot,modal:!0},{default:b(()=>[l(K,{activeIndex:j.value,"onUpdate:activeIndex":o[2]||(o[2]=h=>j.value=h)},{default:b(()=>[l(F,{header:"Línea"},{default:b(()=>[e(s)&&O.value?(I(),x(et,{key:0,formAction:f.value,budget:e(s),detail:O.value,onSubmit:ce},null,8,["formAction","budget","detail"])):R("",!0)]),_:1}),l(F,{header:"Referencia"},{default:b(()=>[e(a).reference?(I(),x(Fe,{key:0,module:"sales",reference:e(a).reference,"default-customer-id":e(s).customerId,onSubmit:pe},null,8,["reference","default-customer-id"])):R("",!0)]),_:1})]),_:1},8,["activeIndex"])]),_:1},8,["visible"])):R("",!0)],64)}}});export{ht as default};

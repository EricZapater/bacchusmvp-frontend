import{d as A,j as Y,z as G,o as j,r as N,h as b,a as k,c as U,k as l,e as u,i,n as C,s as B,y as ee,l as $,p as te,b as se,f as ae,J as H,F as D,m as P,w as S,P as z,C as L,D as M,v as le,g as oe,u as re,G as ie}from"./index-d48d4fc0.js";import{f as ne,e as de,g as J,c as ue}from"./functions-c791afc8.js";import{u as q}from"./salesOrder-928a03a5.js";import{u as ce}from"./customers-b101acfd.js";import{u as me}from"./exercise-c59cdccf.js";import{u as pe}from"./plantmodel-49478156.js";import{u as fe}from"./lifecycle-4a4dadbb.js";import{c as Q,a as x,F as X,d as ve}from"./form-validator-b82d2143.js";import{u as K}from"./reference-cb4deb3a.js";import"./v4-a960c1f4.js";import"./index-b6c8d1e4.js";import"./reference.service-262b883f.js";import"./base.service-890148bb.js";import"./index-212a1afb.js";const F=O=>(te("data-v-1ec4fffc"),O=O(),se(),O),be={key:0},De={class:"four-columns"},_e={class:"mt-1"},Oe=F(()=>u("label",{class:"block text-900 mb-2"},"Exercici",-1)),ye={class:"mt-1"},Ie={class:"mt-1"},Ve=F(()=>u("label",{class:"block text-900 mb-2"},"Data Comanda",-1)),Ce={class:"mt-1"},we=F(()=>u("label",{class:"block text-900 mb-2"},"Estat",-1)),Se={class:"two-columns"},Te={class:"mt-1"},ge=F(()=>u("label",{class:"block text-900 mb-2"},"Origen",-1)),Ee={class:"mt-1"},Ne=F(()=>u("label",{class:"block text-900 mb-2"},"Client",-1)),ke=A({__name:"FormSalesOrder",emits:["submit","cancel"],setup(O,{expose:_,emit:n}){const w=q(),y=ce(),I=pe(),m=me(),p=fe(),T=K(),d=Y(),{salesOrder:e}=G(w);j(async()=>{await I.fetchSites(),await m.fetchAll(),await y.fetchCustomers(),T.fetchReferences(),await p.fetchOneByName("SalesOrder"),e.value.salesOrderDate=ne(e.value.salesOrderDate)});const f=Q().shape({siteId:x().required("L'origen es obligatori"),customerId:x().required("El client es obligatori"),statusId:x().required("L'estat es obligatori"),exerciseId:x().required("L'exercici es obligatori")}),t=N({result:!1,errors:{}}),c=()=>{const s=new X(f);t.value=s.validate(e.value)};_({submitForm:async()=>{if(c(),t.value.result)e.value.salesOrderDate=de(e.value.salesOrderDate),n("submit",e.value);else{let s="";Object.entries(t.value.errors).forEach(o=>{s+=`${o[1].map(a=>a)}.   `}),d.add({severity:"warn",summary:"Formulari inválid",detail:s,life:5e3})}}});const E=()=>{var o;const s=(o=y.customers)==null?void 0:o.find(a=>{var r;return a.id===((r=e.value)==null?void 0:r.customerId)});s&&e.value&&(e.value.customerCode=s.code,e.value.customerComercialName=s.comercialName,e.value.customerTaxName=s.taxName,e.value.customerVatNumber=s.vatNumber,e.value.customerAccountNumber=s.accountNumber),console.log(e.value)},R=()=>{var o;const s=(o=I.sites)==null?void 0:o.find(a=>{var r;return a.id===((r=e.value)==null?void 0:r.siteId)});s&&e.value&&(e.value.name=s.name,e.value.address=s.address,e.value.city=s.city,e.value.postalCode=s.postalCode,e.value.region=s.region,e.value.country=s.country,e.value.vatNumber=s.vatNumber)};return(s,o)=>{var V;const a=b("Dropdown"),r=b("Calendar");return k(),U("div",null,[l(e)?(k(),U("form",be,[u("section",De,[u("div",_e,[Oe,i(a,{modelValue:l(e).exerciseId,"onUpdate:modelValue":o[0]||(o[0]=v=>l(e).exerciseId=v),editable:"",options:l(m).exercises,optionValue:"id",optionLabel:"name",class:C(["w-full",{"p-invalid":t.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),u("div",ye,[i(ee,{type:l(B).TEXT,label:"Num. Comanda",id:"salesOrderNumber",modelValue:l(e).salesOrderNumber,"onUpdate:modelValue":o[1]||(o[1]=v=>l(e).salesOrderNumber=v),disabled:""},null,8,["type","modelValue"])]),u("div",Ie,[Ve,i(r,{id:"salesOrderDate",modelValue:l(e).salesOrderDate,"onUpdate:modelValue":o[2]||(o[2]=v=>l(e).salesOrderDate=v),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),u("div",Ce,[we,i(a,{modelValue:l(e).statusId,"onUpdate:modelValue":o[3]||(o[3]=v=>l(e).statusId=v),editable:"",options:(V=l(p).lifecycle)==null?void 0:V.statuses,optionValue:"id",optionLabel:"name",class:C(["w-full",{"p-invalid":t.value.errors.statusId}])},null,8,["modelValue","options","class"])])]),u("section",Se,[u("div",Te,[ge,i(a,{modelValue:l(e).siteId,"onUpdate:modelValue":[o[4]||(o[4]=v=>l(e).siteId=v),o[5]||(o[5]=v=>R())],editable:"",options:l(I).sites,optionValue:"id",optionLabel:"name",class:C(["w-full",{"p-invalid":t.value.errors.siteId}])},null,8,["modelValue","options","class"])]),u("div",Ee,[Ne,i(a,{modelValue:l(e).customerId,"onUpdate:modelValue":[o[6]||(o[6]=v=>l(e).customerId=v),o[7]||(o[7]=v=>E())],editable:"",options:l(y).customers,optionValue:"id",optionLabel:"comercialName",class:C(["w-full",{"p-invalid":t.value.errors.customerId}])},null,8,["modelValue","options","class"])])])])):$("",!0)])}}});const Re=ae(ke,[["__scopeId","data-v-1ec4fffc"]]),he={key:0},Fe={class:"three-columns"},xe=u("label",{class:"block text-900 mb-2"},"Referència",-1),Be=A({__name:"FormSalesOrderReference",props:{formAction:{},salesOrderDetail:{}},emits:["submit"],setup(O,{emit:_}){const n=O;q();const w=K(),y=Y(),I=H(()=>n.formAction===D.CREATE?"Afegir":"Modificar"),m=()=>{const t=w.references.find(c=>c.id===n.salesOrderDetail.referenceId);t&&(n.salesOrderDetail.description=t==null?void 0:t.description,n.salesOrderDetail.isInvoiced=!1,n.salesOrderDetail.isServed=!1,n.salesOrderDetail.unitCost=t==null?void 0:t.cost,n.salesOrderDetail.unitPrice=t==null?void 0:t.price,p())},p=()=>{n.salesOrderDetail.amount=n.salesOrderDetail.unitPrice*n.salesOrderDetail.quantity,n.salesOrderDetail.totalCost=n.salesOrderDetail.unitCost*n.salesOrderDetail.quantity},T=Q().shape({quantity:ve().required("La quantitat és obligatoria").min(1,"La quantitat ha de ser un número positiu")}),d=N({result:!1,errors:{}}),e=()=>{const t=new X(T);d.value=t.validate(n.salesOrderDetail)},f=async()=>{if(e(),d.value.result)_("submit",n.salesOrderDetail);else{let t="";Object.entries(d.value.errors).forEach(c=>{t+=`${c[1].map(g=>g)}.   `}),y.add({severity:"warn",summary:"Formulari inválid",detail:t,life:5e3})}};return(t,c)=>{const g=b("Dropdown"),E=b("BaseInput"),R=b("Button");return t.salesOrderDetail?(k(),U("form",he,[u("section",Fe,[u("div",null,[xe,i(g,{modelValue:t.salesOrderDetail.referenceId,"onUpdate:modelValue":[c[0]||(c[0]=s=>t.salesOrderDetail.referenceId=s),c[1]||(c[1]=s=>m())],editable:"",options:l(w).references,optionValue:"id",optionLabel:"description",class:C(["w-full",{"p-invalid":d.value.errors.referenceId}])},null,8,["modelValue","options","class"])]),u("div",null,[i(E,{class:C(["mb-2",{"p-invalid":d.value.errors.quantity}]),label:"Quantitat",modelValue:t.salesOrderDetail.quantity,"onUpdate:modelValue":[c[2]||(c[2]=s=>t.salesOrderDetail.quantity=s),c[3]||(c[3]=s=>p())],type:l(B).NUMERIC},null,8,["modelValue","type","class"])]),u("div",null,[i(E,{class:C(["mb-2",{"p-invalid":d.value.errors.amount}]),label:"Total",modelValue:t.salesOrderDetail.amount,"onUpdate:modelValue":c[4]||(c[4]=s=>t.salesOrderDetail.amount=s),type:l(B).CURRENCY,disabled:""},null,8,["modelValue","type","class"])])]),u("section",null,[u("div",null,[i(E,{class:C(["mb-2",{"p-invalid":d.value.errors.description}]),label:"Descripció",modelValue:t.salesOrderDetail.description,"onUpdate:modelValue":c[5]||(c[5]=s=>t.salesOrderDetail.description=s),type:l(B).TEXT},null,8,["modelValue","type","class"])])]),i(R,{label:I.value,onClick:f,style:{float:"right"}},null,8,["label"])])):$("",!0)}}}),Ue=["onClick"],$e=A({__name:"TableSalesOrderReferences",props:{salesOrderDetails:{}},emits:["add","edit","delete"],setup(O,{emit:_}){const n=O;q();const w=()=>{const m={id:J(),referenceId:"",quantity:0,unitCost:0,unitPrice:0,totalCost:0,amount:0,salesOrderHeaderId:"",description:"",estimatedDeliveryDate:new Date,isServerd:!1,isInvoiced:!1};_("add",m)},y=m=>{m.originalEvent.target.className.includes("grid_delete_column_button")||_("edit",m.data)},I=(m,p)=>{_("delete",p)};return(m,p)=>{const T=b("Button"),d=b("Column"),e=b("DataTable");return k(),P(e,{onRowClick:y,value:n.salesOrderDetails,tableStyle:"min-width: 100%"},{default:S(()=>[i(T,{onClick:w,rounded:"",icon:l(z).PLUS,class:"grid_add_row_button",style:{"margin-right":"1.5rem"}},null,8,["icon"]),i(d,{field:"quantity",header:"Quantitat",style:{width:"10%"}}),i(d,{field:"description",header:"Descripció",style:{width:"30%"}}),i(d,{field:"unitCost",header:"Cost un.",style:{width:"10%"}},{body:S(f=>[L(M(f.data.unitCost)+" € ",1)]),_:1}),i(d,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:S(f=>[L(M(f.data.unitPrice)+" € ",1)]),_:1}),i(d,{field:"amount",header:"Total",style:{width:"10%"}},{body:S(f=>[L(M(f.data.amount)+" € ",1)]),_:1}),i(d,{style:{width:"10%"}},{body:S(f=>[u("i",{class:C([l(z).TIMES,"grid_delete_column_button"]),onClick:t=>I(t,f.data)},null,10,Ue)]),_:1})]),_:1},8,["value"])}}}),We=A({__name:"SalesOrder",setup(O){const _=N(),n=N(D.EDIT),w=le(),y=oe(),I=re(),m=q(),{salesOrder:p}=G(m),T=H(()=>e.value===D.CREATE?"Escull referència":"Modifica referència"),d=N(!1),e=N(D.EDIT),f=N(void 0),t=async()=>{await m.GetById(w.params.id);let a="";p.value&&(n.value=D.EDIT,a=`Comanda ${p.value.salesOrderNumber}`),I.setMenuItem({icon:z.BUILDING,backButtonVisible:!0,title:a})};j(async()=>{await t()});const c=()=>{_.value.submitForm()},g=(a,r)=>{a===D.CREATE&&(r.id=J()),r.salesOrderHeaderId=p.value.id,f.value=r,e.value=a,d.value=!0},E=Y(),R=async a=>{let r=!1,V="";a.salesOrderDate=ue(new Date(a.salesOrderDate)),r=await m.Update(a.id,a),V=r?"Comanda actualitzada":"Error a l'actualitzar la comanda",E.add({life:5e3,severity:r?"success":"error",summary:V}),r&&y.back()},s=async a=>{e.value===D.CREATE?await m.CreateDetail(a):e.value===D.EDIT&&await m.UpdateDetail(a),d.value=!1},o=async a=>{n.value===D.EDIT&&await m.DeleteDetail(a);const r=p.value.salesOrderDetails.filter(V=>V.id!==a.id);p.value.salesOrderDetails=r,d.value=!1};return(a,r)=>{const V=b("Button"),v=b("TabPanel"),W=b("TabView"),Z=b("Dialog");return k(),U(ie,null,[i(V,{label:"Guardar",class:"grid_add_row_button",size:"small",onClick:c}),i(Re,{class:"mt-3",ref_key:"salesOrderForm",ref:_,salesOrder:"salesOrder",onSubmit:R},null,512),i(W,null,{default:S(()=>[i(v,{header:"Referències"},{default:S(()=>[l(p)?(k(),P($e,{key:0,salesOrderDetails:l(p).salesOrderDetails,onAdd:r[0]||(r[0]=h=>g(l(D).CREATE,h)),onEdit:r[1]||(r[1]=h=>g(l(D).EDIT,h)),onDelete:o},null,8,["salesOrderDetails"])):$("",!0)]),_:1})]),_:1}),i(Z,{closable:!0,visible:d.value,"onUpdate:visible":r[2]||(r[2]=h=>d.value=h),header:T.value,modal:!0},{default:S(()=>[f.value?(k(),P(Be,{key:0,formAction:e.value,salesOrderDetail:f.value,onSubmit:s},null,8,["formAction","salesOrderDetail"])):$("",!0)]),_:1},8,["visible","header"])],64)}}});export{We as default};

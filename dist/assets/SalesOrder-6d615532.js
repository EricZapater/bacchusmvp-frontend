import{d as q,j as P,z as X,o as H,r as h,h as b,a as T,c as R,k as s,e as u,i,n as w,s as B,y as j,l as $,p as te,b as ae,f as se,J,w as O,D,F as _,m as z,P as G,C as M,v as le,g as oe,u as re,G as ie}from"./index-975a47bd.js";import{c as ne,g as Q}from"./functions-13b40d42.js";import{u as L}from"./salesOrder-1cf8589f.js";import{u as de}from"./customers-779b4bb9.js";import{u as ue}from"./exercise-9dcb5a74.js";import{u as ce}from"./plantmodel-c408ffcb.js";import{u as me}from"./lifecycle-58823bbb.js";import{c as Y,a as A,F as K,d as pe}from"./form-validator-8b6c2b5b.js";import{u as W}from"./reference-81bc0611.js";import"./v4-a960c1f4.js";import"./index-21a0cc36.js";import"./reference.service-beea0f30.js";import"./base.service-b690a68e.js";import"./index-790bf15b.js";const U=V=>(te("data-v-603c3a8c"),V=V(),ae(),V),ve={key:0},fe={class:"four-columns"},be={class:"mt-1"},_e=U(()=>u("label",{class:"block text-900 mb-2"},"Exercici",-1)),De={class:"mt-1"},ye={class:"mt-1"},Oe=U(()=>u("label",{class:"block text-900 mb-2"},"Data Comanda",-1)),Ve={class:"mt-1"},Ie=U(()=>u("label",{class:"block text-900 mb-2"},"Estat",-1)),Se={class:"three-columns"},Ce={class:"mt-1"},we=U(()=>u("label",{class:"block text-900 mb-2"},"Origen",-1)),Te={class:"mt-1"},ge=U(()=>u("label",{class:"block text-900 mb-2"},"Client",-1)),Ee={class:"mt-1"},Ne=q({__name:"FormSalesOrder",emits:["submit","cancel"],setup(V,{expose:y,emit:n}){const g=L(),I=de(),S=ce(),m=ue(),f=me(),E=W(),d=P(),{salesOrder:e}=X(g);H(async()=>{await S.fetchSites(),await m.fetchAll(),await I.fetchCustomers(),E.fetchReferences(),await f.fetchOneByName("SalesOrder")});const p=Y().shape({siteId:A().required("L'origen es obligatori"),customerId:A().required("El client es obligatori"),statusId:A().required("L'estat es obligatori"),exerciseId:A().required("L'exercici es obligatori")}),a=h({result:!1,errors:{}}),c=()=>{const t=new K(p);a.value=t.validate(e.value)};y({submitForm:async()=>{if(c(),a.value.result)e.value.salesOrderDate=ne(e.value.salesOrderDate),n("submit",e.value);else{let t="";Object.entries(a.value.errors).forEach(l=>{t+=`${l[1].map(o=>o)}.   `}),d.add({severity:"warn",summary:"Formulari inválid",detail:t,life:5e3})}}});const k=()=>{var l;const t=(l=I.customers)==null?void 0:l.find(o=>{var r;return o.id===((r=e.value)==null?void 0:r.customerId)});t&&e.value&&(e.value.customerCode=t.code,e.value.customerComercialName=t.comercialName,e.value.customerTaxName=t.taxName,e.value.customerVatNumber=t.vatNumber,e.value.customerAccountNumber=t.accountNumber),console.log(e.value)},x=()=>{var l;const t=(l=S.sites)==null?void 0:l.find(o=>{var r;return o.id===((r=e.value)==null?void 0:r.siteId)});t&&e.value&&(e.value.name=t.name,e.value.address=t.address,e.value.city=t.city,e.value.postalCode=t.postalCode,e.value.region=t.region,e.value.country=t.country,e.value.vatNumber=t.vatNumber)};return(t,l)=>{var C;const o=b("Dropdown"),r=b("Calendar");return T(),R("div",null,[s(e)?(T(),R("form",ve,[u("section",fe,[u("div",be,[_e,i(o,{modelValue:s(e).exerciseId,"onUpdate:modelValue":l[0]||(l[0]=v=>s(e).exerciseId=v),editable:"",options:s(m).exercises,optionValue:"id",optionLabel:"name",class:w(["w-full",{"p-invalid":a.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),u("div",De,[i(j,{type:s(B).TEXT,label:"Num. Comanda",id:"salesOrderNumber",modelValue:s(e).salesOrderNumber,"onUpdate:modelValue":l[1]||(l[1]=v=>s(e).salesOrderNumber=v),disabled:""},null,8,["type","modelValue"])]),u("div",ye,[Oe,i(r,{modelValue:s(e).salesOrderDate,"onUpdate:modelValue":l[2]||(l[2]=v=>s(e).salesOrderDate=v),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),u("div",Ve,[Ie,i(o,{modelValue:s(e).statusId,"onUpdate:modelValue":l[3]||(l[3]=v=>s(e).statusId=v),editable:"",options:(C=s(f).lifecycle)==null?void 0:C.statuses,optionValue:"id",optionLabel:"name",class:w(["w-full",{"p-invalid":a.value.errors.statusId}])},null,8,["modelValue","options","class"])])]),u("section",Se,[u("div",Ce,[we,i(o,{modelValue:s(e).siteId,"onUpdate:modelValue":[l[4]||(l[4]=v=>s(e).siteId=v),l[5]||(l[5]=v=>x())],editable:"",options:s(S).sites,optionValue:"id",optionLabel:"name",class:w(["w-full",{"p-invalid":a.value.errors.siteId}])},null,8,["modelValue","options","class"])]),u("div",Te,[ge,i(o,{modelValue:s(e).customerId,"onUpdate:modelValue":[l[6]||(l[6]=v=>s(e).customerId=v),l[7]||(l[7]=v=>k())],editable:"",options:s(I).customers,optionValue:"id",optionLabel:"comercialName",class:w(["w-full",{"p-invalid":a.value.errors.customerId}])},null,8,["modelValue","options","class"])]),u("div",Ee,[i(j,{type:s(B).TEXT,label:"Comanda Client",id:"customerSalesOrderNumber",modelValue:s(e).customerSalesOrderNumber,"onUpdate:modelValue":l[8]||(l[8]=v=>s(e).customerSalesOrderNumber=v)},null,8,["type","modelValue"])])])])):$("",!0)])}}});const ke=se(Ne,[["__scopeId","data-v-603c3a8c"]]),he={key:0},Re={class:"three-columns"},$e=u("label",{class:"block text-900 mb-2"},"Referència",-1),xe={key:0,class:"flex align-items-center"},Fe={key:0,class:"flex align-items-center"},Be=q({__name:"FormSalesOrderReference",props:{formAction:{},salesOrderDetail:{}},emits:["submit"],setup(V,{emit:y}){const n=V;L();const g=W(),I=P(),S=J(()=>n.formAction===_.CREATE?"Afegir":"Modificar"),m=()=>{const a=g.references.find(c=>c.id===n.salesOrderDetail.referenceId);a&&(n.salesOrderDetail.description=`${a.code} (${a.version}) - ${a.description}`,n.salesOrderDetail.isInvoiced=!1,n.salesOrderDetail.isServed=!1,n.salesOrderDetail.unitCost=a==null?void 0:a.cost,n.salesOrderDetail.unitPrice=a==null?void 0:a.price,f())},f=()=>{n.salesOrderDetail.amount=n.salesOrderDetail.unitPrice*n.salesOrderDetail.quantity,n.salesOrderDetail.totalCost=n.salesOrderDetail.unitCost*n.salesOrderDetail.quantity},E=Y().shape({quantity:pe().required("La quantitat és obligatoria").min(1,"La quantitat ha de ser un número positiu")}),d=h({result:!1,errors:{}}),e=()=>{const a=new K(E);d.value=a.validate(n.salesOrderDetail)},p=async()=>{if(e(),d.value.result)y("submit",n.salesOrderDetail);else{let a="";Object.entries(d.value.errors).forEach(c=>{a+=`${c[1].map(N=>N)}.   `}),I.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}};return(a,c)=>{const N=b("Dropdown"),k=b("BaseInput"),x=b("Button");return a.salesOrderDetail?(T(),R("form",he,[u("section",Re,[u("div",null,[$e,i(N,{modelValue:a.salesOrderDetail.referenceId,"onUpdate:modelValue":[c[0]||(c[0]=t=>a.salesOrderDetail.referenceId=t),c[1]||(c[1]=t=>m())],editable:"",options:s(g).references,optionValue:"id",optionLabel:"description",class:w(["w-full",{"p-invalid":d.value.errors.referenceId}])},{value:O(t=>[t.value?(T(),R("div",xe,D(t.value.code)+" ("+D(t.value.version)+") - "+D(t.value.description),1)):$("",!0)]),option:O(t=>[t.option?(T(),R("div",Fe,D(t.option.code)+" ("+D(t.option.version)+") - "+D(t.option.description),1)):$("",!0)]),_:1},8,["modelValue","options","class"])]),u("div",null,[i(k,{class:w(["mb-2",{"p-invalid":d.value.errors.quantity}]),label:"Quantitat",modelValue:a.salesOrderDetail.quantity,"onUpdate:modelValue":[c[2]||(c[2]=t=>a.salesOrderDetail.quantity=t),c[3]||(c[3]=t=>f())],type:s(B).NUMERIC},null,8,["modelValue","type","class"])]),u("div",null,[i(k,{class:w(["mb-2",{"p-invalid":d.value.errors.amount}]),label:"Total",modelValue:a.salesOrderDetail.amount,"onUpdate:modelValue":c[4]||(c[4]=t=>a.salesOrderDetail.amount=t),type:s(B).CURRENCY,disabled:""},null,8,["modelValue","type","class"])])]),u("section",null,[u("div",null,[i(k,{class:w(["mb-2",{"p-invalid":d.value.errors.description}]),label:"Descripció",modelValue:a.salesOrderDetail.description,"onUpdate:modelValue":c[5]||(c[5]=t=>a.salesOrderDetail.description=t),type:s(B).TEXT},null,8,["modelValue","type","class"])])]),i(x,{label:S.value,onClick:p,style:{float:"right"}},null,8,["label"])])):$("",!0)}}}),Ue=["onClick"],Ae=q({__name:"TableSalesOrderReferences",props:{salesOrderDetails:{}},emits:["add","edit","delete"],setup(V,{emit:y}){const n=V;L();const g=()=>{const m={id:Q(),referenceId:"",quantity:0,unitCost:0,unitPrice:0,totalCost:0,amount:0,salesOrderHeaderId:"",description:"",estimatedDeliveryDate:new Date,isServerd:!1,isInvoiced:!1};y("add",m)},I=m=>{m.originalEvent.target.className.includes("grid_delete_column_button")||y("edit",m.data)},S=(m,f)=>{y("delete",f)};return(m,f)=>{const E=b("Button"),d=b("Column"),e=b("DataTable");return T(),z(e,{onRowClick:I,value:n.salesOrderDetails,tableStyle:"min-width: 100%"},{default:O(()=>[i(E,{onClick:g,rounded:"",icon:s(G).PLUS,class:"grid_add_row_button",style:{"margin-right":"1.5rem"}},null,8,["icon"]),i(d,{field:"quantity",header:"Quantitat",style:{width:"10%"}}),i(d,{header:"Referencia",style:{width:"25%"}},{body:O(p=>[M(D(p.data.reference.code)+" ("+D(p.data.reference.version)+") - "+D(p.data.reference.description),1)]),_:1}),i(d,{field:"description",header:"Descripció",style:{width:"25%"}}),i(d,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:O(p=>[M(D(p.data.unitPrice)+" € ",1)]),_:1}),i(d,{field:"amount",header:"Total",style:{width:"10%"}},{body:O(p=>[M(D(p.data.amount)+" € ",1)]),_:1}),i(d,{style:{width:"10%"}},{body:O(p=>[u("i",{class:w([s(G).TIMES,"grid_delete_column_button"]),onClick:a=>S(a,p.data)},null,10,Ue)]),_:1})]),_:1},8,["value"])}}}),Ze=q({__name:"SalesOrder",setup(V){const y=h(),n=h(_.EDIT),g=le(),I=oe(),S=re(),m=L(),{salesOrder:f}=X(m),E=J(()=>e.value===_.CREATE?"Escull referència":"Modifica referència"),d=h(!1),e=h(_.EDIT),p=h(void 0),a=async()=>{await m.GetById(g.params.id);let o="";f.value&&(n.value=_.EDIT,o=`Comanda ${f.value.salesOrderNumber}`),S.setMenuItem({icon:G.BUILDING,backButtonVisible:!0,title:o})};H(async()=>{await a()});const c=()=>{y.value.submitForm()},N=(o,r)=>{o===_.CREATE&&(r.id=Q()),r.salesOrderHeaderId=f.value.id,p.value=r,e.value=o,d.value=!0},k=P(),x=async o=>{let r=!1,C="";r=await m.Update(o.id,o),C=r?"Comanda actualitzada":"Error a l'actualitzar la comanda",k.add({life:5e3,severity:r?"success":"error",summary:C}),r&&I.back()},t=async o=>{e.value===_.CREATE?await m.CreateDetail(o):e.value===_.EDIT&&await m.UpdateDetail(o),d.value=!1},l=async o=>{n.value===_.EDIT&&await m.DeleteDetail(o);const r=f.value.salesOrderDetails.filter(C=>C.id!==o.id);f.value.salesOrderDetails=r,d.value=!1};return(o,r)=>{const C=b("Button"),v=b("TabPanel"),Z=b("TabView"),ee=b("Dialog");return T(),R(ie,null,[i(C,{label:"Guardar",class:"grid_add_row_button",size:"small",onClick:c}),i(ke,{class:"mt-3",ref_key:"salesOrderForm",ref:y,salesOrder:"salesOrder",onSubmit:x},null,512),i(Z,null,{default:O(()=>[i(v,{header:"Referències"},{default:O(()=>[s(f)?(T(),z(Ae,{key:0,salesOrderDetails:s(f).salesOrderDetails,onAdd:r[0]||(r[0]=F=>N(s(_).CREATE,F)),onEdit:r[1]||(r[1]=F=>N(s(_).EDIT,F)),onDelete:l},null,8,["salesOrderDetails"])):$("",!0)]),_:1})]),_:1}),i(ee,{closable:!0,visible:d.value,"onUpdate:visible":r[2]||(r[2]=F=>d.value=F),header:E.value,modal:!0},{default:O(()=>[p.value?(T(),z(Be,{key:0,formAction:e.value,salesOrderDetail:p.value,onSubmit:t},null,8,["formAction","salesOrderDetail"])):$("",!0)]),_:1},8,["visible","header"])],64)}}});export{Ze as default};

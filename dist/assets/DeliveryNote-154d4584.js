import{d as M,r as V,H as L,h as S,a as I,m as B,w as h,e as s,C as k,i as l,k as c,P as z,D as w,p as q,b as j,f as H,j as K,c as $,n as T,y as G,l as E,s as se,L as le,F as A,v as oe,g as ae,u as re,z as ie,o as de,G as ne}from"./index-9ee31eec.js";import{f as F,c as ue}from"./functions-afe9fe15.js";import{u as P}from"./customers-a1aa4021.js";import{u as Q}from"./plantmodel-0c53976d.js";import{u as J}from"./lifecycle-decdfcd8.js";import{u as ce}from"./masterData-d4b7f3a7.js";import{c as me,a as x,F as ve}from"./form-validator-7a510593.js";import{u as pe}from"./reference-b31f5c29.js";import{u as fe}from"./deliveryNote-901a3a5d.js";import{u as ye}from"./order-ed4d5f60.js";import"./v4-a960c1f4.js";import"./base.service-aa9daa2d.js";import"./index-e87db629.js";import"./reference.service-8d98e13b.js";import"./index-834c5157.js";const be=m=>(q("data-v-1baead78"),m=m(),j(),m),_e={class:"selector-filter"},he={class:"selector-filter-field"},De=be(()=>s("label",{for:""},"Buscar",-1)),Ne={class:"selector-filter-button"},Se={class:"flex align-items-center gap-2"},Oe=M({__name:"SelectorOrders",props:{orders:{},headerVisible:{type:Boolean}},emits:["selected"],setup(m,{emit:O}){const p=m,v=V([]),D=V(""),b=L(()=>{var t=[];return p.orders&&(t=p.orders.filter(o=>o.salesOrderNumber.toString().includes(D.value)||o.customerSalesOrderNumber.includes(D.value))),t}),a=()=>{if(v.value.length===0)return;const t=v.value;O("selected",t)};return(t,o)=>{const d=S("InputText"),f=S("Button"),_=S("Column"),n=S("DataTable");return I(),B(n,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",metaKeySelection:!1,value:b.value,selectionMode:"multiple",selection:v.value,"onUpdate:selection":o[1]||(o[1]=e=>v.value=e)},{header:h(()=>[s("header",_e,[s("div",he,[De,k("   "),l(d,{style:{width:"150px",height:"35px"},modelValue:D.value,"onUpdate:modelValue":o[0]||(o[0]=e=>D.value=e),size:"small"},null,8,["modelValue"])]),s("div",Ne,[l(f,{onClick:a,size:"small",icon:c(z).CHECK_SQUARE},null,8,["icon"])])])]),groupheader:h(e=>[s("div",Se,[s("b",null,"Comanda "+w(e.data.salesOrderNumber)+" - "+w(c(F)(e.data.salesOrderDate)),1)])]),default:h(()=>[l(_,{header:"Número",field:"salesOrderNumber",style:{width:"10%"}}),l(_,{header:"Número client",field:"customerSalesOrderNumber",style:{width:"20%"}}),l(_,{header:"Data",field:"salesOrderDate",style:{width:"10%"}},{body:h(e=>[k(w(c(F)(e.data.salesOrderDate)),1)]),_:1})]),_:1},8,["value","selection"])}}});const we=H(Oe,[["__scopeId","data-v-1baead78"]]),U=m=>(q("data-v-d63138a7"),m=m(),j(),m),Ie={key:0},ge={class:"three-columns"},Ve={class:"mt-1"},Ce=U(()=>s("label",{class:"block text-900 mb-2"},"Exercici",-1)),Te={class:"mt-1"},ke={class:"mt-2"},xe={class:"three-columns"},Be={class:"mt-2"},$e=U(()=>s("label",{class:"block text-900 mb-2"},"Estat",-1)),Ee={class:"mt-2"},Fe=U(()=>s("label",{class:"block text-900 mb-2"},"Origen",-1)),Me={class:"mt-2"},Ue=U(()=>s("label",{class:"block text-900 mb-2"},"Client",-1)),Le=M({__name:"FormDeliveryNote",props:{deliveryNote:{}},emits:["submit","cancel"],setup(m,{expose:O,emit:p}){const v=m,D=P(),b=Q(),a=ce(),t=J(),o=K(),d=me().shape({siteId:x().required("L'origen es obligatori"),customerId:x().required("El client es obligatori"),statusId:x().required("L'estat es obligatori"),exerciseId:x().required("L'exercici es obligatori")}),f=V({result:!1,errors:{}}),_=()=>{const e=new ve(d);f.value=e.validate(v.deliveryNote)};return O({submitForm:async()=>{if(_(),f.value.result)v.deliveryNote.deliveryDate&&(v.deliveryNote.deliveryDate=ue(v.deliveryNote.deliveryDate)),p("submit",v.deliveryNote);else{let e="";Object.entries(f.value.errors).forEach(i=>{e+=`${i[1].map(N=>N)}.   `}),o.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}}}),(e,i)=>{var C;const N=S("Dropdown");return I(),$("div",null,[e.deliveryNote?(I(),$("form",Ie,[s("section",ge,[s("div",Ve,[Ce,l(N,{modelValue:e.deliveryNote.exerciseId,"onUpdate:modelValue":i[0]||(i[0]=y=>e.deliveryNote.exerciseId=y),editable:"",options:c(a).exercises,optionValue:"id",optionLabel:"name",class:T(["w-full",{"p-invalid":f.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),s("div",Te,[l(G,{type:c(se).TEXT,label:"Num. Comanda",id:"salesOrderNumber",modelValue:e.deliveryNote.number,"onUpdate:modelValue":i[1]||(i[1]=y=>e.deliveryNote.number=y),disabled:""},null,8,["type","modelValue"])]),s("div",ke,[l(G,{modelValue:e.deliveryNote.deliveryDate,"onUpdate:modelValue":i[2]||(i[2]=y=>e.deliveryNote.deliveryDate=y),label:"Data Entrega",disabled:!0},null,8,["modelValue"])])]),s("section",xe,[s("div",Be,[$e,l(N,{modelValue:e.deliveryNote.statusId,"onUpdate:modelValue":i[3]||(i[3]=y=>e.deliveryNote.statusId=y),editable:"",options:(C=c(t).lifecycle)==null?void 0:C.statuses,optionValue:"id",optionLabel:"name",class:T(["w-full",{"p-invalid":f.value.errors.statusId}])},null,8,["modelValue","options","class"])]),s("div",Ee,[Fe,l(N,{modelValue:e.deliveryNote.siteId,"onUpdate:modelValue":i[4]||(i[4]=y=>e.deliveryNote.siteId=y),editable:"",options:c(b).sites,optionValue:"id",optionLabel:"name",class:T(["w-full",{"p-invalid":f.value.errors.siteId}])},null,8,["modelValue","options","class"])]),s("div",Me,[Ue,l(N,{modelValue:e.deliveryNote.customerId,"onUpdate:modelValue":i[5]||(i[5]=y=>e.deliveryNote.customerId=y),editable:"",options:c(D).customers,optionValue:"id",optionLabel:"comercialName",class:T(["w-full",{"p-invalid":f.value.errors.customerId}])},null,8,["modelValue","options","class"])])])])):E("",!0)])}}});const ze=H(Le,[["__scopeId","data-v-d63138a7"]]),Re={class:"vertical-align-middle ml-2 font-bold line-height-3"},Ge=["onClick"],Ae=M({__name:"TableDeliveryNoteDetails",props:{orders:{},canDelete:{type:Boolean}},emits:["delete"],setup(m,{emit:O}){const p=m,v=L(()=>{if(!p.orders)return[];let b=[];for(let a=0;a<p.orders.length;a++){if(!p.orders[a].salesOrderDetails)continue;const t=p.orders[a];t.salesOrderDetails.forEach(o=>{b.push({salesOrderId:t.id,salesOrderNumber:t.salesOrderNumber,salesOrderDate:t.salesOrderDate,...o})})}return b}),D=(b,a)=>{var o;if(!p.orders)return;const t=(o=p.orders)==null?void 0:o.find(d=>d.id===a.salesOrderId);t&&O("delete",t)};return(b,a)=>{const t=S("Column"),o=S("DataTable");return I(),B(o,{value:v.value,tableStyle:"min-width: 100%",class:"p-datatable-sm",rowGroupMode:"subheader",groupRowsBy:"salesOrderNumber"},{header:h(()=>[le(b.$slots,"header")]),groupheader:h(d=>[s("span",Re,"Comanda "+w(d.data.salesOrderNumber)+" ("+w(d.data.customerOrderNumber)+") "+w(c(F)(d.data.salesOrderDate)),1),k("   "),b.canDelete?(I(),$("i",{key:0,class:T([c(z).TIMES,"grid_delete_column_button"]),onClick:f=>D(f,d.data)},null,10,Ge)):E("",!0)]),default:h(()=>[l(t,{field:"salesOrderNumber",header:"Comanda",style:{width:"5%"}}),l(t,{field:"",header:"",style:{width:"5%"}}),l(t,{field:"quantity",header:"Quantitat",style:{width:"10%"}}),l(t,{field:"description",header:"Descripció",style:{width:"25%"}}),l(t,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:h(d=>[k(w(d.data.unitPrice)+" € ",1)]),_:1}),l(t,{field:"amount",header:"Total",style:{width:"10%"}},{body:h(d=>[k(w(d.data.amount)+" € ",1)]),_:1})]),_:3},8,["value"])}}}),qe={class:"flex flex-wrap align-items-center justify-content-between gap-2"},je=s("span",{class:"text-l text-900 font-bold"},"Linies de l'albarà",-1),He="Selector de comandes",it=M({__name:"DeliveryNote",setup(m){const O=V(),p=V(A.EDIT),v=oe(),D=ae(),b=re(),a=fe(),t=ye(),o=P(),d=Q(),f=pe(),_=J(),{deliveryNote:n}=ie(a),e=V(!1),i=V(""),N=L(()=>{if(!_.lifecycle||!_.lifecycle.statuses)return!1;const u=_.lifecycle.statuses.find(r=>r.name==="Entregat");return u?u.id!==i.value:!1}),C=async()=>{const u=v.params.id;await a.GetById(u),i.value=a.deliveryNote.statusId,await t.GetByDeliveryNote(u),f.fetchReferencesByModule("sales"),d.fetchSites(),o.customers||o.fetchCustomers(),_.lifecycle||_.fetchOneByName("DeliveryNote");let r="";n.value&&(p.value=A.EDIT,r=`Albará d'entrega ${n.value.number}`,n.value.deliveryDate&&(n.value.deliveryDate=F(n.value.deliveryDate))),b.setMenuItem({icon:z.BUILDING,backButtonVisible:!0,title:r})};de(async()=>{await C()});const y=()=>{O.value.submitForm()},X=K(),W=async u=>{let r=!1,g="";r=await a.Update(u.id,u),g=r?"Albarà actualitzat":"Error al actualitzar l'albarà",X.add({life:5e3,severity:r?"success":"error",summary:g}),r&&D.back()},Y=async()=>{n.value&&await t.GetToDeliver(n.value.customerId),e.value=!0},Z=async u=>{for(let r=0;r<u.length;r++){const g=u[r];await a.AddOrder(n.value.id,g)}e.value=!1,C()},ee=async u=>{await a.DeleteOrder(n.value.id,u),C()};return(u,r)=>{const g=S("Button"),te=S("Dialog");return I(),$(ne,null,[l(g,{label:"Guardar",class:"grid_add_row_button",size:"small",onClick:y}),c(n)?(I(),B(ze,{key:0,class:"mt-3 mb-3",ref_key:"deliveryNoteForm",ref:O,deliveryNote:c(n),onSubmit:W},null,8,["deliveryNote"])):E("",!0),c(n)?(I(),B(Ae,{key:1,orders:c(t).salesOrders,canDelete:N.value,onDelete:ee},{header:h(()=>[s("div",qe,[je,s("div",null,[l(g,{disabled:!N.value,size:"small",label:"Afegir comanda",onClick:r[0]||(r[0]=R=>Y())},null,8,["disabled"])])])]),_:1},8,["orders","canDelete"])):E("",!0),l(te,{closable:!0,visible:e.value,"onUpdate:visible":r[1]||(r[1]=R=>e.value=R),header:He,modal:!0,style:{width:"50rem"},breakpoints:{"1199px":"75vw","575px":"90vw"}},{default:h(()=>[l(we,{orders:c(t).salesOrdersToDeliver,onSelected:Z},null,8,["orders"])]),_:1},8,["visible"])],64)}}});export{it as default};

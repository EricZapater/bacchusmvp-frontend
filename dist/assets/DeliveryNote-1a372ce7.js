import{d as U,r as V,H as L,h as N,a as g,m as $,w as _,e as a,C as T,i as o,k as m,P as E,D as w,p as Q,b as J,f as W,j as X,c as F,n as k,y as q,l as R,s as ae,x as re,K as ie,F as K,v as de,g as ne,u as ce,z as ue,o as me,G as ve}from"./index-1f9e3570.js";import{f as M,c as pe,d as P,b as fe}from"./functions-2e154ea4.js";import{u as Y}from"./customers-bcffdfde.js";import{u as Z}from"./lifecycle-2ff86d21.js";import{u as ye}from"./masterData-1d6a5c56.js";import{c as be,a as x,F as _e}from"./form-validator-f8953ae6.js";import{_ as he}from"./LinkReference.vue_vue_type_script_setup_true_lang-135bc2fc.js";import{u as De}from"./reference-79c88333.js";import{u as Ne}from"./plantmodel-e3ef9a45.js";import{u as Se}from"./deliveryNote-33099d24.js";import{u as Ie}from"./order-bfb6919a.js";import{S as we}from"./index-8f83f9ef.js";import{a as ge,b as Oe}from"./report.service-2451ec2f.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./base.service-e02629e7.js";import"./index-a13a1f31.js";import"./reference.service-859533eb.js";import"./index-d9717bc8.js";import"./index-6f533818.js";import"./file.service-0e8351b0.js";const Ve=v=>(Q("data-v-8f6728d6"),v=v(),J(),v),Ce={class:"selector-filter"},Te={class:"selector-filter-field"},Be=Ve(()=>a("label",{for:""},"Buscar",-1)),xe={class:"selector-filter-button"},ke={class:"flex align-items-center gap-2"},$e=U({__name:"SelectorOrders",props:{orders:{},headerVisible:{type:Boolean}},emits:["selected"],setup(v,{emit:I}){const p=v,c=V([]),h=V(""),O=L(()=>{if(h.value==="")return p.orders||[];var r=[];return p.orders&&(r=p.orders.filter(e=>e.number.includes(h.value)||e.customerNumber.includes(h.value))),r}),d=()=>{if(c.value.length===0)return;const r=c.value;I("selected",r)};return(r,e)=>{const b=N("InputText"),s=N("Button"),f=N("Column"),i=N("DataTable");return g(),$(i,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",metaKeySelection:!1,value:O.value,selectionMode:"multiple",selection:c.value,"onUpdate:selection":e[1]||(e[1]=t=>c.value=t)},{header:_(()=>[a("header",Ce,[a("div",Te,[Be,T("   "),o(b,{style:{width:"150px",height:"35px"},modelValue:h.value,"onUpdate:modelValue":e[0]||(e[0]=t=>h.value=t),size:"small"},null,8,["modelValue"])]),a("div",xe,[o(s,{onClick:d,size:"small",icon:m(E).CHECK_SQUARE},null,8,["icon"])])])]),groupheader:_(t=>[a("div",ke,[a("b",null,"Comanda "+w(t.data.number)+" - "+w(m(M)(t.data.date)),1)])]),default:_(()=>[o(f,{selectionMode:"multiple",style:{width:"3%"}}),o(f,{header:"Número",field:"number",style:{width:"10%"}}),o(f,{header:"Número client",field:"customerNumber",style:{width:"20%"}}),o(f,{header:"Data",field:"date",style:{width:"10%"}},{body:_(t=>[T(w(m(M)(t.data.date)),1)]),_:1})]),_:1},8,["value","selection"])}}});const Ee=W($e,[["__scopeId","data-v-8f6728d6"]]),z=v=>(Q("data-v-146cd7fb"),v=v(),J(),v),Fe={key:0},Re={class:"three-columns"},Me={class:"mt-1"},Ue=z(()=>a("label",{class:"block text-900 mb-2"},"Exercici",-1)),Le={class:"mt-1"},Ae={class:"mt-1"},qe=z(()=>a("label",{class:"block text-900 mb-2"},"Client",-1)),ze={class:"three-columns"},Ge={class:"mt-2"},je=z(()=>a("label",{class:"block text-900 mb-2"},"Estat",-1)),He={class:"mt-2"},Ke={class:"mt-2"},Pe=U({__name:"FormDeliveryNote",props:{deliveryNote:{}},emits:["submit","cancel"],setup(v,{expose:I,emit:p}){const c=v,h=Y(),O=ye(),d=Z(),r=X(),e=L(()=>c.deliveryNote&&c.deliveryNote.salesInvoice?c.deliveryNote.salesInvoice.invoiceNumber:""),b=be().shape({siteId:x().required("L'origen es obligatori"),customerId:x().required("El client es obligatori"),statusId:x().required("L'estat es obligatori"),exerciseId:x().required("L'exercici es obligatori")}),s=V({result:!1,errors:{}}),f=()=>{const t=new _e(b);s.value=t.validate(c.deliveryNote)};return I({submitForm:async()=>{if(f(),s.value.result)c.deliveryNote.deliveryDate&&(c.deliveryNote.deliveryDate=pe(c.deliveryNote.deliveryDate)),p("submit",c.deliveryNote);else{let t="";Object.entries(s.value.errors).forEach(u=>{t+=`${u[1].map(D=>D)}.   `}),r.add({severity:"warn",summary:"Formulari inválid",detail:t,life:5e3})}}}),(t,u)=>{var C;const D=N("Dropdown");return g(),F("div",null,[t.deliveryNote?(g(),F("form",Fe,[a("section",Re,[a("div",Me,[Ue,o(D,{modelValue:t.deliveryNote.exerciseId,"onUpdate:modelValue":u[0]||(u[0]=y=>t.deliveryNote.exerciseId=y),editable:"",options:m(O).exercises,optionValue:"id",optionLabel:"name",class:k(["w-full",{"p-invalid":s.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),a("div",Le,[o(q,{type:m(ae).TEXT,label:"Número Albarà",id:"salesOrderNumber",modelValue:t.deliveryNote.number,"onUpdate:modelValue":u[1]||(u[1]=y=>t.deliveryNote.number=y),disabled:""},null,8,["type","modelValue"])]),a("div",Ae,[qe,o(D,{modelValue:t.deliveryNote.customerId,"onUpdate:modelValue":u[2]||(u[2]=y=>t.deliveryNote.customerId=y),editable:"",options:m(h).customers,optionValue:"id",optionLabel:"comercialName",class:k(["w-full",{"p-invalid":s.value.errors.customerId}])},null,8,["modelValue","options","class"])])]),a("section",ze,[a("div",Ge,[je,o(D,{modelValue:t.deliveryNote.statusId,"onUpdate:modelValue":u[3]||(u[3]=y=>t.deliveryNote.statusId=y),editable:"",options:(C=m(d).lifecycle)==null?void 0:C.statuses,optionValue:"id",optionLabel:"name",class:k(["w-full",{"p-invalid":s.value.errors.statusId}])},null,8,["modelValue","options","class"])]),a("div",He,[o(q,{modelValue:t.deliveryNote.deliveryDate,"onUpdate:modelValue":u[4]||(u[4]=y=>t.deliveryNote.deliveryDate=y),label:"Data Entrega",disabled:!0},null,8,["modelValue"])]),a("div",Ke,[o(q,{modelValue:e.value,"onUpdate:modelValue":u[5]||(u[5]=y=>e.value=y),label:"Número de factura",disabled:!0},null,8,["modelValue"])])])])):R("",!0)])}}});const Qe=W(Pe,[["__scopeId","data-v-146cd7fb"]]),Je={class:"vertical-align-middle ml-2 font-bold line-height-3"},We=["onClick"],Xe=U({__name:"TableDeliveryNoteDetails",props:{orders:{},canDelete:{type:Boolean}},emits:["delete"],setup(v,{emit:I}){const p=v,c=L(()=>{if(!p.orders)return[];let d=[];for(let r=0;r<p.orders.length;r++){if(!p.orders[r].salesOrderDetails)continue;const e=p.orders[r];e.salesOrderDetails.forEach(b=>{d.push({salesOrderId:e.id,salesOrderNumber:e.number,salesOrderDate:e.date,...b})})}return d}),h=re(),O=(d,r)=>{var b;if(!p.orders)return;const e=(b=p.orders)==null?void 0:b.find(s=>s.id===r.salesOrderId);e&&h.require({target:d.currentTarget,message:`Está segur que vol desassignar la comanda ${e.number}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{I("delete",e)}})};return(d,r)=>{const e=N("Column"),b=N("DataTable");return g(),$(b,{value:c.value,tableStyle:"min-width: 100%",class:"p-datatable-sm",rowGroupMode:"subheader",groupRowsBy:"salesOrderNumber",sortMode:"multiple",sortOrder:1},{header:_(()=>[ie(d.$slots,"header")]),groupheader:_(s=>[a("span",Je,"Comanda "+w(s.data.salesOrderNumber)+" ("+w(s.data.customerOrderNumber)+") "+w(m(M)(s.data.salesOrderDate)),1),T("   "),d.canDelete?(g(),F("i",{key:0,class:k([m(E).TIMES,"grid_delete_column_button"]),onClick:f=>O(f,s.data)},null,10,We)):R("",!0)]),default:_(()=>[o(e,{field:"salesOrderNumber",header:"Comanda",style:{width:"5%"}}),o(e,{field:"",header:"",style:{width:"5%"}}),o(e,{field:"quantity",header:"Quantitat",style:{width:"5%"}}),o(e,{header:"Referència",field:"reference.code",sortable:"",style:{width:"10%"}},{body:_(s=>[o(he,{id:s.data.referenceId},null,8,["id"])]),_:1}),o(e,{field:"description",header:"Descripció",style:{width:"30%"}}),o(e,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:_(s=>[T(w(m(P)(s.data.unitPrice)),1)]),_:1}),o(e,{field:"amount",header:"Total",style:{width:"10%"}},{body:_(s=>[T(w(m(P)(s.data.amount)),1)]),_:1})]),_:3},8,["value"])}}}),Ye={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Ze=a("span",{class:"text-l text-900 font-bold"},"Linies de l'albarà",-1),et="Selector de comandes",St=U({__name:"DeliveryNote",setup(v){const I=V(),p=V(K.EDIT),c=de(),h=ne(),O=ce(),d=Se(),r=Ie(),e=Y(),b=Ne(),s=De(),f=Z(),{deliveryNote:i}=ue(d),t=[{label:"Descarregar",icon:E.FILE_WORD,command:()=>u()}],u=async()=>{var l;const n=await we.DeliveryNote.GetReportDataById(i.value.id);if(n){const S=`AlbaraEntrega_${(l=i.value)==null?void 0:l.number}.docx`,B=await new Oe().Download(n,ge.DeliveryNote,S);B?fe(S,B):G.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}},D=V(!1),C=V(""),y=L(()=>{if(!f.lifecycle||!f.lifecycle.statuses||i.value&&i.value.salesInvoiceId&&i.value.salesInvoiceId!==null)return!1;const n=f.lifecycle.statuses.find(l=>l.name==="Entregat");return n?n.id!==C.value:!1}),A=async()=>{const n=c.params.id;await d.GetById(n),C.value=d.deliveryNote.statusId,await r.GetByDeliveryNote(n),s.fetchReferencesByModule("sales"),b.fetchSites(),e.customers||e.fetchCustomers(),f.lifecycle||f.fetchOneByName("DeliveryNote");let l="";i.value&&(p.value=K.EDIT,l=`Albarà d'entrega ${i.value.number}`,i.value.deliveryDate&&(i.value.deliveryDate=M(i.value.deliveryDate))),O.setMenuItem({icon:E.BUILDING,backButtonVisible:!0,title:l})};me(async()=>{await A()});const ee=()=>{I.value.submitForm()},G=X(),te=async n=>{let l=!1,S="";l=await d.Update(n.id,n),S=l?"Albarà actualitzat":"Error al actualitzar l'albarà",G.add({life:5e3,severity:l?"success":"error",summary:S}),l&&h.back()},oe=async()=>{i.value&&await r.GetToDeliver(i.value.customerId),D.value=!0},se=async n=>{for(let l=0;l<n.length;l++){const S=n[l];await d.AddOrder(i.value.id,S)}D.value=!1,A()},le=async n=>{await d.DeleteOrder(i.value.id,n),A()};return(n,l)=>{const S=N("SplitButton"),j=N("Button"),B=N("Dialog");return g(),F(ve,null,[o(S,{label:"Guardar",onClick:ee,model:t,size:"small",class:"grid_add_row_button"}),m(i)?(g(),$(Qe,{key:0,class:"mt-3 mb-3",ref_key:"deliveryNoteForm",ref:I,deliveryNote:m(i),onSubmit:te},null,8,["deliveryNote"])):R("",!0),m(i)?(g(),$(Xe,{key:1,orders:m(r).salesOrders,canDelete:y.value,onDelete:le},{header:_(()=>[a("div",Ye,[Ze,a("div",null,[o(j,{disabled:!y.value,size:"small",label:"Afegir comanda",onClick:l[0]||(l[0]=H=>oe())},null,8,["disabled"])])])]),_:1},8,["orders","canDelete"])):R("",!0),o(B,{closable:!0,visible:D.value,"onUpdate:visible":l[1]||(l[1]=H=>D.value=H),header:et,modal:!0,style:{width:"50rem"},breakpoints:{"1199px":"75vw","575px":"90vw"}},{default:_(()=>[o(Ee,{orders:m(r).salesOrdersToDeliver,onSelected:se},null,8,["orders"])]),_:1},8,["visible"])],64)}}});export{St as default};

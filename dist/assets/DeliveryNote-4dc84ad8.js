import{d as U,r as V,H as M,h as D,a as g,m as B,w as _,e as a,C as T,i as l,k as v,P as R,D as N,p as G,b as j,f as H,j as K,c as $,n as x,y as L,l as E,s as se,x as le,K as oe,F as A,v as ae,g as re,u as ie,z as de,o as ne,G as ce}from"./index-a72117b0.js";import{f as F,c as ue}from"./functions-afe9fe15.js";import{u as P}from"./customers-bec93cf1.js";import{u as Q}from"./lifecycle-52f1a6fb.js";import{u as me}from"./masterData-6119d469.js";import{c as ve,a as k,F as pe}from"./form-validator-f8953ae6.js";import{u as J}from"./reference-f1a08499.js";import{u as fe}from"./plantmodel-bd2079e0.js";import{u as ye}from"./deliveryNote-1629aa97.js";import{u as be}from"./order-dbe1eed2.js";import"./v4-a960c1f4.js";import"./base.service-2600e8bd.js";import"./index-f812ff3a.js";import"./reference.service-95116f81.js";import"./_commonjsHelpers-725317a4.js";import"./index-cbd53df5.js";import"./index-d52e7b85.js";const _e=p=>(G("data-v-1baead78"),p=p(),j(),p),he={class:"selector-filter"},Ne={class:"selector-filter-field"},De=_e(()=>a("label",{for:""},"Buscar",-1)),Se={class:"selector-filter-button"},Ie={class:"flex align-items-center gap-2"},ge=U({__name:"SelectorOrders",props:{orders:{},headerVisible:{type:Boolean}},emits:["selected"],setup(p,{emit:S}){const f=p,n=V([]),h=V(""),O=M(()=>{var r=[];return f.orders&&(r=f.orders.filter(o=>o.salesOrderNumber.toString().includes(h.value)||o.customerSalesOrderNumber.includes(h.value))),r}),b=()=>{if(n.value.length===0)return;const r=n.value;S("selected",r)};return(r,o)=>{const s=D("InputText"),c=D("Button"),t=D("Column"),i=D("DataTable");return g(),B(i,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",metaKeySelection:!1,value:O.value,selectionMode:"multiple",selection:n.value,"onUpdate:selection":o[1]||(o[1]=e=>n.value=e)},{header:_(()=>[a("header",he,[a("div",Ne,[De,T("   "),l(s,{style:{width:"150px",height:"35px"},modelValue:h.value,"onUpdate:modelValue":o[0]||(o[0]=e=>h.value=e),size:"small"},null,8,["modelValue"])]),a("div",Se,[l(c,{onClick:b,size:"small",icon:v(R).CHECK_SQUARE},null,8,["icon"])])])]),groupheader:_(e=>[a("div",Ie,[a("b",null,"Comanda "+N(e.data.salesOrderNumber)+" - "+N(v(F)(e.data.salesOrderDate)),1)])]),default:_(()=>[l(t,{header:"Número",field:"salesOrderNumber",style:{width:"10%"}}),l(t,{header:"Número client",field:"customerSalesOrderNumber",style:{width:"20%"}}),l(t,{header:"Data",field:"salesOrderDate",style:{width:"10%"}},{body:_(e=>[T(N(v(F)(e.data.salesOrderDate)),1)]),_:1})]),_:1},8,["value","selection"])}}});const Oe=H(ge,[["__scopeId","data-v-1baead78"]]),q=p=>(G("data-v-146cd7fb"),p=p(),j(),p),we={key:0},Ve={class:"three-columns"},Ce={class:"mt-1"},Te=q(()=>a("label",{class:"block text-900 mb-2"},"Exercici",-1)),ke={class:"mt-1"},xe={class:"mt-1"},Be=q(()=>a("label",{class:"block text-900 mb-2"},"Client",-1)),$e={class:"three-columns"},Ee={class:"mt-2"},Fe=q(()=>a("label",{class:"block text-900 mb-2"},"Estat",-1)),Ue={class:"mt-2"},Me={class:"mt-2"},Le=U({__name:"FormDeliveryNote",props:{deliveryNote:{}},emits:["submit","cancel"],setup(p,{expose:S,emit:f}){const n=p,h=P(),O=me(),b=Q(),r=K(),o=M(()=>n.deliveryNote&&n.deliveryNote.salesInvoice?n.deliveryNote.salesInvoice.invoiceNumber:""),s=ve().shape({siteId:k().required("L'origen es obligatori"),customerId:k().required("El client es obligatori"),statusId:k().required("L'estat es obligatori"),exerciseId:k().required("L'exercici es obligatori")}),c=V({result:!1,errors:{}}),t=()=>{const e=new pe(s);c.value=e.validate(n.deliveryNote)};return S({submitForm:async()=>{if(t(),c.value.result)n.deliveryNote.deliveryDate&&(n.deliveryNote.deliveryDate=ue(n.deliveryNote.deliveryDate)),f("submit",n.deliveryNote);else{let e="";Object.entries(c.value.errors).forEach(u=>{e+=`${u[1].map(I=>I)}.   `}),r.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}}}),(e,u)=>{var C;const I=D("Dropdown");return g(),$("div",null,[e.deliveryNote?(g(),$("form",we,[a("section",Ve,[a("div",Ce,[Te,l(I,{modelValue:e.deliveryNote.exerciseId,"onUpdate:modelValue":u[0]||(u[0]=y=>e.deliveryNote.exerciseId=y),editable:"",options:v(O).exercises,optionValue:"id",optionLabel:"name",class:x(["w-full",{"p-invalid":c.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),a("div",ke,[l(L,{type:v(se).TEXT,label:"Número Albarà",id:"salesOrderNumber",modelValue:e.deliveryNote.number,"onUpdate:modelValue":u[1]||(u[1]=y=>e.deliveryNote.number=y),disabled:""},null,8,["type","modelValue"])]),a("div",xe,[Be,l(I,{modelValue:e.deliveryNote.customerId,"onUpdate:modelValue":u[2]||(u[2]=y=>e.deliveryNote.customerId=y),editable:"",options:v(h).customers,optionValue:"id",optionLabel:"comercialName",class:x(["w-full",{"p-invalid":c.value.errors.customerId}])},null,8,["modelValue","options","class"])])]),a("section",$e,[a("div",Ee,[Fe,l(I,{modelValue:e.deliveryNote.statusId,"onUpdate:modelValue":u[3]||(u[3]=y=>e.deliveryNote.statusId=y),editable:"",options:(C=v(b).lifecycle)==null?void 0:C.statuses,optionValue:"id",optionLabel:"name",class:x(["w-full",{"p-invalid":c.value.errors.statusId}])},null,8,["modelValue","options","class"])]),a("div",Ue,[l(L,{modelValue:e.deliveryNote.deliveryDate,"onUpdate:modelValue":u[4]||(u[4]=y=>e.deliveryNote.deliveryDate=y),label:"Data Entrega",disabled:!0},null,8,["modelValue"])]),a("div",Me,[l(L,{modelValue:o.value,"onUpdate:modelValue":u[5]||(u[5]=y=>o.value=y),label:"Número de factura",disabled:!0},null,8,["modelValue"])])])])):E("",!0)])}}});const Re=H(Le,[["__scopeId","data-v-146cd7fb"]]),qe={class:"vertical-align-middle ml-2 font-bold line-height-3"},ze=["onClick"],Ae=U({__name:"TableDeliveryNoteDetails",props:{orders:{},canDelete:{type:Boolean}},emits:["delete"],setup(p,{emit:S}){const f=p,n=J(),h=M(()=>{if(!f.orders)return[];let r=[];for(let o=0;o<f.orders.length;o++){if(!f.orders[o].salesOrderDetails)continue;const s=f.orders[o];s.salesOrderDetails.forEach(c=>{r.push({salesOrderId:s.id,salesOrderNumber:s.salesOrderNumber,salesOrderDate:s.salesOrderDate,...c})})}return r}),O=le(),b=(r,o)=>{var c;if(!f.orders)return;const s=(c=f.orders)==null?void 0:c.find(t=>t.id===o.salesOrderId);s&&O.require({target:r.currentTarget,message:`Está segur que vol desassignar la comanda ${s.salesOrderNumber}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{S("delete",s)}})};return(r,o)=>{const s=D("Column"),c=D("DataTable");return g(),B(c,{value:h.value,tableStyle:"min-width: 100%",class:"p-datatable-sm",rowGroupMode:"subheader",groupRowsBy:"salesOrderNumber"},{header:_(()=>[oe(r.$slots,"header")]),groupheader:_(t=>[a("span",qe,"Comanda "+N(t.data.salesOrderNumber)+" ("+N(t.data.customerOrderNumber)+") "+N(v(F)(t.data.salesOrderDate)),1),T("   "),r.canDelete?(g(),$("i",{key:0,class:x([v(R).TIMES,"grid_delete_column_button"]),onClick:i=>b(i,t.data)},null,10,ze)):E("",!0)]),default:_(()=>[l(s,{field:"salesOrderNumber",header:"Comanda",style:{width:"5%"}}),l(s,{field:"",header:"",style:{width:"5%"}}),l(s,{field:"quantity",header:"Quantitat",style:{width:"5%"}}),l(s,{header:"Referència",style:{width:"10%"}},{body:_(t=>[T(N(v(n).getShortName(t.data.reference)),1)]),_:1}),l(s,{field:"description",header:"Descripció",style:{width:"30%"}}),l(s,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:_(t=>[T(N(t.data.unitPrice)+" € ",1)]),_:1}),l(s,{field:"amount",header:"Total",style:{width:"10%"}},{body:_(t=>[T(N(t.data.amount)+" € ",1)]),_:1})]),_:3},8,["value"])}}}),Ge={class:"flex flex-wrap align-items-center justify-content-between gap-2"},je=a("span",{class:"text-l text-900 font-bold"},"Linies de l'albarà",-1),He="Selector de comandes",nt=U({__name:"DeliveryNote",setup(p){const S=V(),f=V(A.EDIT),n=ae(),h=re(),O=ie(),b=ye(),r=be(),o=P(),s=fe(),c=J(),t=Q(),{deliveryNote:i}=de(b),e=V(!1),u=V(""),I=M(()=>{if(!t.lifecycle||!t.lifecycle.statuses||i.value&&i.value.salesInvoiceId&&i.value.salesInvoiceId!==null)return!1;const m=t.lifecycle.statuses.find(d=>d.name==="Entregat");return m?m.id!==u.value:!1}),C=async()=>{const m=n.params.id;await b.GetById(m),u.value=b.deliveryNote.statusId,await r.GetByDeliveryNote(m),c.fetchReferencesByModule("sales"),s.fetchSites(),o.customers||o.fetchCustomers(),t.lifecycle||t.fetchOneByName("DeliveryNote");let d="";i.value&&(f.value=A.EDIT,d=`Albarà d'entrega ${i.value.number}`,i.value.deliveryDate&&(i.value.deliveryDate=F(i.value.deliveryDate))),O.setMenuItem({icon:R.BUILDING,backButtonVisible:!0,title:d})};ne(async()=>{await C()});const y=()=>{S.value.submitForm()},X=K(),W=async m=>{let d=!1,w="";d=await b.Update(m.id,m),w=d?"Albarà actualitzat":"Error al actualitzar l'albarà",X.add({life:5e3,severity:d?"success":"error",summary:w}),d&&h.back()},Y=async()=>{i.value&&await r.GetToDeliver(i.value.customerId),e.value=!0},Z=async m=>{for(let d=0;d<m.length;d++){const w=m[d];await b.AddOrder(i.value.id,w)}e.value=!1,C()},ee=async m=>{await b.DeleteOrder(i.value.id,m),C()};return(m,d)=>{const w=D("Button"),te=D("Dialog");return g(),$(ce,null,[l(w,{label:"Guardar",class:"grid_add_row_button",size:"small",onClick:y}),v(i)?(g(),B(Re,{key:0,class:"mt-3 mb-3",ref_key:"deliveryNoteForm",ref:S,deliveryNote:v(i),onSubmit:W},null,8,["deliveryNote"])):E("",!0),v(i)?(g(),B(Ae,{key:1,orders:v(r).salesOrders,canDelete:I.value,onDelete:ee},{header:_(()=>[a("div",Ge,[je,a("div",null,[l(w,{disabled:!I.value,size:"small",label:"Afegir comanda",onClick:d[0]||(d[0]=z=>Y())},null,8,["disabled"])])])]),_:1},8,["orders","canDelete"])):E("",!0),l(te,{closable:!0,visible:e.value,"onUpdate:visible":d[1]||(d[1]=z=>e.value=z),header:He,modal:!0,style:{width:"50rem"},breakpoints:{"1199px":"75vw","575px":"90vw"}},{default:_(()=>[l(Oe,{orders:v(r).salesOrdersToDeliver,onSelected:Z},null,8,["orders"])]),_:1},8,["visible"])],64)}}});export{nt as default};

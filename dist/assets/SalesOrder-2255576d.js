import{d as z,j as P,z as K,o as Y,r as h,h as I,a as O,c as U,k as l,e as n,i as r,n as T,s as q,y as Q,l as k,p as ae,b as se,f as le,K as oe,w as p,D,F as V,m as B,J as re,C as j,P as W,v as ie,g as ne,u as de,G as ue}from"./index-ecb5eec1.js";import{c as ce,g as G}from"./functions-781c12cd.js";import{u as X}from"./salesOrder-823627de.js";import{u as me}from"./customers-aeb217c9.js";import{u as pe}from"./exercise-9725d012.js";import{u as fe}from"./plantmodel-a16c13f9.js";import{u as ve}from"./lifecycle-4274f2e8.js";import{c as Z,a as M,F as ee,d as be}from"./form-validator-1d21b93c.js";import{u as H}from"./reference-b28c3841.js";import{_ as _e}from"./FormReference.vue_vue_type_script_setup_true_lang-43bb55d8.js";import{F as ye}from"./FileEntityPicker-8ff26f87.js";import"./v4-a960c1f4.js";import"./index-f39f2e81.js";import"./reference.service-65331f94.js";import"./base.service-88077886.js";import"./index-9785c663.js";import"./tax-ecc6bb2f.js";import"./file.service-e1e5760a.js";const A=S=>(ae("data-v-89640366"),S=S(),se(),S),De={key:0},Oe={class:"four-columns"},Ie={class:"mt-1"},Ve=A(()=>n("label",{class:"block text-900 mb-2"},"Exercici",-1)),Se={class:"mt-1"},we={class:"mt-1"},Ce=A(()=>n("label",{class:"block text-900 mb-2"},"Data Comanda",-1)),ge={class:"mt-1"},Te=A(()=>n("label",{class:"block text-900 mb-2"},"Estat",-1)),Ee={class:"three-columns"},Ne={class:"mt-1"},xe=A(()=>n("label",{class:"block text-900 mb-2"},"Origen",-1)),he={class:"mt-1"},ke=A(()=>n("label",{class:"block text-900 mb-2"},"Client",-1)),$e={class:"mt-1"},Re=z({__name:"FormSalesOrder",emits:["submit","cancel"],setup(S,{expose:w,emit:d}){const E=X(),C=me(),b=fe(),v=pe(),m=ve(),f=H(),i=P(),{salesOrder:e}=K(E);Y(async()=>{await b.fetchSites(),await v.fetchAll(),await C.fetchCustomers(),f.fetchReferences(),await m.fetchOneByName("SalesOrder")});const N=Z().shape({siteId:M().required("L'origen es obligatori"),customerId:M().required("El client es obligatori"),statusId:M().required("L'estat es obligatori"),exerciseId:M().required("L'exercici es obligatori")}),s=h({result:!1,errors:{}}),c=()=>{const t=new ee(N);s.value=t.validate(e.value)};w({submitForm:async()=>{if(c(),s.value.result)e.value.salesOrderDate=ce(e.value.salesOrderDate),d("submit",e.value);else{let t="";Object.entries(s.value.errors).forEach(o=>{t+=`${o[1].map(_=>_)}.   `}),i.add({severity:"warn",summary:"Formulari inválid",detail:t,life:5e3})}}});const x=()=>{var o;const t=(o=C.customers)==null?void 0:o.find(_=>{var g;return _.id===((g=e.value)==null?void 0:g.customerId)});t&&e.value&&(e.value.customerCode=t.code,e.value.customerComercialName=t.comercialName,e.value.customerTaxName=t.taxName,e.value.customerVatNumber=t.vatNumber,e.value.customerAccountNumber=t.accountNumber),console.log(e.value)},R=()=>{var o;const t=(o=b.sites)==null?void 0:o.find(_=>{var g;return _.id===((g=e.value)==null?void 0:g.siteId)});t&&e.value&&(e.value.name=t.name,e.value.address=t.address,e.value.city=t.city,e.value.postalCode=t.postalCode,e.value.region=t.region,e.value.country=t.country,e.value.vatNumber=t.vatNumber)};return(t,o)=>{var u;const _=I("Dropdown"),g=I("Calendar");return O(),U("div",null,[l(e)?(O(),U("form",De,[n("section",Oe,[n("div",Ie,[Ve,r(_,{modelValue:l(e).exerciseId,"onUpdate:modelValue":o[0]||(o[0]=a=>l(e).exerciseId=a),editable:"",options:l(v).exercises,optionValue:"id",optionLabel:"name",class:T(["w-full",{"p-invalid":s.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),n("div",Se,[r(Q,{type:l(q).TEXT,label:"Num. Comanda",id:"salesOrderNumber",modelValue:l(e).salesOrderNumber,"onUpdate:modelValue":o[1]||(o[1]=a=>l(e).salesOrderNumber=a),disabled:""},null,8,["type","modelValue"])]),n("div",we,[Ce,r(g,{modelValue:l(e).salesOrderDate,"onUpdate:modelValue":o[2]||(o[2]=a=>l(e).salesOrderDate=a),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),n("div",ge,[Te,r(_,{modelValue:l(e).statusId,"onUpdate:modelValue":o[3]||(o[3]=a=>l(e).statusId=a),editable:"",options:(u=l(m).lifecycle)==null?void 0:u.statuses,optionValue:"id",optionLabel:"name",class:T(["w-full",{"p-invalid":s.value.errors.statusId}])},null,8,["modelValue","options","class"])])]),n("section",Ee,[n("div",Ne,[xe,r(_,{modelValue:l(e).siteId,"onUpdate:modelValue":[o[4]||(o[4]=a=>l(e).siteId=a),o[5]||(o[5]=a=>R())],editable:"",options:l(b).sites,optionValue:"id",optionLabel:"name",class:T(["w-full",{"p-invalid":s.value.errors.siteId}])},null,8,["modelValue","options","class"])]),n("div",he,[ke,r(_,{modelValue:l(e).customerId,"onUpdate:modelValue":[o[6]||(o[6]=a=>l(e).customerId=a),o[7]||(o[7]=a=>x())],editable:"",options:l(C).customers,optionValue:"id",optionLabel:"comercialName",class:T(["w-full",{"p-invalid":s.value.errors.customerId}])},null,8,["modelValue","options","class"])]),n("div",$e,[r(Q,{type:l(q).TEXT,label:"Comanda Client",id:"customerSalesOrderNumber",modelValue:l(e).customerSalesOrderNumber,"onUpdate:modelValue":o[8]||(o[8]=a=>l(e).customerSalesOrderNumber=a)},null,8,["type","modelValue"])])])])):k("",!0)])}}});const Fe=le(Re,[["__scopeId","data-v-89640366"]]),Ue={key:0},Be={class:"mb-2"},qe=n("label",{class:"block text-900 mb-2"},"Referència",-1),Ae={key:0,class:"flex align-items-center"},Le={key:0,class:"flex align-items-center"},Me={class:"two-columns"},ze=z({__name:"FormSalesOrderReference",props:{formAction:{},salesOrderDetail:{}},emits:["submit"],setup(S,{emit:w}){const d=S;X();const E=H(),C=P(),b=oe(()=>d.formAction===V.CREATE?"Afegir":"Modificar"),v=()=>{const s=E.references.find(c=>c.id===d.salesOrderDetail.referenceId);s&&(d.salesOrderDetail.description=`${s.code} (${s.version}) - ${s.description}`,d.salesOrderDetail.isInvoiced=!1,d.salesOrderDetail.isServed=!1,d.salesOrderDetail.unitCost=s==null?void 0:s.cost,d.salesOrderDetail.unitPrice=s==null?void 0:s.price,m())},m=()=>{d.salesOrderDetail.amount=d.salesOrderDetail.unitPrice*d.salesOrderDetail.quantity,d.salesOrderDetail.totalCost=d.salesOrderDetail.unitCost*d.salesOrderDetail.quantity},f=Z().shape({quantity:be().required("La quantitat és obligatoria").min(1,"La quantitat ha de ser un número positiu")}),i=h({result:!1,errors:{}}),e=()=>{const s=new ee(f);i.value=s.validate(d.salesOrderDetail)},N=async()=>{if(e(),i.value.result)w("submit",d.salesOrderDetail);else{let s="";Object.entries(i.value.errors).forEach(c=>{s+=`${c[1].map($=>$)}.   `}),C.add({severity:"warn",summary:"Formulari inválid",detail:s,life:5e3})}};return(s,c)=>{const $=I("Dropdown"),x=I("BaseInput"),R=I("Button");return s.salesOrderDetail?(O(),U("form",Ue,[n("div",Be,[qe,r($,{modelValue:s.salesOrderDetail.referenceId,"onUpdate:modelValue":[c[0]||(c[0]=t=>s.salesOrderDetail.referenceId=t),c[1]||(c[1]=t=>v())],editable:"",options:l(E).references,optionValue:"id",optionLabel:"description",class:T(["w-full",{"p-invalid":i.value.errors.referenceId}])},{value:p(t=>[t.value?(O(),U("div",Ae,D(t.value.code)+" ("+D(t.value.version)+") - "+D(t.value.description),1)):k("",!0)]),option:p(t=>[t.option?(O(),U("div",Le,D(t.option.code)+" ("+D(t.option.version)+") - "+D(t.option.description),1)):k("",!0)]),_:1},8,["modelValue","options","class"])]),n("section",Me,[n("div",null,[r(x,{class:T(["mb-2",{"p-invalid":i.value.errors.quantity}]),label:"Quantitat",modelValue:s.salesOrderDetail.quantity,"onUpdate:modelValue":[c[2]||(c[2]=t=>s.salesOrderDetail.quantity=t),c[3]||(c[3]=t=>m())],type:l(q).NUMERIC},null,8,["modelValue","type","class"])]),n("div",null,[r(x,{class:T(["mb-2",{"p-invalid":i.value.errors.amount}]),label:"Total",modelValue:s.salesOrderDetail.amount,"onUpdate:modelValue":c[4]||(c[4]=t=>s.salesOrderDetail.amount=t),type:l(q).CURRENCY,disabled:""},null,8,["modelValue","type","class"])])]),n("section",null,[n("div",null,[r(x,{class:T(["mb-2",{"p-invalid":i.value.errors.description}]),label:"Descripció línea",modelValue:s.salesOrderDetail.description,"onUpdate:modelValue":c[5]||(c[5]=t=>s.salesOrderDetail.description=t),type:l(q).TEXT},null,8,["modelValue","type","class"])])]),r(R,{label:b.value,onClick:N,style:{float:"right"}},null,8,["label"])])):k("",!0)}}}),je=["onClick"],Ge=z({__name:"TableSalesOrderDetails",props:{salesOrderDetails:{}},emits:["edit","delete"],setup(S,{emit:w}){const d=S,E=b=>{b.originalEvent.target.className.includes("grid_delete_column_button")||w("edit",b.data)},C=(b,v)=>{w("delete",v)};return(b,v)=>{const m=I("Column"),f=I("DataTable");return O(),B(f,{onRowClick:E,value:d.salesOrderDetails,tableStyle:"min-width: 100%",class:"p-datatable-sm"},{header:p(()=>[re(b.$slots,"header")]),default:p(()=>[r(m,{field:"quantity",header:"Quantitat",style:{width:"10%"}}),r(m,{header:"Referencia",style:{width:"25%"}},{body:p(i=>[j(D(i.data.reference.code)+" ("+D(i.data.reference.version)+") - "+D(i.data.reference.description),1)]),_:1}),r(m,{field:"description",header:"Descripció",style:{width:"25%"}}),r(m,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:p(i=>[j(D(i.data.unitPrice)+" € ",1)]),_:1}),r(m,{field:"amount",header:"Total",style:{width:"10%"}},{body:p(i=>[j(D(i.data.amount)+" € ",1)]),_:1}),r(m,{style:{width:"10%"}},{body:p(i=>[n("i",{class:T([l(W).TIMES,"grid_delete_column_button"]),onClick:e=>C(e,i.data)},null,10,je)]),_:1})]),_:3},8,["value"])}}}),Pe={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Xe=n("span",{class:"text-l text-900 font-bold"},"Linies de la comanda",-1),He="Línia de comanda",mt=z({__name:"SalesOrder",setup(S){const w=h(),d=h(V.EDIT),E=ie(),C=ne(),b=de(),v=X(),m=H(),{salesOrder:f}=K(v),i=h(!1),e=h(V.EDIT),N=h(void 0),s=h(0),c=async()=>{await v.GetById(E.params.id);let u="";f.value&&(d.value=V.EDIT,u=`Comanda ${f.value.salesOrderNumber}`),b.setMenuItem({icon:W.BUILDING,backButtonVisible:!0,title:u})};Y(async()=>{await c()});const $=()=>{w.value.submitForm()},x=(u,a)=>{u===V.CREATE&&(a={id:G(),referenceId:"",quantity:0,unitCost:0,unitPrice:0,totalCost:0,amount:0,salesOrderHeaderId:"",description:"",estimatedDeliveryDate:new Date,isServerd:!1,isInvoiced:!1},m.setNewReference(G())),a.salesOrderHeaderId=f.value.id,N.value=a,e.value=u,i.value=!0},R=P(),t=async u=>{let a=!1,y="";a=await v.Update(u.id,u),y=a?"Comanda actualitzada":"Error a l'actualitzar la comanda",R.add({life:5e3,severity:a?"success":"error",summary:y}),a&&C.back()},o=async u=>{e.value===V.CREATE?await v.CreateDetail(u):e.value===V.EDIT&&await v.UpdateDetail(u),i.value=!1},_=async u=>{d.value===V.EDIT&&await v.DeleteDetail(u);const a=f.value.salesOrderDetails.filter(y=>y.id!==u.id);f.value.salesOrderDetails=a,i.value=!1},g=async u=>{let a=!1,y="";a=await m.createReference(u),a?y="Referència creada correctament":y="La referència + versió introduïda ja existeix",R.add({severity:a?"success":"warn",summary:y,life:5e3}),a&&(N.value.referenceId=u.id,s.value=1,m.setNewReference(G()))};return(u,a)=>{const y=I("Button"),L=I("TabPanel"),J=I("TabView"),te=I("Dialog");return O(),U(ue,null,[r(y,{label:"Guardar",class:"grid_add_row_button",size:"small",onClick:$}),r(Fe,{class:"mt-3 mb-3",ref_key:"salesOrderForm",ref:w,salesOrder:"salesOrder",onSubmit:t},null,512),r(J,null,{default:p(()=>[r(L,{header:"Detall"},{default:p(()=>[l(f)?(O(),B(Ge,{key:0,salesOrderDetails:l(f).salesOrderDetails,onEdit:a[1]||(a[1]=F=>x(l(V).EDIT,F)),onDelete:_},{header:p(()=>[n("div",Pe,[Xe,n("div",null,[r(y,{size:"small",label:"Afegir línea",onClick:a[0]||(a[0]=F=>x(l(V).CREATE,{}))})])])]),_:1},8,["salesOrderDetails"])):k("",!0)]),_:1}),r(L,{header:"Fitxers"},{default:p(()=>[l(f)?(O(),B(ye,{key:0,entity:"SalesOrder",id:l(f).id,title:""},null,8,["id"])):k("",!0)]),_:1})]),_:1}),r(te,{closable:!0,visible:i.value,"onUpdate:visible":a[3]||(a[3]=F=>i.value=F),header:He,modal:!0},{default:p(()=>[r(J,{activeIndex:s.value,"onUpdate:activeIndex":a[2]||(a[2]=F=>s.value=F)},{default:p(()=>[r(L,{header:"Crear línea"},{default:p(()=>[N.value?(O(),B(ze,{key:0,formAction:e.value,salesOrderDetail:N.value,onSubmit:o},null,8,["formAction","salesOrderDetail"])):k("",!0)]),_:1}),r(L,{header:"Crear referencia"},{default:p(()=>[l(m).reference?(O(),B(_e,{key:0,reference:l(m).reference,onSubmit:g},null,8,["reference"])):k("",!0)]),_:1})]),_:1},8,["activeIndex"])]),_:1},8,["visible"])],64)}}});export{mt as default};

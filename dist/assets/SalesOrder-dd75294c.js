import{d as M,j as Q,z as W,H as Z,r as w,h as I,a as O,c as h,k as a,e as d,i as s,s as R,y as L,n as F,l as E,p as fe,b as ve,f as be,F as _,x as ye,m as U,w as v,K as De,C as z,D as G,P as ee,v as Oe,g as _e,u as Ie,o as Se,G as Ve}from"./index-a72117b0.js";import{c as Ne,f as X,g as H}from"./functions-afe9fe15.js";import{u as te}from"./order-dbe1eed2.js";import{u as J}from"./reference-f1a08499.js";import{u as ae}from"./customers-bec93cf1.js";import{u as se}from"./exercise-0152431b.js";import{u as le}from"./plantmodel-bd2079e0.js";import{u as re}from"./lifecycle-52f1a6fb.js";import{u as Ce}from"./tax-1a5b19d9.js";import{c as oe,a as P,F as ie,d as Te}from"./form-validator-f8953ae6.js";import{u as ne}from"./deliveryNote-1629aa97.js";import{_ as ge}from"./DropdownReference.vue_vue_type_script_setup_true_lang-4994bfc1.js";import{_ as we}from"./FormReference.vue_vue_type_script_setup_true_lang-7575ed16.js";import{F as Ee}from"./FileEntityPicker-16050fd1.js";import"./v4-a960c1f4.js";import"./index-d52e7b85.js";import"./base.service-2600e8bd.js";import"./reference.service-95116f81.js";import"./index-f812ff3a.js";import"./index-cbd53df5.js";import"./_commonjsHelpers-725317a4.js";import"./referenceType-77a9802d.js";import"./file.service-5fd94bd3.js";const j=S=>(fe("data-v-869804a6"),S=S(),ve(),S),xe={key:0},ke={class:"four-columns mt-2"},Re=j(()=>d("label",{class:"block text-900 mb-2"},"Exercici",-1)),Fe=j(()=>d("label",{class:"block text-900 mb-2"},"Data Comanda",-1)),$e={class:"four-columns mt-2"},Be=j(()=>d("label",{class:"block text-900 mb-2"},"Estat",-1)),Ue=j(()=>d("label",{class:"block text-900 mb-2"},"Client",-1)),he=M({__name:"FormSalesOrder",emits:["submit","cancel"],setup(S,{expose:V,emit:n}){const x=te(),C=ae();le();const k=se(),b=re(),f=ne(),T=Q(),{salesOrder:e}=W(x),g=Z(()=>f.deliveryNote?f.deliveryNote.number:""),m=oe().shape({siteId:P().required("L'origen es obligatori"),customerId:P().required("El client es obligatori"),statusId:P().required("L'estat es obligatori"),exerciseId:P().required("L'exercici es obligatori")}),t=w({result:!1,errors:{}}),u=()=>{const l=new ie(m);t.value=l.validate(e.value)};V({submitForm:async()=>{if(u(),t.value.result)e.value.salesOrderDate=Ne(e.value.salesOrderDate),n("submit",e.value);else{let l="";Object.entries(t.value.errors).forEach(r=>{l+=`${r[1].map(y=>y)}.   `}),T.add({severity:"warn",summary:"Formulari inválid",detail:l,life:5e3})}}});const N=()=>{var r;const l=(r=C.customers)==null?void 0:r.find(y=>{var $;return y.id===(($=e.value)==null?void 0:$.customerId)});l&&e.value&&(e.value.customerCode=l.code,e.value.customerComercialName=l.comercialName,e.value.customerTaxName=l.taxName,e.value.customerVatNumber=l.vatNumber,e.value.customerAccountNumber=l.accountNumber),console.log(e.value)};return(l,r)=>{var q;const y=I("Dropdown"),$=I("Calendar");return O(),h("div",null,[a(e)?(O(),h("form",xe,[d("section",ke,[d("div",null,[s(L,{type:a(R).TEXT,label:"Num. Comanda",id:"salesOrderNumber",modelValue:a(e).salesOrderNumber,"onUpdate:modelValue":r[0]||(r[0]=c=>a(e).salesOrderNumber=c),disabled:""},null,8,["type","modelValue"])]),d("div",null,[s(L,{type:a(R).TEXT,label:"Num. Pressupost",id:"budgetNumber",modelValue:a(e).budgetNumber,"onUpdate:modelValue":r[1]||(r[1]=c=>a(e).budgetNumber=c),disabled:""},null,8,["type","modelValue"])]),d("div",null,[Re,s(y,{modelValue:a(e).exerciseId,"onUpdate:modelValue":r[2]||(r[2]=c=>a(e).exerciseId=c),editable:"",options:a(k).exercises,optionValue:"id",optionLabel:"name",class:F(["w-full",{"p-invalid":t.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),d("div",null,[Fe,s($,{modelValue:a(e).salesOrderDate,"onUpdate:modelValue":r[3]||(r[3]=c=>a(e).salesOrderDate=c),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),d("section",$e,[d("div",null,[Be,s(y,{modelValue:a(e).statusId,"onUpdate:modelValue":r[4]||(r[4]=c=>a(e).statusId=c),editable:"",options:(q=a(b).lifecycle)==null?void 0:q.statuses,optionValue:"id",optionLabel:"name",class:F(["w-full",{"p-invalid":t.value.errors.statusId}])},null,8,["modelValue","options","class"])]),d("div",null,[Ue,s(y,{modelValue:a(e).customerId,"onUpdate:modelValue":[r[5]||(r[5]=c=>a(e).customerId=c),r[6]||(r[6]=c=>N())],editable:"",options:a(C).customers,optionValue:"id",optionLabel:"comercialName",class:F(["w-full",{"p-invalid":t.value.errors.customerId}])},null,8,["modelValue","options","class"])]),d("div",null,[s(L,{type:a(R).TEXT,label:"Comanda Client",id:"customerSalesOrderNumber",modelValue:a(e).customerSalesOrderNumber,"onUpdate:modelValue":r[7]||(r[7]=c=>a(e).customerSalesOrderNumber=c)},null,8,["type","modelValue"])]),d("div",null,[s(L,{type:a(R).TEXT,disabled:!0,label:"Albarà Entrega",id:"deliveryNote",modelValue:g.value,"onUpdate:modelValue":r[8]||(r[8]=c=>g.value=c)},null,8,["type","modelValue"])])])])):E("",!0)])}}});const qe=be(he,[["__scopeId","data-v-869804a6"]]),Ae={key:0},Le={class:"mb-2"},Pe={class:"two-columns"},Me=M({__name:"FormSalesOrderDetail",props:{formAction:{},salesOrderDetail:{}},emits:["submit"],setup(S,{emit:V}){const n=S,x=J(),C=Q(),k=Z(()=>n.formAction===_.CREATE?"Afegir":"Modificar"),b=()=>{const t=x.references.find(u=>u.id===n.salesOrderDetail.referenceId);t&&(n.salesOrderDetail.description=t.description,n.salesOrderDetail.isInvoiced=!1,n.salesOrderDetail.isDelivered=!1,n.salesOrderDetail.unitCost=t==null?void 0:t.cost,n.salesOrderDetail.unitPrice=t==null?void 0:t.price,f())},f=()=>{n.salesOrderDetail.amount=n.salesOrderDetail.unitPrice*n.salesOrderDetail.quantity,n.salesOrderDetail.totalCost=n.salesOrderDetail.unitCost*n.salesOrderDetail.quantity},T=oe().shape({quantity:Te().required("La quantitat és obligatoria").min(1,"La quantitat ha de ser un número positiu")}),e=w({result:!1,errors:{}}),g=()=>{const t=new ie(T);e.value=t.validate(n.salesOrderDetail)},m=async()=>{if(g(),e.value.result)V("submit",n.salesOrderDetail);else{let t="";Object.entries(e.value.errors).forEach(u=>{t+=`${u[1].map(o=>o)}.   `}),C.add({severity:"warn",summary:"Formulari inválid",detail:t,life:5e3})}};return(t,u)=>{const o=I("BaseInput"),N=I("Button");return t.salesOrderDetail?(O(),h("form",Ae,[d("div",Le,[s(ge,{label:"Referència",modelValue:t.salesOrderDetail.referenceId,"onUpdate:modelValue":[u[0]||(u[0]=l=>t.salesOrderDetail.referenceId=l),u[1]||(u[1]=l=>b())],fullName:!0},null,8,["modelValue"])]),d("section",null,[d("div",null,[s(o,{class:F(["mb-2",{"p-invalid":e.value.errors.description}]),label:"Descripció",modelValue:t.salesOrderDetail.description,"onUpdate:modelValue":u[2]||(u[2]=l=>t.salesOrderDetail.description=l),type:a(R).TEXT},null,8,["modelValue","type","class"])])]),d("section",Pe,[d("div",null,[s(o,{class:F(["mb-2",{"p-invalid":e.value.errors.quantity}]),label:"Quantitat",modelValue:t.salesOrderDetail.quantity,"onUpdate:modelValue":[u[3]||(u[3]=l=>t.salesOrderDetail.quantity=l),u[4]||(u[4]=l=>f())],type:a(R).NUMERIC},null,8,["modelValue","type","class"])]),d("div",null,[s(o,{class:F(["mb-2",{"p-invalid":e.value.errors.amount}]),label:"Total",modelValue:t.salesOrderDetail.amount,"onUpdate:modelValue":u[5]||(u[5]=l=>t.salesOrderDetail.amount=l),type:a(R).CURRENCY,disabled:""},null,8,["modelValue","type","class"])])]),s(N,{label:k.value,onClick:m,style:{float:"right"}},null,8,["label"])])):E("",!0)}}}),je=["onClick"],ze=M({__name:"TableSalesOrderDetails",props:{salesOrder:{},salesOrderDetails:{}},emits:["edit","delete"],setup(S,{emit:V}){const n=S,x=ye(),C=J(),k=f=>{n.salesOrder.deliveryNoteId||f.originalEvent.target.className.includes("grid_delete_column_button")||V("edit",f.data)},b=(f,T)=>{x.require({target:f.currentTarget,message:"Está segur que vol eliminar la referència?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{V("delete",T)}})};return(f,T)=>{const e=I("Column"),g=I("DataTable");return O(),U(g,{onRowClick:k,value:n.salesOrderDetails,tableStyle:"min-width: 100%",class:"p-datatable-sm"},{header:v(()=>[De(f.$slots,"header")]),default:v(()=>[s(e,{field:"quantity",header:"Quantitat",style:{width:"10%"}}),s(e,{header:"Referencia",style:{width:"15%"}},{body:v(m=>[z(G(a(C).getShortNameById(m.data.referenceId)),1)]),_:1}),s(e,{field:"description",header:"Descripció",style:{width:"40%"}}),s(e,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:v(m=>[z(G(m.data.unitPrice)+" € ",1)]),_:1}),s(e,{field:"amount",header:"Total",style:{width:"10%"}},{body:v(m=>[z(G(m.data.amount)+" € ",1)]),_:1}),f.salesOrder.deliveryNoteId?E("",!0):(O(),U(e,{key:0,style:{width:"10%"}},{body:v(m=>[m.data.isDelivered?E("",!0):(O(),h("i",{key:0,class:F([a(ee).TIMES,"grid_delete_column_button"]),onClick:t=>b(t,m.data)},null,10,je))]),_:1}))]),_:3},8,["value"])}}}),Ge={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Xe=d("span",{class:"text-l text-900 font-bold"},"Linies de la comanda",-1),He="Línia de comanda",yt=M({__name:"SalesOrder",setup(S){const V=w(),n=w(_.EDIT),x=Oe(),C=_e(),k=Ie(),b=te(),f=ae(),T=le(),e=se(),g=re(),m=J(),t=ne(),u=Ce(),{salesOrder:o}=W(b),N=w(!1),l=w(_.EDIT),r=w(void 0),y=w(0),$=async()=>{await b.GetById(x.params.id),m.fetchReferencesByModule("sales"),g.fetchOneByName("SalesOrder"),T.fetchSites(),e.fetchAll(),f.fetchCustomers(),u.fetchAll();let p="";o.value&&(n.value=_.EDIT,p=`Comanda ${o.value.salesOrderNumber}`,o.value.salesOrderDate=X(o.value.salesOrderDate),o.value.deliveryNoteId?t.GetById(o.value.deliveryNoteId):t.deliveryNote&&(t.deliveryNote=void 0)),k.setMenuItem({icon:ee.BUILDING,backButtonVisible:!0,title:p})};Se(async()=>{await $()});const q=()=>{V.value.submitForm()},c=(p,i)=>{m.setNewReference(H()),p===_.CREATE&&(i={id:H(),referenceId:"",quantity:0,unitCost:0,unitPrice:0,totalCost:0,amount:0,salesOrderHeaderId:"",description:"",estimatedDeliveryDate:new Date,isDelivered:!1,isInvoiced:!1}),i.salesOrderHeaderId=o.value.id,r.value=i,l.value=p,N.value=!0},K=Q(),de=async p=>{let i=!1,D="";i=await b.Update(p.id,p),D=i?"Comanda actualitzada":"Error a l'actualitzar la comanda",K.add({life:5e3,severity:i?"success":"error",summary:D}),i&&C.back()},ue=async p=>{l.value===_.CREATE?await b.CreateDetail(p):l.value===_.EDIT&&await b.UpdateDetail(p),N.value=!1,o.value.salesOrderDate=X(o.value.salesOrderDate)},me=async p=>{n.value===_.EDIT&&await b.DeleteDetail(p);const i=o.value.salesOrderDetails.filter(D=>D.id!==p.id);o.value.salesOrderDetails=i,N.value=!1,o.value.salesOrderDate=X(o.value.salesOrderDate)},ce=async p=>{let i=!1,D="";i=await m.createReference(p),i?D="Referència creada correctament":D="La referència + versió introduïda ja existeix",K.add({severity:i?"success":"warn",summary:D,life:5e3}),i&&(m.setNewReference(H()),y.value=0)};return(p,i)=>{const D=I("Button"),A=I("TabPanel"),Y=I("TabView"),pe=I("Dialog");return O(),h(Ve,null,[s(D,{label:"Guardar",class:"grid_add_row_button",size:"small",onClick:q}),s(qe,{class:"mt-3 mb-3",ref_key:"salesOrderForm",ref:V,salesOrder:"salesOrder",onSubmit:de},null,512),s(Y,null,{default:v(()=>[s(A,{header:"Detall"},{default:v(()=>[a(o)?(O(),U(ze,{key:0,salesOrder:a(o),salesOrderDetails:a(o).salesOrderDetails,onEdit:i[1]||(i[1]=B=>c(a(_).EDIT,B)),onDelete:me},{header:v(()=>[d("div",Ge,[Xe,d("div",null,[s(D,{disabled:a(t).deliveryNote!==void 0,size:"small",label:"Afegir línea",onClick:i[0]||(i[0]=B=>c(a(_).CREATE,{}))},null,8,["disabled"])])])]),_:1},8,["salesOrder","salesOrderDetails"])):E("",!0)]),_:1}),s(A,{header:"Fitxers"},{default:v(()=>[a(o)?(O(),U(Ee,{key:0,entity:"SalesOrder",id:a(o).id,title:""},null,8,["id"])):E("",!0)]),_:1})]),_:1}),s(pe,{closable:!0,visible:N.value,"onUpdate:visible":i[3]||(i[3]=B=>N.value=B),header:He,modal:!0},{default:v(()=>[s(Y,{activeIndex:y.value,"onUpdate:activeIndex":i[2]||(i[2]=B=>y.value=B)},{default:v(()=>[s(A,{header:"Línea"},{default:v(()=>[r.value?(O(),U(Me,{key:0,formAction:l.value,salesOrderDetail:r.value,onSubmit:ue},null,8,["formAction","salesOrderDetail"])):E("",!0)]),_:1}),s(A,{header:"Referencia"},{default:v(()=>[a(m).reference?(O(),U(we,{key:0,module:"sales",reference:a(m).reference,onSubmit:ce},null,8,["reference"])):E("",!0)]),_:1})]),_:1},8,["activeIndex"])]),_:1},8,["visible"])],64)}}});export{yt as default};

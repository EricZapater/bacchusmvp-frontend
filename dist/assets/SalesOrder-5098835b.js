import{d as Y,j as J,z as se,H as K,r as g,h as O,a as w,c as F,k as r,e as c,i as s,s as U,n as L,l as R,p as Ce,b as ge,f as le,F as N,x as Ne,w as p,K as Ve,D as q,C as G,P as X,m as z,G as oe,v as Te,g as xe,u as Ee,o as he}from"./index-98d6f8aa.js";import{c as re,d as Be,b as Fe,f as P,g as H}from"./functions-552e18f7.js";import{u as ie}from"./order-a7b157a7.js";import{u as Z}from"./reference-73298289.js";import{u as de}from"./customers-ede34a6d.js";import{u as Re}from"./exercise-3a9a3c2e.js";import{u as $e}from"./plantmodel-3866c95d.js";import{u as ne}from"./lifecycle-33e56b46.js";import{u as Me}from"./tax-524f221f.js";import{c as ue,a as j,F as ce,d as Ae}from"./form-validator-f8953ae6.js";import{u as me}from"./deliveryNote-cc08dc31.js";import{u as ve}from"./budget-b32c4e7d.js";import{_ as Ue}from"./DropdownReference.vue_vue_type_script_setup_true_lang-a946ca4e.js";import{_ as We}from"./FormCreateWorkorder.vue_vue_type_script_setup_true_lang-5c9dc3c2.js";import{u as pe}from"./workmaster-bd2ddef8.js";import{u as fe}from"./workorder-ebee2a37.js";import{_ as qe}from"./FormReference.vue_vue_type_script_setup_true_lang-035633b5.js";import{F as Le}from"./FileEntityPicker-1901a6e9.js";import{a as Ge,b as Pe}from"./report.service-51b6b551.js";import{S as ze}from"./index-fc8ab139.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./reference.service-3d8d19cf.js";import"./base.service-e22fe275.js";import"./index-0828a430.js";import"./index-a7eaf997.js";import"./referenceType-73769758.js";import"./file.service-3235a4bb.js";import"./index-24f69aca.js";const Q=V=>(Ce("data-v-9ef3c9d3"),V=V(),ge(),V),je={key:0},Xe={class:"four-columns mt-2"},Ye=Q(()=>c("label",{class:"block text-900 mb-2"},"Client",-1)),Qe=Q(()=>c("label",{class:"block text-900 mb-2"},"Estat",-1)),He={class:"four-columns mt-2"},Je=Q(()=>c("label",{class:"block text-900 mb-2"},"Data Alta",-1)),Ke=Q(()=>c("label",{class:"block text-900 mb-2"},"Data Entrega",-1)),Ze=Y({__name:"FormSalesOrder",emits:["submit","cancel"],setup(V,{expose:I,emit:i}){const $=ie(),T=de(),M=ne(),_=me(),b=ve(),h=J(),{salesOrder:t}=se($),S=K(()=>_.deliveryNote?_.deliveryNote.number:""),k=ue().shape({siteId:j().required("L'origen es obligatori"),customerId:j().required("El client es obligatori"),statusId:j().required("L'estat es obligatori"),exerciseId:j().required("L'exercici es obligatori")}),a=g({result:!1,errors:{}}),u=()=>{const l=new ce(k);a.value=l.validate(t.value)};I({submitForm:async()=>{if(u(),a.value.result)f(),i("submit",t.value);else{let l="";Object.entries(a.value.errors).forEach(e=>{l+=`${e[1].map(m=>m)}.   `}),h.add({severity:"warn",summary:"Formulari inválid",detail:l,life:5e3})}}});const x=()=>{var e;const l=(e=T.customers)==null?void 0:e.find(m=>{var y;return m.id===((y=t.value)==null?void 0:y.customerId)});l&&t.value&&(t.value.customerCode=l.code,t.value.customerComercialName=l.comercialName,t.value.customerTaxName=l.taxName,t.value.customerVatNumber=l.vatNumber,t.value.customerAccountNumber=l.accountNumber)},f=()=>{t.value&&(t.value.date=re(t.value.date),t.value.expectedDate&&(t.value.expectedDate=re(t.value.expectedDate)))};return(l,e)=>{var B,n;const m=O("BaseInput"),y=O("Dropdown"),E=O("Calendar");return w(),F("div",null,[r(t)?(w(),F("form",je,[c("section",Xe,[c("div",null,[s(m,{type:r(U).TEXT,label:"Num. Comanda",id:"salesOrderNumber",modelValue:r(t).number,"onUpdate:modelValue":e[0]||(e[0]=v=>r(t).number=v),disabled:""},null,8,["type","modelValue"])]),c("div",null,[Ye,s(y,{modelValue:r(t).customerId,"onUpdate:modelValue":[e[1]||(e[1]=v=>r(t).customerId=v),e[2]||(e[2]=v=>x())],editable:"",options:r(T).customers,optionValue:"id",optionLabel:"comercialName",class:L(["w-full",{"p-invalid":a.value.errors.customerId}])},null,8,["modelValue","options","class"])]),c("div",null,[s(m,{type:r(U).TEXT,label:"Comanda Client",id:"customerSalesOrderNumber",modelValue:r(t).customerNumber,"onUpdate:modelValue":e[3]||(e[3]=v=>r(t).customerNumber=v)},null,8,["type","modelValue"])]),c("div",null,[Qe,s(y,{modelValue:r(t).statusId,"onUpdate:modelValue":e[4]||(e[4]=v=>r(t).statusId=v),editable:"",options:(B=r(M).lifecycle)==null?void 0:B.statuses,optionValue:"id",optionLabel:"name",class:L(["w-full",{"p-invalid":a.value.errors.statusId}])},null,8,["modelValue","options","class"])])]),c("section",He,[c("div",null,[Je,s(E,{modelValue:r(t).date,"onUpdate:modelValue":e[5]||(e[5]=v=>r(t).date=v),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),c("div",null,[Ke,s(E,{modelValue:r(t).expectedDate,"onUpdate:modelValue":e[6]||(e[6]=v=>r(t).expectedDate=v),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),c("div",null,[s(m,{type:r(U).TEXT,label:"Num. Pressupost",id:"budgetNumber",disabled:"",value:(n=r(b).budget)==null?void 0:n.number},null,8,["type","value"])]),c("div",null,[s(m,{type:r(U).TEXT,disabled:!0,label:"Albarà Entrega",id:"deliveryNote",modelValue:S.value,"onUpdate:modelValue":e[7]||(e[7]=v=>S.value=v)},null,8,["type","modelValue"])])])])):R("",!0)])}}});const et=le(Ze,[["__scopeId","data-v-9ef3c9d3"]]),tt={key:0},at={class:"mb-2"},rt={class:"two-columns"},st=Y({__name:"FormSalesOrderDetail",props:{formAction:{},salesOrderDetail:{}},emits:["submit"],setup(V,{emit:I}){const i=V,$=Z(),T=J(),M=K(()=>i.formAction===N.CREATE?"Afegir":"Modificar"),_=()=>{const a=$.references.find(u=>u.id===i.salesOrderDetail.referenceId);a&&(i.salesOrderDetail.description=a.description,i.salesOrderDetail.isInvoiced=!1,i.salesOrderDetail.isDelivered=!1,i.salesOrderDetail.unitCost=a==null?void 0:a.cost,i.salesOrderDetail.unitPrice=a==null?void 0:a.price,i.salesOrderDetail.lastCost=a==null?void 0:a.lastCost,i.salesOrderDetail.workMasterCost=a==null?void 0:a.workMasterCost,b())},b=()=>{i.salesOrderDetail.amount=i.salesOrderDetail.unitPrice*i.salesOrderDetail.quantity,i.salesOrderDetail.totalCost=i.salesOrderDetail.unitCost*i.salesOrderDetail.quantity},h=ue().shape({quantity:Ae().required("La quantitat és obligatoria").min(1,"La quantitat ha de ser un número positiu")}),t=g({result:!1,errors:{}}),S=()=>{const a=new ce(h);t.value=a.validate(i.salesOrderDetail)},k=async()=>{if(S(),t.value.result)i.salesOrderDetail.workOrderId||(i.salesOrderDetail.workOrderId=null),I("submit",i.salesOrderDetail);else{let a="";Object.entries(t.value.errors).forEach(u=>{a+=`${u[1].map(C=>C)}.   `}),T.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}};return(a,u)=>{const C=O("BaseInput"),x=O("Button");return a.salesOrderDetail?(w(),F("form",tt,[c("div",at,[s(Ue,{label:"Referència",modelValue:a.salesOrderDetail.referenceId,"onUpdate:modelValue":[u[0]||(u[0]=f=>a.salesOrderDetail.referenceId=f),u[1]||(u[1]=f=>_())],fullName:!0},null,8,["modelValue"])]),c("section",null,[c("div",null,[s(C,{class:L(["mb-2",{"p-invalid":t.value.errors.description}]),label:"Descripció",modelValue:a.salesOrderDetail.description,"onUpdate:modelValue":u[2]||(u[2]=f=>a.salesOrderDetail.description=f),type:r(U).TEXT},null,8,["modelValue","type","class"])])]),c("section",rt,[c("div",null,[s(C,{class:L(["mb-2",{"p-invalid":t.value.errors.quantity}]),label:"Quantitat",modelValue:a.salesOrderDetail.quantity,"onUpdate:modelValue":[u[3]||(u[3]=f=>a.salesOrderDetail.quantity=f),u[4]||(u[4]=f=>b())],type:r(U).NUMERIC},null,8,["modelValue","type","class"])]),c("div",null,[s(C,{class:L(["mb-2",{"p-invalid":t.value.errors.amount}]),label:"Total",modelValue:a.salesOrderDetail.amount,"onUpdate:modelValue":u[5]||(u[5]=f=>a.salesOrderDetail.amount=f),type:r(U).CURRENCY,disabled:""},null,8,["modelValue","type","class"])])]),s(x,{label:M.value,onClick:k,style:{float:"right"}},null,8,["label"])])):R("",!0)}}}),lt={key:0},ot={key:1},it=["onClick"],dt={class:"total"},nt={class:"total-text"},ut=Y({__name:"TableSalesOrderDetails",props:{salesOrder:{},salesOrderDetails:{}},emits:["edit","delete","createWorkOrder","openWorkOrder"],setup(V,{emit:I}){const i=V,$=Ne(),T=Z(),M=pe(),_=fe(),b=K(()=>i.salesOrderDetails?i.salesOrderDetails.reduce((l,e)=>l+e.amount,0):0);var h=void 0;const t=g({closable:!0,modal:!0,title:"Generar ordre de fabricació",visible:!1}),S=g([]),k=g({workMasterId:"",plannedDate:"",plannedQuantity:0,comment:""}),a=l=>{i.salesOrder.deliveryNoteId||l.originalEvent.target.className.includes("grid_delete_column_button")||I("edit",l.data)},u=(l,e)=>{$.require({target:l.currentTarget,message:"Está segur que vol eliminar la referència?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{I("delete",e)}})},C=l=>{S.value=M.getByReferenceId(l.referenceId),k.value.workMasterId="",S.value.length>0&&(k.value.workMasterId=S.value[0].id),k.value.plannedQuantity=l.quantity,k.value.plannedDate=i.salesOrder.expectedDate?Be(i.salesOrder.expectedDate):"",k.value.comment="",h=l,t.value.visible=!0},x=l=>{console.log(l),I("openWorkOrder",l)},f=()=>{const l={workOrderDto:k.value,orderDetail:h};t.value.visible=!1,I("createWorkOrder",l)};return(l,e)=>{const m=O("Column"),y=O("Button"),E=O("DataTable"),B=O("Dialog");return w(),F(oe,null,[s(E,{onRowClick:a,value:l.salesOrderDetails,tableStyle:"min-width: 100%",class:"p-datatable-sm"},{header:p(()=>[Ve(l.$slots,"header",{},void 0,!0)]),footer:p(()=>[c("div",dt,[c("span",nt,"Total "+q(b.value.toFixed(2))+" € ",1)])]),default:p(()=>[s(m,{field:"quantity",header:"Quantitat",style:{width:"10%"}}),s(m,{header:"Referencia",style:{width:"15%"}},{body:p(n=>[G(q(r(T).getShortNameById(n.data.referenceId)),1)]),_:1}),s(m,{field:"description",header:"Descripció",style:{width:"30%"}}),s(m,{field:"workOrderId",header:"Ordre fabr.",style:{width:"10%"}},{body:p(n=>[r(_).getWorkOrderCodeById(n.data.workOrderId)?(w(),F("div",lt,[s(y,{size:"small",severity:"success",label:r(_).getWorkOrderCodeById(n.data.workOrderId),onClick:v=>x(n.data.workOrderId)},null,8,["label","onClick"])])):(w(),F("div",ot,[s(y,{size:"small",icon:r(X).PLUS_CIRCLE,value:"Generar OF",onClick:v=>C(n.data)},null,8,["icon","onClick"])]))]),_:1}),s(m,{field:"workMasterCost",header:"Cost Teóric",style:{width:"10%"}},{body:p(n=>[G(q(n.data.workMasterCost.toFixed(2))+" € ",1)]),_:1}),s(m,{field:"lastCost",header:"Últim Cost",style:{width:"10%"}},{body:p(n=>[G(q(n.data.lastCost.toFixed(2))+" € ",1)]),_:1}),s(m,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:p(n=>[G(q(n.data.unitPrice)+" € ",1)]),_:1}),s(m,{field:"amount",header:"Total",style:{width:"10%"}},{body:p(n=>[G(q(n.data.amount)+" € ",1)]),_:1}),l.salesOrder.deliveryNoteId?R("",!0):(w(),z(m,{key:0,style:{width:"5%"}},{body:p(n=>[n.data.isDelivered?R("",!0):(w(),F("i",{key:0,class:L([r(X).TIMES,"grid_delete_column_button"]),onClick:v=>u(v,n.data)},null,10,it))]),_:1}))]),_:3},8,["value"]),s(B,{closable:t.value.closable,visible:t.value.visible,"onUpdate:visible":e[0]||(e[0]=n=>t.value.visible=n),header:t.value.title,modal:t.value.modal,style:{width:"50vw"}},{default:p(()=>[s(We,{createWorkOrderDto:k.value,"filtered-work-masters":S.value,onSubmit:f},null,8,["createWorkOrderDto","filtered-work-masters"])]),_:1},8,["closable","visible","header","modal"])],64)}}});const ct=le(ut,[["__scopeId","data-v-58a3c04d"]]),mt={class:"flex flex-wrap align-items-center justify-content-between gap-2"},vt=c("span",{class:"text-l text-900 font-bold"},"Linies de la comanda",-1),pt="Línia de comanda",Pt=Y({__name:"SalesOrder",setup(V){const I=g(),i=g(N.EDIT),$=Te(),T=xe(),M=Ee(),_=J(),b=ie(),h=de(),t=$e(),S=Re(),k=ne(),a=Z(),u=me(),C=pe(),x=fe(),f=Me(),l=ve(),{salesOrder:e}=se(b),m=[{label:"Descarregar",icon:X.FILE_WORD,command:()=>Ie()}],y=g(!1),E=g(N.EDIT),B=g(void 0),n=g(0),v=async()=>{const d=$.params.id;await b.GetById(d),a.fetchReferencesByModule("sales"),k.fetchOneByName("SalesOrder"),t.fetchSites(),S.fetchAll(),h.fetchCustomers(),f.fetchAll(),x.fetchBySalesOrder(d),C.workmasters||C.fetchAllActives();let o="";e.value&&(i.value=N.EDIT,o=`Comanda ${e.value.number}`,e.value.date=P(e.value.date),e.value.expectedDate&&(e.value.expectedDate=P(e.value.expectedDate)),e.value.deliveryNoteId?u.GetById(e.value.deliveryNoteId):u.deliveryNote&&(u.deliveryNote=void 0),e.value.budgetId?await l.GetById(e.value.budgetId):l.budget=void 0),M.setMenuItem({icon:X.BUILDING,backButtonVisible:!0,title:o})};he(async()=>{await v()});const be=()=>{I.value.submitForm()},ee=(d,o)=>{a.setNewReference(H()),d===N.CREATE&&(o={id:H(),referenceId:"",quantity:0,unitCost:0,unitPrice:0,totalCost:0,amount:0,salesOrderHeaderId:"",lastCost:0,workMasterCost:0,description:"",estimatedDeliveryDate:new Date,isDelivered:!1,isInvoiced:!1,workOrderId:""}),o.salesOrderHeaderId=e.value.id,B.value=o,E.value=d,y.value=!0},ye=async d=>{let o=!1,D="";o=await b.Update(d.id,d),D=o?"Comanda actualitzada":"Error a l'actualitzar la comanda",_.add({life:5e3,severity:o?"success":"error",summary:D}),o&&T.back()},De=async d=>{E.value===N.CREATE?await b.CreateDetail(d):E.value===N.EDIT&&await b.UpdateDetail(d),y.value=!1,e.value&&(e.value.date=P(e.value.date),e.value.expectedDate&&(e.value.expectedDate=P(e.value.expectedDate)))},Oe=async d=>{i.value===N.EDIT&&await b.DeleteDetail(d);const o=e.value.salesOrderDetails.filter(D=>D.id!==d.id);e.value.salesOrderDetails=o,y.value=!1,e.value.date=P(e.value.date)},_e=async d=>{let o=!1,D="";o=await a.createReference(d),o?D="Referència creada correctament":D="La referència + versió introduïda ja existeix",_.add({severity:o?"success":"warn",summary:D,life:5e3}),o&&(a.setNewReference(H()),n.value=0)},ke=async d=>{const o=await x.create(d.workOrderDto);o.result?(d.orderDetail.workOrderId=o.content.id,await b.UpdateDetail(d.orderDetail)&&(_.add({severity:"success",summary:"Generació OF",detail:`Ordre de fabricació ${o.content.code} generada`}),x.fetchBySalesOrder(e.value.id))):_.add({severity:"error",summary:"Generació OF",detail:"Error al generar la ordre de fabricació"})},we=d=>{T.push({path:`/workorder/${d}`})},Ie=async()=>{var o;const d=await ze.SalesOrder.GetReportDataById(e.value.id);if(d){const D=`Comanda_${(o=e.value)==null?void 0:o.number}.docx`,A=await new Pe().Download(d,Ge.Order,D);A?Fe(D,A):_.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}};return(d,o)=>{const D=O("SplitButton"),te=O("Button"),A=O("TabPanel"),ae=O("TabView"),Se=O("Dialog");return w(),F(oe,null,[s(D,{label:"Guardar",onClick:be,model:m,size:"small",class:"grid_add_row_button"}),s(et,{class:"mt-3 mb-3",ref_key:"salesOrderForm",ref:I,salesOrder:"salesOrder",onSubmit:ye},null,512),s(ae,null,{default:p(()=>[s(A,{header:"Detall"},{default:p(()=>[r(e)?(w(),z(ct,{key:0,salesOrder:r(e),salesOrderDetails:r(e).salesOrderDetails,onEdit:o[1]||(o[1]=W=>ee(r(N).EDIT,W)),onDelete:Oe,onCreateWorkOrder:ke,onOpenWorkOrder:we},{header:p(()=>[c("div",mt,[vt,c("section",null,[s(te,{disabled:r(u).deliveryNote!==void 0,size:"small",label:"Afegir línea",onClick:o[0]||(o[0]=W=>ee(r(N).CREATE,{})),class:"mr-2"},null,8,["disabled"])])])]),_:1},8,["salesOrder","salesOrderDetails"])):R("",!0)]),_:1}),s(A,{header:"Fitxers"},{default:p(()=>[r(e)?(w(),z(Le,{key:0,entity:"SalesOrder",id:r(e).id,title:""},null,8,["id"])):R("",!0)]),_:1})]),_:1}),s(Se,{closable:!0,visible:y.value,"onUpdate:visible":o[3]||(o[3]=W=>y.value=W),header:pt,modal:!0},{default:p(()=>[s(ae,{activeIndex:n.value,"onUpdate:activeIndex":o[2]||(o[2]=W=>n.value=W)},{default:p(()=>[s(A,{header:"Línea"},{default:p(()=>[B.value?(w(),z(st,{key:0,formAction:E.value,salesOrderDetail:B.value,onSubmit:De},null,8,["formAction","salesOrderDetail"])):R("",!0)]),_:1}),s(A,{header:"Referencia"},{default:p(()=>[r(a).reference?(w(),z(qe,{key:0,module:"sales",reference:r(a).reference,onSubmit:_e},null,8,["reference"])):R("",!0)]),_:1})]),_:1},8,["activeIndex"])]),_:1},8,["visible"])],64)}}});export{Pt as default};

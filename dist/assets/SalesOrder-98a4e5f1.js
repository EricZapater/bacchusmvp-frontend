import{d as Q,j as K,z as le,H as Z,r as g,h as D,a as O,c as F,k as a,e as c,i as s,s as U,n as L,l as R,p as ge,b as Ve,f as oe,F as N,x as Ne,w as p,K as Te,D as G,P as Y,C as j,m as q,G as de,v as Ee,g as he,u as xe,o as Re}from"./index-3b8fad0b.js";import{c as se,d as P,e as Be,b as Fe,f as z,g as J}from"./functions-2e154ea4.js";import{u as ie}from"./order-a506f66c.js";import{u as ee}from"./reference-e0518f57.js";import{u as ne}from"./customers-e8acd008.js";import{u as $e}from"./exercise-0bd1a038.js";import{u as Me}from"./plantmodel-4f98e0d8.js";import{u as ue}from"./lifecycle-fc73f11b.js";import{u as Ae}from"./tax-ea8e84c2.js";import{c as ce,a as X,F as me,d as Ue}from"./form-validator-f8953ae6.js";import{u as pe}from"./deliveryNote-3cf299ed.js";import{u as ve}from"./budget-631ae587.js";import{_ as We}from"./DropdownReference.vue_vue_type_script_setup_true_lang-f8a66cf5.js";import{L as qe}from"./LinkReference-c3201f0b.js";import{_ as Le}from"./FormCreateWorkorder.vue_vue_type_script_setup_true_lang-c1ad91e5.js";import{u as fe}from"./workmaster-f910fa28.js";import{u as be}from"./workorder-7616749e.js";import{_ as Ge}from"./FormReference.vue_vue_type_script_setup_true_lang-20cca9fb.js";import{F as Pe}from"./FileEntityPicker-a7e7bc24.js";import{a as ze,b as je}from"./report.service-486f949f.js";import{S as Xe}from"./index-ec6ca3e6.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./reference.service-d6c42ab4.js";import"./base.service-95f208f7.js";import"./index-30d8ed80.js";import"./index-60183c2e.js";import"./DropdownCustomers.vue_vue_type_script_setup_true_lang-f2e5ded2.js";import"./referenceType-272e0af2.js";import"./file.service-d6ce817a.js";import"./index-cbf4d2cc.js";const H=T=>(ge("data-v-9ef3c9d3"),T=T(),Ve(),T),Ye={key:0},Qe={class:"four-columns mt-2"},He=H(()=>c("label",{class:"block text-900 mb-2"},"Client",-1)),Je=H(()=>c("label",{class:"block text-900 mb-2"},"Estat",-1)),Ke={class:"four-columns mt-2"},Ze=H(()=>c("label",{class:"block text-900 mb-2"},"Data Alta",-1)),et=H(()=>c("label",{class:"block text-900 mb-2"},"Data Entrega",-1)),tt=Q({__name:"FormSalesOrder",emits:["submit","cancel"],setup(T,{expose:S,emit:d}){const $=ie(),E=ne(),B=ue(),w=pe(),f=ve(),_=K(),{salesOrder:r}=le($),b=Z(()=>w.deliveryNote?w.deliveryNote.number:""),M=ce().shape({siteId:X().required("L'origen es obligatori"),customerId:X().required("El client es obligatori"),statusId:X().required("L'estat es obligatori"),exerciseId:X().required("L'exercici es obligatori")}),t=g({result:!1,errors:{}}),u=()=>{const m=new me(M);t.value=m.validate(r.value)};S({submitForm:async()=>{if(u(),t.value.result)o(),d("submit",r.value);else{let m="";Object.entries(t.value.errors).forEach(e=>{m+=`${e[1].map(I=>I)}.   `}),_.add({severity:"warn",summary:"Formulari inválid",detail:m,life:5e3})}}});const h=()=>{var e;const m=(e=E.customers)==null?void 0:e.find(I=>{var k;return I.id===((k=r.value)==null?void 0:k.customerId)});m&&r.value&&(r.value.customerCode=m.code,r.value.customerComercialName=m.comercialName,r.value.customerTaxName=m.taxName,r.value.customerVatNumber=m.vatNumber,r.value.customerAccountNumber=m.accountNumber)},o=()=>{r.value&&(r.value.date=se(r.value.date),r.value.expectedDate&&(r.value.expectedDate=se(r.value.expectedDate)))};return(m,e)=>{var n,V;const I=D("BaseInput"),k=D("Dropdown"),x=D("Calendar");return O(),F("div",null,[a(r)?(O(),F("form",Ye,[c("section",Qe,[c("div",null,[s(I,{type:a(U).TEXT,label:"Num. Comanda",id:"salesOrderNumber",modelValue:a(r).number,"onUpdate:modelValue":e[0]||(e[0]=v=>a(r).number=v),disabled:""},null,8,["type","modelValue"])]),c("div",null,[He,s(k,{modelValue:a(r).customerId,"onUpdate:modelValue":[e[1]||(e[1]=v=>a(r).customerId=v),e[2]||(e[2]=v=>h())],editable:"",options:a(E).customers,optionValue:"id",optionLabel:"comercialName",class:L(["w-full",{"p-invalid":t.value.errors.customerId}])},null,8,["modelValue","options","class"])]),c("div",null,[s(I,{type:a(U).TEXT,label:"Comanda Client",id:"customerSalesOrderNumber",modelValue:a(r).customerNumber,"onUpdate:modelValue":e[3]||(e[3]=v=>a(r).customerNumber=v)},null,8,["type","modelValue"])]),c("div",null,[Je,s(k,{modelValue:a(r).statusId,"onUpdate:modelValue":e[4]||(e[4]=v=>a(r).statusId=v),editable:"",options:(n=a(B).lifecycle)==null?void 0:n.statuses,optionValue:"id",optionLabel:"name",class:L(["w-full",{"p-invalid":t.value.errors.statusId}])},null,8,["modelValue","options","class"])])]),c("section",Ke,[c("div",null,[Ze,s(x,{modelValue:a(r).date,"onUpdate:modelValue":e[5]||(e[5]=v=>a(r).date=v),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),c("div",null,[et,s(x,{modelValue:a(r).expectedDate,"onUpdate:modelValue":e[6]||(e[6]=v=>a(r).expectedDate=v),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),c("div",null,[s(I,{type:a(U).TEXT,label:"Num. Pressupost",id:"budgetNumber",disabled:"",value:(V=a(f).budget)==null?void 0:V.number},null,8,["type","value"])]),c("div",null,[s(I,{type:a(U).TEXT,disabled:!0,label:"Albarà Entrega",id:"deliveryNote",modelValue:b.value,"onUpdate:modelValue":e[7]||(e[7]=v=>b.value=v)},null,8,["type","modelValue"])])])])):R("",!0)])}}});const at=oe(tt,[["__scopeId","data-v-9ef3c9d3"]]),rt={key:0},st={class:"mb-2"},lt={class:"two-columns"},ot=Q({__name:"FormSalesOrderDetail",props:{formAction:{},salesOrder:{},salesOrderDetail:{}},emits:["submit"],setup(T,{emit:S}){const d=T,$=ee(),E=K(),B=Z(()=>d.formAction===N.CREATE?"Afegir":"Modificar"),w=()=>{const t=$.references.find(u=>u.id===d.salesOrderDetail.referenceId);t&&(d.salesOrderDetail.description=t.description,d.salesOrderDetail.isInvoiced=!1,d.salesOrderDetail.isDelivered=!1,d.salesOrderDetail.unitCost=t==null?void 0:t.cost,d.salesOrderDetail.unitPrice=t==null?void 0:t.price,d.salesOrderDetail.lastCost=t==null?void 0:t.lastCost,d.salesOrderDetail.workMasterCost=t==null?void 0:t.workMasterCost,f())},f=()=>{d.salesOrderDetail.amount=d.salesOrderDetail.unitPrice*d.salesOrderDetail.quantity,d.salesOrderDetail.totalCost=d.salesOrderDetail.unitCost*d.salesOrderDetail.quantity},_=ce().shape({quantity:Ue().required("La quantitat és obligatoria").min(1,"La quantitat ha de ser un número positiu")}),r=g({result:!1,errors:{}}),b=()=>{const t=new me(_);r.value=t.validate(d.salesOrderDetail)},M=async()=>{if(b(),r.value.result)d.salesOrderDetail.workOrderId||(d.salesOrderDetail.workOrderId=null),S("submit",d.salesOrderDetail);else{let t="";Object.entries(r.value.errors).forEach(u=>{t+=`${u[1].map(C=>C)}.   `}),E.add({severity:"warn",summary:"Formulari inválid",detail:t,life:5e3})}};return(t,u)=>{const C=D("BaseInput"),h=D("Button");return t.salesOrderDetail?(O(),F("form",rt,[c("div",st,[s(We,{label:"Referència",modelValue:t.salesOrderDetail.referenceId,"onUpdate:modelValue":[u[0]||(u[0]=o=>t.salesOrderDetail.referenceId=o),u[1]||(u[1]=o=>w())],customerId:t.salesOrder.customerId,fullName:!0},null,8,["modelValue","customerId"])]),c("section",null,[c("div",null,[s(C,{class:L(["mb-2",{"p-invalid":r.value.errors.description}]),label:"Descripció",modelValue:t.salesOrderDetail.description,"onUpdate:modelValue":u[2]||(u[2]=o=>t.salesOrderDetail.description=o),type:a(U).TEXT},null,8,["modelValue","type","class"])])]),c("section",lt,[c("div",null,[s(C,{class:L(["mb-2",{"p-invalid":r.value.errors.quantity}]),label:"Quantitat",modelValue:t.salesOrderDetail.quantity,"onUpdate:modelValue":[u[3]||(u[3]=o=>t.salesOrderDetail.quantity=o),u[4]||(u[4]=o=>f())],type:a(U).NUMERIC},null,8,["modelValue","type","class"])]),c("div",null,[s(C,{class:L(["mb-2",{"p-invalid":r.value.errors.amount}]),label:"Total",modelValue:t.salesOrderDetail.amount,"onUpdate:modelValue":u[5]||(u[5]=o=>t.salesOrderDetail.amount=o),type:a(U).CURRENCY,disabled:""},null,8,["modelValue","type","class"])])]),s(h,{label:B.value,onClick:M,style:{float:"right"}},null,8,["label"])])):R("",!0)}}}),dt={key:0},it={key:1},nt=["onClick"],ut={class:"total"},ct={class:"total-text"},mt=Q({__name:"TableSalesOrderDetails",props:{salesOrder:{},salesOrderDetails:{}},emits:["edit","delete","createWorkOrder","openWorkOrder"],setup(T,{emit:S}){const d=T,$=Ne();ee();const E=fe(),B=be(),w=Z(()=>d.salesOrderDetails?d.salesOrderDetails.reduce((o,m)=>o+m.amount,0):0);var f=void 0;const _=g({closable:!0,modal:!0,title:"Generar ordre de fabricació",visible:!1}),r=g([]),b=g({workMasterId:"",plannedDate:"",plannedQuantity:0,comment:""}),M=o=>{d.salesOrder.deliveryNoteId||o.originalEvent.target.className.includes("grid_delete_column_button")||S("edit",o.data)},t=(o,m)=>{$.require({target:o.currentTarget,message:"Está segur que vol eliminar la referència?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{S("delete",m)}})},u=o=>{r.value=E.getByReferenceId(o.referenceId),b.value.workMasterId="",r.value.length>0&&(b.value.workMasterId=r.value[0].id),b.value.plannedQuantity=o.quantity,b.value.plannedDate=d.salesOrder.expectedDate?Be(d.salesOrder.expectedDate):"",b.value.comment="",f=o,_.value.visible=!0},C=o=>{console.log(o),S("openWorkOrder",o)},h=()=>{const o={workOrderDto:b.value,orderDetail:f};_.value.visible=!1,S("createWorkOrder",o)};return(o,m)=>{const e=D("Column"),I=D("Button"),k=D("DataTable"),x=D("Dialog");return O(),F(de,null,[s(k,{onRowClick:M,value:o.salesOrderDetails,tableStyle:"min-width: 100%",class:"p-datatable-sm",sortMode:"single",sortField:"reference.code",sortOrder:1},{header:p(()=>[Te(o.$slots,"header",{},void 0,!0)]),footer:p(()=>[c("div",ut,[c("span",ct,"Total "+G(a(P)(w.value)),1)])]),default:p(()=>[s(e,{field:"quantity",header:"Quantitat",style:{width:"10%"}}),s(e,{header:"Referencia",field:"reference.code",sortable:"",style:{width:"15%"}},{body:p(n=>[s(qe,{id:n.data.referenceId},null,8,["id"])]),_:1}),s(e,{field:"description",header:"Descripció",style:{width:"30%"}}),s(e,{field:"workOrderId",header:"Ordre fabr.",style:{width:"10%"}},{body:p(n=>[a(B).getWorkOrderCodeById(n.data.workOrderId)?(O(),F("div",dt,[s(I,{size:"small",severity:"success",label:a(B).getWorkOrderCodeById(n.data.workOrderId),onClick:V=>C(n.data.workOrderId)},null,8,["label","onClick"])])):(O(),F("div",it,[s(I,{size:"small",icon:a(Y).PLUS_CIRCLE,value:"Generar OF",onClick:V=>u(n.data)},null,8,["icon","onClick"])]))]),_:1}),s(e,{field:"workMasterCost",header:"Cost Teóric",style:{width:"10%"}},{body:p(n=>[j(G(a(P)(n.data.workMasterCost)),1)]),_:1}),s(e,{field:"lastCost",header:"Últim Cost",style:{width:"10%"}},{body:p(n=>[j(G(a(P)(n.data.lastCost)),1)]),_:1}),s(e,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:p(n=>[j(G(a(P)(n.data.unitPrice)),1)]),_:1}),s(e,{field:"amount",header:"Total",style:{width:"10%"}},{body:p(n=>[j(G(a(P)(n.data.amount)),1)]),_:1}),o.salesOrder.deliveryNoteId?R("",!0):(O(),q(e,{key:0,style:{width:"5%"}},{body:p(n=>[n.data.isDelivered?R("",!0):(O(),F("i",{key:0,class:L([a(Y).TIMES,"grid_delete_column_button"]),onClick:V=>t(V,n.data)},null,10,nt))]),_:1}))]),_:3},8,["value"]),s(x,{closable:_.value.closable,visible:_.value.visible,"onUpdate:visible":m[0]||(m[0]=n=>_.value.visible=n),header:_.value.title,modal:_.value.modal,style:{width:"50vw"}},{default:p(()=>[s(Le,{createWorkOrderDto:b.value,"filtered-work-masters":r.value,onSubmit:h},null,8,["createWorkOrderDto","filtered-work-masters"])]),_:1},8,["closable","visible","header","modal"])],64)}}});const pt=oe(mt,[["__scopeId","data-v-e1994675"]]),vt={class:"flex flex-wrap align-items-center justify-content-between gap-2"},ft=c("span",{class:"text-l text-900 font-bold"},"Linies de la comanda",-1),bt="Línia de comanda",Yt=Q({__name:"SalesOrder",setup(T){const S=g(),d=g(N.EDIT),$=Ee(),E=he(),B=xe(),w=K(),f=ie(),_=ne(),r=Me(),b=$e(),M=ue(),t=ee(),u=pe(),C=fe(),h=be(),o=Ae(),m=ve(),{salesOrder:e}=le(f),I=[{label:"Descarregar",icon:Y.FILE_WORD,command:()=>Se()}],k=g(!1),x=g(N.EDIT),n=g(void 0),V=g(0),v=async()=>{const i=$.params.id;await f.GetById(i),t.fetchReferencesByModule("sales"),M.fetchOneByName("SalesOrder"),r.fetchSites(),b.fetchAll(),_.fetchCustomers(),o.fetchAll(),h.fetchBySalesOrder(i),C.workmasters||C.fetchAllActives();let l="";e.value&&(d.value=N.EDIT,l=`Comanda ${e.value.number}`,e.value.date=z(e.value.date),e.value.expectedDate&&(e.value.expectedDate=z(e.value.expectedDate)),e.value.deliveryNoteId?u.GetById(e.value.deliveryNoteId):u.deliveryNote&&(u.deliveryNote=void 0),e.value.budgetId?await m.GetById(e.value.budgetId):m.budget=void 0),B.setMenuItem({icon:Y.BUILDING,backButtonVisible:!0,title:l})};Re(async()=>{await v()});const ye=()=>{S.value.submitForm()},te=(i,l)=>{t.setNewReference(J()),i===N.CREATE&&(l={id:J(),referenceId:"",quantity:0,unitCost:0,unitPrice:0,totalCost:0,amount:0,salesOrderHeaderId:"",lastCost:0,workMasterCost:0,description:"",estimatedDeliveryDate:new Date,isDelivered:!1,isInvoiced:!1,workOrderId:""}),l.salesOrderHeaderId=e.value.id,n.value=l,x.value=i,k.value=!0},Oe=async i=>{let l=!1,y="";l=await f.Update(i.id,i),y=l?"Comanda actualitzada":"Error a l'actualitzar la comanda",w.add({life:5e3,severity:l?"success":"error",summary:y}),l&&E.back()},De=async i=>{x.value===N.CREATE?await f.CreateDetail(i):x.value===N.EDIT&&await f.UpdateDetail(i),k.value=!1,e.value&&(e.value.date=z(e.value.date),e.value.expectedDate&&(e.value.expectedDate=z(e.value.expectedDate)))},_e=async i=>{d.value===N.EDIT&&await f.DeleteDetail(i);const l=e.value.salesOrderDetails.filter(y=>y.id!==i.id);e.value.salesOrderDetails=l,k.value=!1,e.value.date=z(e.value.date)},Ie=async i=>{let l=!1,y="";l=await t.createReference(i),l?y="Referència creada correctament":y="La referència + versió introduïda ja existeix",w.add({severity:l?"success":"warn",summary:y,life:5e3}),l&&(t.setNewReference(J()),V.value=0)},ke=async i=>{const l=await h.create(i.workOrderDto);l.result?(i.orderDetail.workOrderId=l.content.id,await f.UpdateDetail(i.orderDetail)&&(w.add({severity:"success",summary:"Generació OF",detail:`Ordre de fabricació ${l.content.code} generada`}),h.fetchBySalesOrder(e.value.id))):w.add({severity:"error",summary:"Generació OF",detail:"Error al generar la ordre de fabricació"})},we=i=>{E.push({path:`/workorder/${i}`})},Se=async()=>{var l;const i=await Xe.SalesOrder.GetReportDataById(e.value.id);if(i){const y=`Comanda_${(l=e.value)==null?void 0:l.number}.docx`,A=await new je().Download(i,ze.Order,y);A?Fe(y,A):w.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}};return(i,l)=>{const y=D("SplitButton"),ae=D("Button"),A=D("TabPanel"),re=D("TabView"),Ce=D("Dialog");return O(),F(de,null,[s(y,{label:"Guardar",onClick:ye,model:I,size:"small",class:"grid_add_row_button"}),s(at,{class:"mt-3 mb-3",ref_key:"salesOrderForm",ref:S,salesOrder:"salesOrder",onSubmit:Oe},null,512),s(re,null,{default:p(()=>[s(A,{header:"Detall"},{default:p(()=>[a(e)?(O(),q(pt,{key:0,salesOrder:a(e),salesOrderDetails:a(e).salesOrderDetails,onEdit:l[1]||(l[1]=W=>te(a(N).EDIT,W)),onDelete:_e,onCreateWorkOrder:ke,onOpenWorkOrder:we},{header:p(()=>[c("div",vt,[ft,c("section",null,[s(ae,{disabled:a(u).deliveryNote!==void 0,size:"small",label:"Afegir línea",onClick:l[0]||(l[0]=W=>te(a(N).CREATE,{})),class:"mr-2"},null,8,["disabled"])])])]),_:1},8,["salesOrder","salesOrderDetails"])):R("",!0)]),_:1}),s(A,{header:"Fitxers"},{default:p(()=>[a(e)?(O(),q(Pe,{key:0,entity:"SalesOrder",id:a(e).id,title:""},null,8,["id"])):R("",!0)]),_:1})]),_:1}),a(e)?(O(),q(Ce,{key:0,closable:!0,visible:k.value,"onUpdate:visible":l[3]||(l[3]=W=>k.value=W),header:bt,modal:!0},{default:p(()=>[s(re,{activeIndex:V.value,"onUpdate:activeIndex":l[2]||(l[2]=W=>V.value=W)},{default:p(()=>[s(A,{header:"Línea"},{default:p(()=>[n.value?(O(),q(ot,{key:0,formAction:x.value,salesOrder:a(e),salesOrderDetail:n.value,onSubmit:De},null,8,["formAction","salesOrder","salesOrderDetail"])):R("",!0)]),_:1}),s(A,{header:"Referencia"},{default:p(()=>[a(t).reference?(O(),q(Ge,{key:0,module:"sales",reference:a(t).reference,defaultCustomerId:a(e).customerId,onSubmit:Ie},null,8,["reference","defaultCustomerId"])):R("",!0)]),_:1})]),_:1},8,["activeIndex"])]),_:1},8,["visible"])):R("",!0)],64)}}});export{Yt as default};

import{d as H,z as ee,o as Q,r as B,j as X,h as y,a as R,c as O,k as t,e as n,i as l,y as z,n as M,s as L,D as k,l as G,p as re,b as ie,f as ue,J as te,F as x,m as q,w as f,P as W,C as $,v as de,g as ce,u as me,G as pe}from"./index-f764b8b4.js";import{a as oe,u as J}from"./purchaseInvoices-d864b7e8.js";import{g as ae,f as ve}from"./functions-c791afc8.js";import{F as Ie}from"./FileEntityPicker-445c04ad.js";import{c as se,a as Z,F as ne,d as be}from"./form-validator-2ae99928.js";import{l as K}from"./lodash-fe271315.js";import"./index-7bda243d.js";import"./base.service-ff0cada2.js";import"./index-a969398a.js";import"./suppliers.service-143618bb.js";import"./v4-a960c1f4.js";import"./file.service-9455ef3e.js";const U=C=>(re("data-v-ee6a1367"),C=C(),ie(),C),fe={key:0},_e={class:"four-columns"},he=U(()=>n("label",{class:"block text-900 mb-2"},"Exercici",-1)),Ae=U(()=>n("label",{class:"block text-900 mb-2"},"Sèrie",-1)),xe=U(()=>n("label",{class:"block text-900 mb-2"},"Estat",-1)),ye={class:"four-columns"},Ve={class:"mt-1"},De=U(()=>n("label",{class:"block text-900 mb-2"},"Proveïdor",-1)),ge={class:"mt-1"},we={class:"mt-1"},Te=U(()=>n("label",{class:"block text-900 mb-2"},"Data Factura",-1)),Ee={class:"mt-1"},Fe=U(()=>n("label",{class:"block text-900 mb-2"},"Forma de pagament",-1)),Ce={class:"four-columns"},Pe={class:"mt-1"},Se={class:"mt-1"},ke={class:"mt-1"},Ue={class:"four-columns"},Ne={class:"mt-1"},Re=U(()=>n("label",{class:"block text-900 mb-2"},"Base",-1)),Be={class:"summary-field"},Me={class:"mt-1"},$e=U(()=>n("label",{class:"block text-900 mb-2"},"Impostos",-1)),Le={class:"summary-field"},Ye={class:"mt-1"},ze=U(()=>n("label",{class:"block text-900 mb-2"},"Total",-1)),Ge={class:"summary-field"},je=H({__name:"FormPurchaseInvoice",emits:["submit","cancel"],setup(C,{expose:w,emit:v}){const D=oe(),g=J(),{purchaseInvoice:e}=ee(D);Q(()=>{setTimeout(()=>{e.value&&e.value.purchaseInvoiceImports.length>0&&(e.value.taxAmount=h())},500)});const E=se().shape({exerciceId:Z().required("L'exercici es obligatori"),supplierId:Z().required("El proveïdor es obligatori")}),p=B({result:!1,errors:{}}),s=()=>{const c=new ne(E);p.value=c.validate(e.value)},V=()=>{var c;return((c=e.value)==null?void 0:c.purchaseInvoiceImports.length)===0?(a.add({severity:"warn",summary:"Formulari inválid",detail:"Ha d'introduir els imports de factura",life:5e3}),!1):!0};let I=!1;Q(()=>{setTimeout(()=>{I=!0},500)});const a=X(),u=async()=>{if(s(),p.value.result){if(!V())return;v("submit",e.value)}else{let c="";Object.entries(p.value.errors).forEach(o=>{c+=`${o[1].map(b=>b)}.   `}),a.add({severity:"warn",summary:"Formulari inválid",detail:c,life:5e3})}},m=()=>{var o;const c=(o=g.masterData.suppliers)==null?void 0:o.find(b=>{var F;return b.id===((F=e.value)==null?void 0:F.supplierId)});c&&(e.value.paymentMethodId=c.paymentMethodId,_())},_=async()=>{if(I){if(e.value){let c=0,o=0,b=0,F=0,r=0,d=0,i=0,A=0,T=0,P=0;c=Y(),F=h(),e.value.transportAmount&&(o=parseFloat(e.value.transportAmount.toFixed(2))),e.value.discountPercentage&&(i=parseFloat(e.value.discountPercentage.toFixed(2))),e.value.extraTaxPercentatge&&(T=e.value.extraTaxPercentatge),b=(c+o)*1,P=b*(T/100),A=b+F*1-P*1,d=A*(1*i)/100,r=parseFloat((A-d).toFixed(2)),e.value.baseAmount=c,e.value.transportAmount=o,e.value.subtotal=b,e.value.taxAmount=F,e.value.grossAmount=A,e.value.netAmount=r,e.value.discountPercentage=i,e.value.discountAmount=d,e.value.extraTaxPercentatge=T,e.value.extraTaxAmount=P,e.value.purchaseInvoiceDueDates=await D.GetDueDates(e.value)}console.log("calcAmounts",e.value)}},Y=()=>{let c=0;return e.value&&e.value.purchaseInvoiceImports.forEach(o=>c+=o.baseAmount),c},h=()=>{let c=0;return e.value&&e.value.purchaseInvoiceImports.forEach(o=>c+=o.taxAmount),c};return w({submitForm:u,calcAmounts:_}),(c,o)=>{const b=y("Dropdown"),F=y("Calendar");return R(),O("div",null,[t(e)?(R(),O("form",fe,[n("section",_e,[l(z,{label:"Num. Fra. Intern",id:"number",modelValue:t(e).number,"onUpdate:modelValue":o[0]||(o[0]=r=>t(e).number=r),disabled:""},null,8,["modelValue"]),n("div",null,[he,l(b,{modelValue:t(e).exerciceId,"onUpdate:modelValue":o[1]||(o[1]=r=>t(e).exerciceId=r),editable:"",options:t(g).masterData.exercises,optionValue:"id",optionLabel:"name",class:M(["w-full",{"p-invalid":p.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),n("div",null,[Ae,l(b,{modelValue:t(e).purchaseInvoiceSerieId,"onUpdate:modelValue":o[2]||(o[2]=r=>t(e).purchaseInvoiceSerieId=r),editable:"",options:t(g).masterData.series,optionValue:"id",optionLabel:"name",class:M(["w-full",{"p-invalid":p.value.errors.purchaseInvoiceSerieId}])},null,8,["modelValue","options","class"])]),n("div",null,[xe,l(b,{modelValue:t(e).purchaseInvoiceStatusId,"onUpdate:modelValue":o[3]||(o[3]=r=>t(e).purchaseInvoiceStatusId=r),editable:"",options:t(g).masterData.statuses,optionValue:"id",optionLabel:"name",class:M(["w-full",{"p-invalid":p.value.errors.purchaseInvoiceStatusId}])},null,8,["modelValue","options","class"])])]),n("section",ye,[n("div",Ve,[De,l(b,{modelValue:t(e).supplierId,"onUpdate:modelValue":o[4]||(o[4]=r=>t(e).supplierId=r),editable:"",options:t(g).masterData.suppliers,optionValue:"id",optionLabel:"comercialName",onChange:m,class:M(["w-full",{"p-invalid":p.value.errors.supplierId}])},null,8,["modelValue","options","class"])]),n("div",ge,[l(z,{label:"Num. Fra. Proveïdor",id:"supplierNumber",modelValue:t(e).supplierNumber,"onUpdate:modelValue":o[5]||(o[5]=r=>t(e).supplierNumber=r)},null,8,["modelValue"])]),n("div",we,[Te,l(F,{id:"purchaseInvoiceDate",modelValue:t(e).purchaseInvoiceDate,"onUpdate:modelValue":o[6]||(o[6]=r=>t(e).purchaseInvoiceDate=r),onDateSelect:o[7]||(o[7]=r=>_())},null,8,["modelValue"])]),n("div",Ee,[Fe,l(b,{modelValue:t(e).paymentMethodId,"onUpdate:modelValue":[o[8]||(o[8]=r=>t(e).paymentMethodId=r),o[9]||(o[9]=r=>_())],editable:"",options:t(g).masterData.paymentMethods,optionValue:"id",optionLabel:"name",class:M(["w-full",{"p-invalid":p.value.errors.paymentmethod}])},null,8,["modelValue","options","class"])])]),n("section",Ce,[n("div",Pe,[l(z,{type:t(L).CURRENCY,label:"Ports",id:"transportAmount",modelValue:t(e).transportAmount,"onUpdate:modelValue":[o[10]||(o[10]=r=>t(e).transportAmount=r),o[11]||(o[11]=r=>_())]},null,8,["type","modelValue"])]),n("div",Se,[l(z,{type:t(L).NUMERIC,label:"% IRPF",id:"extraTaxPercentatge",modelValue:t(e).extraTaxPercentatge,"onUpdate:modelValue":[o[12]||(o[12]=r=>t(e).extraTaxPercentatge=r),o[13]||(o[13]=r=>_())]},null,8,["type","modelValue"])]),n("div",ke,[l(z,{type:t(L).NUMERIC,label:"% Dto.",id:"discountPercentage",modelValue:t(e).discountPercentage,"onUpdate:modelValue":[o[14]||(o[14]=r=>t(e).discountPercentage=r),o[15]||(o[15]=r=>_())]},null,8,["type","modelValue"])])]),n("section",Ue,[n("div",Ne,[Re,n("span",Be,k(t(e).baseAmount)+" €",1)]),n("div",Me,[$e,n("span",Le,k(t(e).taxAmount)+" €",1)]),n("div",Ye,[ze,n("span",Ge,k(t(e).netAmount)+" €",1)])])])):G("",!0)])}}});const qe=ue(je,[["__scopeId","data-v-ee6a1367"]]),Oe={key:0},He={class:"two-columns"},Je=n("label",{class:"block text-900 mb-2"},"IVA",-1),Ke={class:"two-columns"},Qe=H({__name:"FormPurchaseInvoiceImport",props:{formAction:{},invoiceImport:{}},emits:["submit"],setup(C,{emit:w}){const v=C,D=J(),g=X(),e=te(()=>v.formAction===x.CREATE?"Afegir":"Modificar"),E=()=>{const a=D.masterData.taxes.find(u=>u.id===v.invoiceImport.taxId);if(a&&K.isNumber(v.invoiceImport.baseAmount)){const u=v.invoiceImport.baseAmount,m=u/100*a.percentatge,_=u+m;v.invoiceImport.baseAmount=u,v.invoiceImport.taxAmount=K.round(m,2),v.invoiceImport.netAmount=K.round(_,2)}},p=se().shape({baseAmount:be().required("L'import base és obligatori").min(1,"L'import base ha de ser un número positiu")}),s=B({result:!1,errors:{}}),V=()=>{const a=new ne(p);s.value=a.validate(v.invoiceImport)},I=async()=>{if(V(),s.value.result)w("submit",v.invoiceImport);else{let a="";Object.entries(s.value.errors).forEach(u=>{a+=`${u[1].map(m=>m)}.   `}),g.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}};return(a,u)=>{const m=y("BaseInput"),_=y("Dropdown"),Y=y("Button");return a.invoiceImport?(R(),O("form",Oe,[n("section",He,[l(m,{class:M(["mb-2",{"p-invalid":s.value.errors.baseAmount}]),label:"Import Base",modelValue:a.invoiceImport.baseAmount,"onUpdate:modelValue":[u[0]||(u[0]=h=>a.invoiceImport.baseAmount=h),u[1]||(u[1]=h=>E())],type:t(L).CURRENCY},null,8,["modelValue","type","class"]),n("div",null,[Je,l(_,{modelValue:a.invoiceImport.taxId,"onUpdate:modelValue":[u[2]||(u[2]=h=>a.invoiceImport.taxId=h),u[3]||(u[3]=h=>E())],editable:"",options:t(D).masterData.taxes,optionValue:"id",optionLabel:"name"},null,8,["modelValue","options"])])]),n("section",Ke,[l(m,{class:"mb-2",label:"Import Impost",modelValue:a.invoiceImport.taxAmount,"onUpdate:modelValue":u[4]||(u[4]=h=>a.invoiceImport.taxAmount=h),type:t(L).CURRENCY,disabled:""},null,8,["modelValue","type"]),l(m,{class:"mb-2",label:"Total",modelValue:a.invoiceImport.netAmount,"onUpdate:modelValue":u[5]||(u[5]=h=>a.invoiceImport.netAmount=h),type:t(L).CURRENCY,disabled:""},null,8,["modelValue","type"])]),l(Y,{label:e.value,onClick:I,style:{float:"right"}},null,8,["label"])])):G("",!0)}}}),We=["onClick"],Xe=H({__name:"TablePurchaseInvoiceImports",props:{purchaseInvoiceImports:{}},emits:["add","edit","delete"],setup(C,{emit:w}){const v=C,D=J(),g=s=>{var I;const V=(I=D.masterData.taxes)==null?void 0:I.find(a=>a.id===s);if(V)return V.percentatge},e=()=>{var I;const s=(I=D.masterData.taxes)==null?void 0:I.find(a=>a.name.includes("21")),V={id:ae(),baseAmount:null,taxId:s?s.id:"",taxAmount:0,netAmount:0,purchaseInvoiceId:""};w("add",V)},E=s=>{s.originalEvent.target.className.includes("grid_delete_column_button")||w("edit",s.data)},p=(s,V)=>{w("delete",V)};return(s,V)=>{const I=y("Button"),a=y("Column"),u=y("DataTable");return R(),q(u,{onRowClick:E,value:v.purchaseInvoiceImports,tableStyle:"min-width: 100%"},{default:f(()=>[l(I,{onClick:e,rounded:"",icon:t(W).PLUS,class:"grid_add_row_button",style:{"margin-right":"1.5rem"}},null,8,["icon"]),l(a,{field:"baseAmount",header:"Base",style:{width:"25%"}},{body:f(m=>[$(k(m.data.baseAmount)+" € ",1)]),_:1}),l(a,{field:"taxId",header:"% IVA",style:{width:"25%"}},{body:f(m=>[$(k(g(m.data.taxId)),1)]),_:1}),l(a,{field:"taxAmount",header:"Cuota IVA",style:{width:"25%"}},{body:f(m=>[$(k(m.data.taxAmount)+" € ",1)]),_:1}),l(a,{field:"netAmount",header:"Total",style:{width:"25%"}},{body:f(m=>[$(k(m.data.netAmount)+" € ",1)]),_:1}),l(a,{style:{width:"10%"}},{body:f(m=>[n("i",{class:M([t(W).TIMES,"grid_delete_column_button"]),onClick:_=>p(_,m.data)},null,10,We)]),_:1})]),_:1},8,["value"])}}}),ct=H({__name:"PurchaseInvoice",setup(C){const w=B(),v=B(x.EDIT),D=de(),g=ce(),e=me(),E=J(),p=oe(),{purchaseInvoice:s}=ee(p),V=te(()=>a.value===x.CREATE?"Introducció import":"Modificació import"),I=B(!1),a=B(x.EDIT),u=B(void 0),m=async()=>{let d="";await p.GetById(D.params.id),s.value?(v.value=x.EDIT,d=`Factura de compra: ${s.value.number}`,s.value.purchaseInvoiceDate=new Date(s.value.purchaseInvoiceDate)):(v.value=x.CREATE,p.setNewPurchaseInvoice(D.params.id),d="Alta de factures de compra",_()),e.setMenuItem({icon:W.POUND,backButtonVisible:!0,title:d})},_=()=>{var d,i,A;if(s.value){const T=(d=E.masterData.exercises)==null?void 0:d.find(N=>N.name===new Date().getFullYear().toString());T&&(s.value.exerciceId=T.id);const P=(i=E.masterData.series)==null?void 0:i.find(N=>N.name==="Nacional");P&&(s.value.purchaseInvoiceSerieId=P.id);const j=(A=E.masterData.statuses)==null?void 0:A.find(N=>N.name==="Nova");j&&(s.value.purchaseInvoiceStatusId=j.id)}};Q(async()=>{await m()});const Y=()=>{w.value.submitForm()},h=(d,i)=>{d===x.CREATE&&(i.id=ae()),i.purchaseInvoiceId=s.value.id,u.value=i,a.value=d,I.value=!0},c=X(),o=async d=>{let i=!1,A="";v.value===x.CREATE?(i=await p.Create(d),A=i?"Factura creada":"Error al crear la factura"):(i=await p.Update(d),A=i?"Factura actualizada":"Error al actualizar la factura"),c.add({life:5e3,severity:i?"success":"error",summary:A}),i&&g.back()},b=async d=>{var i;a.value===x.CREATE?(v.value===x.EDIT&&await p.CreateInvoiceImport(d),(i=s.value)==null||i.purchaseInvoiceImports.push(d)):a.value===x.EDIT&&v.value===x.EDIT&&await p.UpdateInvoiceImport(d),r()},F=async d=>{v.value===x.EDIT&&await p.DeleteInvoiceImport(d);const i=s.value.purchaseInvoiceImports.filter(A=>A.id!==d.id);s.value.purchaseInvoiceImports=i,r()},r=()=>{w.value.calcAmounts(),I.value=!1};return(d,i)=>{const A=y("Button"),T=y("TabPanel"),P=y("Column"),j=y("DataTable"),N=y("TabView"),le=y("Dialog");return R(),O(pe,null,[l(A,{label:"Guardar",class:"grid_add_row_button",onClick:Y}),l(N,null,{default:f(()=>[t(s)?(R(),q(T,{key:0,header:"Factura"},{default:f(()=>[l(qe,{ref_key:"purchaseInvoiceForm",ref:w,purchaseInvoice:t(s),onSubmit:o},null,8,["purchaseInvoice"]),l(N,null,{default:f(()=>[l(T,{header:"Imports"},{default:f(()=>[l(Xe,{"purchase-invoice-imports":t(s).purchaseInvoiceImports,onAdd:i[0]||(i[0]=S=>h(t(x).CREATE,S)),onEdit:i[1]||(i[1]=S=>h(t(x).EDIT,S)),onDelete:F},null,8,["purchase-invoice-imports"])]),_:1}),l(T,{header:"Venciments"},{default:f(()=>[l(j,{value:t(s).purchaseInvoiceDueDates,tableStyle:"min-width: 100%"},{default:f(()=>[l(P,{field:"dueDate",header:"Venciment",style:{width:"50%"}},{body:f(S=>[$(k(t(ve)(S.data.dueDate)),1)]),_:1}),l(P,{field:"amount",header:"Import",style:{width:"50%"}},{body:f(S=>[$(k(S.data.amount)+" € ",1)]),_:1})]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})):G("",!0),l(T,{header:"Fitxers"},{default:f(()=>[t(s)?(R(),q(Ie,{key:0,title:"Factures",entity:"PurchaseInvoice",id:t(D).params.id},null,8,["id"])):G("",!0)]),_:1})]),_:1}),u.value?(R(),q(le,{key:0,closable:!0,visible:I.value,"onUpdate:visible":i[2]||(i[2]=S=>I.value=S),header:V.value,position:"bottom"},{default:f(()=>[l(Qe,{formAction:a.value,invoiceImport:u.value,onSubmit:b},null,8,["formAction","invoiceImport"])]),_:1},8,["visible","header"])):G("",!0)],64)}}});export{ct as default};

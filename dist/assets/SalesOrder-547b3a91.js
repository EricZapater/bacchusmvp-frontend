import{d as z,j as H,z as ae,H as re,r as C,h as y,a as S,c as R,k as r,e as c,i,s as U,n as W,l as B,p as ke,b as Ie,f as we,F as N,x as Ce,w as v,K as Ne,C as X,D as Y,P as G,m as L,G as le,v as ge,g as Ve,u as Te,o as Ee}from"./index-50afd4ff.js";import{c as te,d as xe,b as Re,f as M,g as Q}from"./functions-79f2dbc4.js";import{u as se}from"./order-579fa23f.js";import{u as J}from"./reference-a134c9cc.js";import{u as oe}from"./customers-70b3c096.js";import{u as Be}from"./exercise-4ae30843.js";import{u as he}from"./plantmodel-7022a20f.js";import{u as ie}from"./lifecycle-31bb0ab7.js";import{u as Fe}from"./tax-b800d280.js";import{c as de,a as P,F as ne,d as $e}from"./form-validator-f8953ae6.js";import{u as ue}from"./deliveryNote-7e0ab724.js";import{_ as Ue}from"./DropdownReference.vue_vue_type_script_setup_true_lang-a3f5dbf0.js";import{_ as Ae}from"./FormCreateWorkorder.vue_vue_type_script_setup_true_lang-b66a4786.js";import{u as ce}from"./workmaster-c0fa2b81.js";import{u as me}from"./workorder-69844914.js";import{_ as We}from"./FormReference.vue_vue_type_script_setup_true_lang-eb023d8e.js";import{F as qe}from"./FileEntityPicker-201b3d37.js";import{a as Me,b as Le}from"./report.service-cf1444d8.js";import{S as Pe}from"./index-25bebf38.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./reference.service-b9737163.js";import"./base.service-f381296e.js";import"./index-fe67f03a.js";import"./index-fa80c822.js";import"./referenceType-0669c5e3.js";import"./file.service-b6df2258.js";import"./index-da4881e1.js";const j=g=>(ke("data-v-a817269d"),g=g(),Ie(),g),Ge={key:0},ze={class:"four-columns mt-2"},je=j(()=>c("label",{class:"block text-900 mb-2"},"Data Alta",-1)),Xe=j(()=>c("label",{class:"block text-900 mb-2"},"Data Entrega",-1)),Ye={class:"four-columns mt-2"},Qe=j(()=>c("label",{class:"block text-900 mb-2"},"Estat",-1)),He=j(()=>c("label",{class:"block text-900 mb-2"},"Client",-1)),Je=z({__name:"FormSalesOrder",emits:["submit","cancel"],setup(g,{expose:I,emit:n}){const h=se(),V=oe(),F=ie(),D=ue(),f=H(),{salesOrder:t}=ae(h),p=re(()=>D.deliveryNote?D.deliveryNote.number:""),_=de().shape({siteId:P().required("L'origen es obligatori"),customerId:P().required("El client es obligatori"),statusId:P().required("L'estat es obligatori"),exerciseId:P().required("L'exercici es obligatori")}),w=C({result:!1,errors:{}}),s=()=>{const a=new ne(_);w.value=a.validate(t.value)};I({submitForm:async()=>{if(s(),w.value.result)T(),n("submit",t.value);else{let a="";Object.entries(w.value.errors).forEach(e=>{a+=`${e[1].map(m=>m)}.   `}),f.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}}});const k=()=>{var e;const a=(e=V.customers)==null?void 0:e.find(m=>{var b;return m.id===((b=t.value)==null?void 0:b.customerId)});a&&t.value&&(t.value.customerCode=a.code,t.value.customerComercialName=a.comercialName,t.value.customerTaxName=a.taxName,t.value.customerVatNumber=a.vatNumber,t.value.customerAccountNumber=a.accountNumber)},T=()=>{t.value&&(t.value.salesOrderDate=te(t.value.salesOrderDate),t.value.expectedDate&&(t.value.expectedDate=te(t.value.expectedDate)))};return(a,e)=>{var x;const m=y("BaseInput"),b=y("Calendar"),E=y("Dropdown");return S(),R("div",null,[r(t)?(S(),R("form",Ge,[c("section",ze,[c("div",null,[i(m,{type:r(U).TEXT,label:"Num. Comanda",id:"salesOrderNumber",modelValue:r(t).salesOrderNumber,"onUpdate:modelValue":e[0]||(e[0]=l=>r(t).salesOrderNumber=l),disabled:""},null,8,["type","modelValue"])]),c("div",null,[i(m,{type:r(U).TEXT,label:"Num. Pressupost",id:"budgetNumber",modelValue:r(t).budgetNumber,"onUpdate:modelValue":e[1]||(e[1]=l=>r(t).budgetNumber=l),disabled:""},null,8,["type","modelValue"])]),c("div",null,[je,i(b,{modelValue:r(t).salesOrderDate,"onUpdate:modelValue":e[2]||(e[2]=l=>r(t).salesOrderDate=l),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),c("div",null,[Xe,i(b,{modelValue:r(t).expectedDate,"onUpdate:modelValue":e[3]||(e[3]=l=>r(t).expectedDate=l),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),c("section",Ye,[c("div",null,[Qe,i(E,{modelValue:r(t).statusId,"onUpdate:modelValue":e[4]||(e[4]=l=>r(t).statusId=l),editable:"",options:(x=r(F).lifecycle)==null?void 0:x.statuses,optionValue:"id",optionLabel:"name",class:W(["w-full",{"p-invalid":w.value.errors.statusId}])},null,8,["modelValue","options","class"])]),c("div",null,[He,i(E,{modelValue:r(t).customerId,"onUpdate:modelValue":[e[5]||(e[5]=l=>r(t).customerId=l),e[6]||(e[6]=l=>k())],editable:"",options:r(V).customers,optionValue:"id",optionLabel:"comercialName",class:W(["w-full",{"p-invalid":w.value.errors.customerId}])},null,8,["modelValue","options","class"])]),c("div",null,[i(m,{type:r(U).TEXT,label:"Comanda Client",id:"customerSalesOrderNumber",modelValue:r(t).customerSalesOrderNumber,"onUpdate:modelValue":e[7]||(e[7]=l=>r(t).customerSalesOrderNumber=l)},null,8,["type","modelValue"])]),c("div",null,[i(m,{type:r(U).TEXT,disabled:!0,label:"Albarà Entrega",id:"deliveryNote",modelValue:p.value,"onUpdate:modelValue":e[8]||(e[8]=l=>p.value=l)},null,8,["type","modelValue"])])])])):B("",!0)])}}});const Ke=we(Je,[["__scopeId","data-v-a817269d"]]),Ze={key:0},et={class:"mb-2"},tt={class:"two-columns"},at=z({__name:"FormSalesOrderDetail",props:{formAction:{},salesOrderDetail:{}},emits:["submit"],setup(g,{emit:I}){const n=g,h=J(),V=H(),F=re(()=>n.formAction===N.CREATE?"Afegir":"Modificar"),D=()=>{const s=h.references.find(u=>u.id===n.salesOrderDetail.referenceId);s&&(n.salesOrderDetail.description=s.description,n.salesOrderDetail.isInvoiced=!1,n.salesOrderDetail.isDelivered=!1,n.salesOrderDetail.unitCost=s==null?void 0:s.cost,n.salesOrderDetail.unitPrice=s==null?void 0:s.price,f())},f=()=>{n.salesOrderDetail.amount=n.salesOrderDetail.unitPrice*n.salesOrderDetail.quantity,n.salesOrderDetail.totalCost=n.salesOrderDetail.unitCost*n.salesOrderDetail.quantity},t=de().shape({quantity:$e().required("La quantitat és obligatoria").min(1,"La quantitat ha de ser un número positiu")}),p=C({result:!1,errors:{}}),_=()=>{const s=new ne(t);p.value=s.validate(n.salesOrderDetail)},w=async()=>{if(_(),p.value.result)I("submit",n.salesOrderDetail);else{let s="";Object.entries(p.value.errors).forEach(u=>{s+=`${u[1].map(k=>k)}.   `}),V.add({severity:"warn",summary:"Formulari inválid",detail:s,life:5e3})}};return(s,u)=>{const k=y("BaseInput"),T=y("Button");return s.salesOrderDetail?(S(),R("form",Ze,[c("div",et,[i(Ue,{label:"Referència",modelValue:s.salesOrderDetail.referenceId,"onUpdate:modelValue":[u[0]||(u[0]=a=>s.salesOrderDetail.referenceId=a),u[1]||(u[1]=a=>D())],fullName:!0},null,8,["modelValue"])]),c("section",null,[c("div",null,[i(k,{class:W(["mb-2",{"p-invalid":p.value.errors.description}]),label:"Descripció",modelValue:s.salesOrderDetail.description,"onUpdate:modelValue":u[2]||(u[2]=a=>s.salesOrderDetail.description=a),type:r(U).TEXT},null,8,["modelValue","type","class"])])]),c("section",tt,[c("div",null,[i(k,{class:W(["mb-2",{"p-invalid":p.value.errors.quantity}]),label:"Quantitat",modelValue:s.salesOrderDetail.quantity,"onUpdate:modelValue":[u[3]||(u[3]=a=>s.salesOrderDetail.quantity=a),u[4]||(u[4]=a=>f())],type:r(U).NUMERIC},null,8,["modelValue","type","class"])]),c("div",null,[i(k,{class:W(["mb-2",{"p-invalid":p.value.errors.amount}]),label:"Total",modelValue:s.salesOrderDetail.amount,"onUpdate:modelValue":u[5]||(u[5]=a=>s.salesOrderDetail.amount=a),type:r(U).CURRENCY,disabled:""},null,8,["modelValue","type","class"])])]),i(T,{label:F.value,onClick:w,style:{float:"right"}},null,8,["label"])])):B("",!0)}}}),rt={key:0},lt={key:1},st=["onClick"],ot=z({__name:"TableSalesOrderDetails",props:{salesOrder:{},salesOrderDetails:{}},emits:["edit","delete","createWorkOrder","openWorkOrder"],setup(g,{emit:I}){const n=g,h=Ce(),V=J(),F=ce(),D=me();var f=void 0;const t=C({closable:!0,modal:!0,title:"Generar ordre de fabricació",visible:!1}),p=C([]),_=C({workMasterId:"",plannedDate:"",plannedQuantity:0,comment:""}),w=a=>{n.salesOrder.deliveryNoteId||a.originalEvent.target.className.includes("grid_delete_column_button")||I("edit",a.data)},s=(a,e)=>{h.require({target:a.currentTarget,message:"Está segur que vol eliminar la referència?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{I("delete",e)}})},u=a=>{p.value=F.getByReferenceId(a.referenceId),_.value.workMasterId="",p.value.length>0&&(_.value.workMasterId=p.value[0].id),_.value.plannedQuantity=a.quantity,_.value.plannedDate=n.salesOrder.expectedDate?xe(n.salesOrder.expectedDate):"",_.value.comment="",f=a,t.value.visible=!0},k=a=>{console.log(a),I("openWorkOrder",a)},T=()=>{const a={workOrderDto:_.value,orderDetail:f};t.value.visible=!1,I("createWorkOrder",a)};return(a,e)=>{const m=y("Column"),b=y("Button"),E=y("DataTable"),x=y("Dialog");return S(),R(le,null,[i(E,{onRowClick:w,value:a.salesOrderDetails,tableStyle:"min-width: 100%",class:"p-datatable-sm"},{header:v(()=>[Ne(a.$slots,"header")]),default:v(()=>[i(m,{field:"quantity",header:"Quantitat",style:{width:"10%"}}),i(m,{header:"Referencia",style:{width:"15%"}},{body:v(l=>[X(Y(r(V).getShortNameById(l.data.referenceId)),1)]),_:1}),i(m,{field:"description",header:"Descripció",style:{width:"30%"}}),i(m,{field:"workOrderId",header:"Ordre fabr.",style:{width:"10%"}},{body:v(l=>[r(D).getWorkOrderCodeById(l.data.workOrderId)?(S(),R("div",rt,[i(b,{size:"small",severity:"success",label:r(D).getWorkOrderCodeById(l.data.workOrderId),onClick:q=>k(l.data.workOrderId)},null,8,["label","onClick"])])):(S(),R("div",lt,[i(b,{size:"small",icon:r(G).PLUS_CIRCLE,value:"Generar OF",onClick:q=>u(l.data)},null,8,["icon","onClick"])]))]),_:1}),i(m,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:v(l=>[X(Y(l.data.unitPrice)+" € ",1)]),_:1}),i(m,{field:"amount",header:"Total",style:{width:"10%"}},{body:v(l=>[X(Y(l.data.amount)+" € ",1)]),_:1}),a.salesOrder.deliveryNoteId?B("",!0):(S(),L(m,{key:0,style:{width:"5%"}},{body:v(l=>[l.data.isDelivered?B("",!0):(S(),R("i",{key:0,class:W([r(G).TIMES,"grid_delete_column_button"]),onClick:q=>s(q,l.data)},null,10,st))]),_:1}))]),_:3},8,["value"]),i(x,{closable:t.value.closable,visible:t.value.visible,"onUpdate:visible":e[0]||(e[0]=l=>t.value.visible=l),header:t.value.title,modal:t.value.modal,style:{width:"50vw"}},{default:v(()=>[i(Ae,{createWorkOrderDto:_.value,"filtered-work-masters":p.value,onSubmit:T},null,8,["createWorkOrderDto","filtered-work-masters"])]),_:1},8,["closable","visible","header","modal"])],64)}}}),it={class:"flex flex-wrap align-items-center justify-content-between gap-2"},dt=c("span",{class:"text-l text-900 font-bold"},"Linies de la comanda",-1),nt="Línia de comanda",At=z({__name:"SalesOrder",setup(g){const I=C(),n=C(N.EDIT),h=ge(),V=Ve(),F=Te(),D=H(),f=se(),t=oe(),p=he(),_=Be(),w=ie(),s=J(),u=ue(),k=ce(),T=me(),a=Fe(),{salesOrder:e}=ae(f),m=[{label:"Descarregar",icon:G.FILE_WORD,command:()=>_e()}],b=C(!1),E=C(N.EDIT),x=C(void 0),l=C(0),q=async()=>{const d=h.params.id;await f.GetById(d),s.fetchReferencesByModule("sales"),w.fetchOneByName("SalesOrder"),p.fetchSites(),_.fetchAll(),t.fetchCustomers(),a.fetchAll(),T.fetchBySalesOrder(d),k.workmasters||k.fetchAllActives();let o="";e.value&&(n.value=N.EDIT,o=`Comanda ${e.value.salesOrderNumber}`,e.value.salesOrderDate=M(e.value.salesOrderDate),e.value.expectedDate&&(e.value.expectedDate=M(e.value.expectedDate)),e.value.deliveryNoteId?u.GetById(e.value.deliveryNoteId):u.deliveryNote&&(u.deliveryNote=void 0)),F.setMenuItem({icon:G.BUILDING,backButtonVisible:!0,title:o})};Ee(async()=>{await q()});const pe=()=>{I.value.submitForm()},K=(d,o)=>{s.setNewReference(Q()),d===N.CREATE&&(o={id:Q(),referenceId:"",quantity:0,unitCost:0,unitPrice:0,totalCost:0,amount:0,salesOrderHeaderId:"",description:"",estimatedDeliveryDate:new Date,isDelivered:!1,isInvoiced:!1}),o.salesOrderHeaderId=e.value.id,x.value=o,E.value=d,b.value=!0},ve=async d=>{let o=!1,O="";o=await f.Update(d.id,d),O=o?"Comanda actualitzada":"Error a l'actualitzar la comanda",D.add({life:5e3,severity:o?"success":"error",summary:O}),o&&V.back()},fe=async d=>{E.value===N.CREATE?await f.CreateDetail(d):E.value===N.EDIT&&await f.UpdateDetail(d),b.value=!1,e.value&&(e.value.salesOrderDate=M(e.value.salesOrderDate),e.value.expectedDate&&(e.value.expectedDate=M(e.value.expectedDate)))},be=async d=>{n.value===N.EDIT&&await f.DeleteDetail(d);const o=e.value.salesOrderDetails.filter(O=>O.id!==d.id);e.value.salesOrderDetails=o,b.value=!1,e.value.salesOrderDate=M(e.value.salesOrderDate)},Oe=async d=>{let o=!1,O="";o=await s.createReference(d),o?O="Referència creada correctament":O="La referència + versió introduïda ja existeix",D.add({severity:o?"success":"warn",summary:O,life:5e3}),o&&(s.setNewReference(Q()),l.value=0)},ye=async d=>{const o=await T.create(d.workOrderDto);o.result?(d.orderDetail.workOrderId=o.content.id,await f.UpdateDetail(d.orderDetail)&&(D.add({severity:"success",summary:"Generació OF",detail:`Ordre de fabricació ${o.content.code} generada`}),T.fetchBySalesOrder(e.value.id))):D.add({severity:"error",summary:"Generació OF",detail:"Error al generar la ordre de fabricació"})},De=d=>{V.push({path:`/workorder/${d}`})},_e=async()=>{var o;const d=await Pe.SalesOrder.GetReportDataById(e.value.id);if(d){const O=`Comanda_${(o=e.value)==null?void 0:o.salesOrderNumber}.docx`,$=await new Le().Download(d,Me.Order,O);$?Re(O,$):D.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}};return(d,o)=>{const O=y("SplitButton"),Z=y("Button"),$=y("TabPanel"),ee=y("TabView"),Se=y("Dialog");return S(),R(le,null,[i(O,{label:"Guardar",onClick:pe,model:m,size:"small",class:"grid_add_row_button"}),i(Ke,{class:"mt-3 mb-3",ref_key:"salesOrderForm",ref:I,salesOrder:"salesOrder",onSubmit:ve},null,512),i(ee,null,{default:v(()=>[i($,{header:"Detall"},{default:v(()=>[r(e)?(S(),L(ot,{key:0,salesOrder:r(e),salesOrderDetails:r(e).salesOrderDetails,onEdit:o[1]||(o[1]=A=>K(r(N).EDIT,A)),onDelete:be,onCreateWorkOrder:ye,onOpenWorkOrder:De},{header:v(()=>[c("div",it,[dt,c("section",null,[i(Z,{disabled:r(u).deliveryNote!==void 0,size:"small",label:"Afegir línea",onClick:o[0]||(o[0]=A=>K(r(N).CREATE,{})),class:"mr-2"},null,8,["disabled"])])])]),_:1},8,["salesOrder","salesOrderDetails"])):B("",!0)]),_:1}),i($,{header:"Fitxers"},{default:v(()=>[r(e)?(S(),L(qe,{key:0,entity:"SalesOrder",id:r(e).id,title:""},null,8,["id"])):B("",!0)]),_:1})]),_:1}),i(Se,{closable:!0,visible:b.value,"onUpdate:visible":o[3]||(o[3]=A=>b.value=A),header:nt,modal:!0},{default:v(()=>[i(ee,{activeIndex:l.value,"onUpdate:activeIndex":o[2]||(o[2]=A=>l.value=A)},{default:v(()=>[i($,{header:"Línea"},{default:v(()=>[x.value?(S(),L(at,{key:0,formAction:E.value,salesOrderDetail:x.value,onSubmit:fe},null,8,["formAction","salesOrderDetail"])):B("",!0)]),_:1}),i($,{header:"Referencia"},{default:v(()=>[r(s).reference?(S(),L(We,{key:0,module:"sales",reference:r(s).reference,onSubmit:Oe},null,8,["reference"])):B("",!0)]),_:1})]),_:1},8,["activeIndex"])]),_:1},8,["visible"])],64)}}});export{At as default};

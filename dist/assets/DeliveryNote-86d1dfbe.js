import{d as U,r as V,H as L,h as N,a as g,m as $,w as _,e as i,C as T,i as o,k as v,P as E,D as w,p as P,b as Q,f as J,j as W,c as F,n as k,y as q,l as R,s as le,x as re,K as ie,F as K,v as de,g as ne,u as ce,z as ue,o as me,G as ve}from"./index-508d2798.js";import{f as M,c as pe,b as fe}from"./functions-79f2dbc4.js";import{u as X}from"./customers-e3ea0640.js";import{u as Y}from"./lifecycle-2629be68.js";import{u as ye}from"./masterData-3d6c7068.js";import{c as be,a as x,F as _e}from"./form-validator-f8953ae6.js";import{u as Z}from"./reference-37f4fab9.js";import{u as he}from"./plantmodel-07bfccbb.js";import{u as De}from"./deliveryNote-54965883.js";import{u as Ne}from"./order-78f51e1c.js";import{S as Se}from"./index-9bbd114a.js";import{a as we,b as Ie}from"./report.service-d8210bed.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./base.service-5f1a1c65.js";import"./index-2042458b.js";import"./reference.service-8dae8a9d.js";import"./index-80a77416.js";import"./index-90d5063e.js";import"./file.service-9b4550cb.js";const ge=p=>(P("data-v-8f6728d6"),p=p(),Q(),p),Oe={class:"selector-filter"},Ve={class:"selector-filter-field"},Te=ge(()=>i("label",{for:""},"Buscar",-1)),Ce={class:"selector-filter-button"},Be={class:"flex align-items-center gap-2"},xe=U({__name:"SelectorOrders",props:{orders:{},headerVisible:{type:Boolean}},emits:["selected"],setup(p,{emit:I}){const f=p,c=V([]),h=V(""),O=L(()=>{if(h.value==="")return f.orders||[];var d=[];return f.orders&&(d=f.orders.filter(l=>l.number.includes(h.value)||l.customerNumber.includes(h.value))),d}),b=()=>{if(c.value.length===0)return;const d=c.value;I("selected",d)};return(d,l)=>{const s=N("InputText"),u=N("Button"),t=N("Column"),a=N("DataTable");return g(),$(a,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",metaKeySelection:!1,value:O.value,selectionMode:"multiple",selection:c.value,"onUpdate:selection":l[1]||(l[1]=e=>c.value=e)},{header:_(()=>[i("header",Oe,[i("div",Ve,[Te,T("   "),o(s,{style:{width:"150px",height:"35px"},modelValue:h.value,"onUpdate:modelValue":l[0]||(l[0]=e=>h.value=e),size:"small"},null,8,["modelValue"])]),i("div",Ce,[o(u,{onClick:b,size:"small",icon:v(E).CHECK_SQUARE},null,8,["icon"])])])]),groupheader:_(e=>[i("div",Be,[i("b",null,"Comanda "+w(e.data.number)+" - "+w(v(M)(e.data.date)),1)])]),default:_(()=>[o(t,{selectionMode:"multiple",style:{width:"3%"}}),o(t,{header:"Número",field:"number",style:{width:"10%"}}),o(t,{header:"Número client",field:"customerNumber",style:{width:"20%"}}),o(t,{header:"Data",field:"date",style:{width:"10%"}},{body:_(e=>[T(w(v(M)(e.data.date)),1)]),_:1})]),_:1},8,["value","selection"])}}});const ke=J(xe,[["__scopeId","data-v-8f6728d6"]]),z=p=>(P("data-v-146cd7fb"),p=p(),Q(),p),$e={key:0},Ee={class:"three-columns"},Fe={class:"mt-1"},Re=z(()=>i("label",{class:"block text-900 mb-2"},"Exercici",-1)),Me={class:"mt-1"},Ue={class:"mt-1"},Le=z(()=>i("label",{class:"block text-900 mb-2"},"Client",-1)),Ae={class:"three-columns"},qe={class:"mt-2"},ze=z(()=>i("label",{class:"block text-900 mb-2"},"Estat",-1)),Ge={class:"mt-2"},je={class:"mt-2"},He=U({__name:"FormDeliveryNote",props:{deliveryNote:{}},emits:["submit","cancel"],setup(p,{expose:I,emit:f}){const c=p,h=X(),O=ye(),b=Y(),d=W(),l=L(()=>c.deliveryNote&&c.deliveryNote.salesInvoice?c.deliveryNote.salesInvoice.invoiceNumber:""),s=be().shape({siteId:x().required("L'origen es obligatori"),customerId:x().required("El client es obligatori"),statusId:x().required("L'estat es obligatori"),exerciseId:x().required("L'exercici es obligatori")}),u=V({result:!1,errors:{}}),t=()=>{const e=new _e(s);u.value=e.validate(c.deliveryNote)};return I({submitForm:async()=>{if(t(),u.value.result)c.deliveryNote.deliveryDate&&(c.deliveryNote.deliveryDate=pe(c.deliveryNote.deliveryDate)),f("submit",c.deliveryNote);else{let e="";Object.entries(u.value.errors).forEach(m=>{e+=`${m[1].map(D=>D)}.   `}),d.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}}}),(e,m)=>{var C;const D=N("Dropdown");return g(),F("div",null,[e.deliveryNote?(g(),F("form",$e,[i("section",Ee,[i("div",Fe,[Re,o(D,{modelValue:e.deliveryNote.exerciseId,"onUpdate:modelValue":m[0]||(m[0]=y=>e.deliveryNote.exerciseId=y),editable:"",options:v(O).exercises,optionValue:"id",optionLabel:"name",class:k(["w-full",{"p-invalid":u.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),i("div",Me,[o(q,{type:v(le).TEXT,label:"Número Albarà",id:"salesOrderNumber",modelValue:e.deliveryNote.number,"onUpdate:modelValue":m[1]||(m[1]=y=>e.deliveryNote.number=y),disabled:""},null,8,["type","modelValue"])]),i("div",Ue,[Le,o(D,{modelValue:e.deliveryNote.customerId,"onUpdate:modelValue":m[2]||(m[2]=y=>e.deliveryNote.customerId=y),editable:"",options:v(h).customers,optionValue:"id",optionLabel:"comercialName",class:k(["w-full",{"p-invalid":u.value.errors.customerId}])},null,8,["modelValue","options","class"])])]),i("section",Ae,[i("div",qe,[ze,o(D,{modelValue:e.deliveryNote.statusId,"onUpdate:modelValue":m[3]||(m[3]=y=>e.deliveryNote.statusId=y),editable:"",options:(C=v(b).lifecycle)==null?void 0:C.statuses,optionValue:"id",optionLabel:"name",class:k(["w-full",{"p-invalid":u.value.errors.statusId}])},null,8,["modelValue","options","class"])]),i("div",Ge,[o(q,{modelValue:e.deliveryNote.deliveryDate,"onUpdate:modelValue":m[4]||(m[4]=y=>e.deliveryNote.deliveryDate=y),label:"Data Entrega",disabled:!0},null,8,["modelValue"])]),i("div",je,[o(q,{modelValue:l.value,"onUpdate:modelValue":m[5]||(m[5]=y=>l.value=y),label:"Número de factura",disabled:!0},null,8,["modelValue"])])])])):R("",!0)])}}});const Ke=J(He,[["__scopeId","data-v-146cd7fb"]]),Pe={class:"vertical-align-middle ml-2 font-bold line-height-3"},Qe=["onClick"],Je=U({__name:"TableDeliveryNoteDetails",props:{orders:{},canDelete:{type:Boolean}},emits:["delete"],setup(p,{emit:I}){const f=p,c=Z(),h=L(()=>{if(!f.orders)return[];let d=[];for(let l=0;l<f.orders.length;l++){if(!f.orders[l].salesOrderDetails)continue;const s=f.orders[l];s.salesOrderDetails.forEach(u=>{d.push({salesOrderId:s.id,salesOrderNumber:s.number,salesOrderDate:s.date,...u})})}return d}),O=re(),b=(d,l)=>{var u;if(!f.orders)return;const s=(u=f.orders)==null?void 0:u.find(t=>t.id===l.salesOrderId);s&&O.require({target:d.currentTarget,message:`Está segur que vol desassignar la comanda ${s.number}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{I("delete",s)}})};return(d,l)=>{const s=N("Column"),u=N("DataTable");return g(),$(u,{value:h.value,tableStyle:"min-width: 100%",class:"p-datatable-sm",rowGroupMode:"subheader",groupRowsBy:"salesOrderNumber"},{header:_(()=>[ie(d.$slots,"header")]),groupheader:_(t=>[i("span",Pe,"Comanda "+w(t.data.salesOrderNumber)+" ("+w(t.data.customerOrderNumber)+") "+w(v(M)(t.data.salesOrderDate)),1),T("   "),d.canDelete?(g(),F("i",{key:0,class:k([v(E).TIMES,"grid_delete_column_button"]),onClick:a=>b(a,t.data)},null,10,Qe)):R("",!0)]),default:_(()=>[o(s,{field:"salesOrderNumber",header:"Comanda",style:{width:"5%"}}),o(s,{field:"",header:"",style:{width:"5%"}}),o(s,{field:"quantity",header:"Quantitat",style:{width:"5%"}}),o(s,{header:"Referència",style:{width:"10%"}},{body:_(t=>[T(w(v(c).getShortName(t.data.reference)),1)]),_:1}),o(s,{field:"description",header:"Descripció",style:{width:"30%"}}),o(s,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:_(t=>[T(w(t.data.unitPrice)+" € ",1)]),_:1}),o(s,{field:"amount",header:"Total",style:{width:"10%"}},{body:_(t=>[T(w(t.data.amount)+" € ",1)]),_:1})]),_:3},8,["value"])}}}),We={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Xe=i("span",{class:"text-l text-900 font-bold"},"Linies de l'albarà",-1),Ye="Selector de comandes",ht=U({__name:"DeliveryNote",setup(p){const I=V(),f=V(K.EDIT),c=de(),h=ne(),O=ce(),b=De(),d=Ne(),l=X(),s=he(),u=Z(),t=Y(),{deliveryNote:a}=ue(b),e=[{label:"Descarregar",icon:E.FILE_WORD,command:()=>m()}],m=async()=>{var r;const n=await Se.DeliveryNote.GetReportDataById(a.value.id);if(n){const S=`AlbaraEntrega_${(r=a.value)==null?void 0:r.number}.docx`,B=await new Ie().Download(n,we.DeliveryNote,S);B?fe(S,B):G.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}},D=V(!1),C=V(""),y=L(()=>{if(!t.lifecycle||!t.lifecycle.statuses||a.value&&a.value.salesInvoiceId&&a.value.salesInvoiceId!==null)return!1;const n=t.lifecycle.statuses.find(r=>r.name==="Entregat");return n?n.id!==C.value:!1}),A=async()=>{const n=c.params.id;await b.GetById(n),C.value=b.deliveryNote.statusId,await d.GetByDeliveryNote(n),u.fetchReferencesByModule("sales"),s.fetchSites(),l.customers||l.fetchCustomers(),t.lifecycle||t.fetchOneByName("DeliveryNote");let r="";a.value&&(f.value=K.EDIT,r=`Albarà d'entrega ${a.value.number}`,a.value.deliveryDate&&(a.value.deliveryDate=M(a.value.deliveryDate))),O.setMenuItem({icon:E.BUILDING,backButtonVisible:!0,title:r})};me(async()=>{await A()});const ee=()=>{I.value.submitForm()},G=W(),te=async n=>{let r=!1,S="";r=await b.Update(n.id,n),S=r?"Albarà actualitzat":"Error al actualitzar l'albarà",G.add({life:5e3,severity:r?"success":"error",summary:S}),r&&h.back()},oe=async()=>{a.value&&await d.GetToDeliver(a.value.customerId),D.value=!0},se=async n=>{for(let r=0;r<n.length;r++){const S=n[r];await b.AddOrder(a.value.id,S)}D.value=!1,A()},ae=async n=>{await b.DeleteOrder(a.value.id,n),A()};return(n,r)=>{const S=N("SplitButton"),j=N("Button"),B=N("Dialog");return g(),F(ve,null,[o(S,{label:"Guardar",onClick:ee,model:e,size:"small",class:"grid_add_row_button"}),v(a)?(g(),$(Ke,{key:0,class:"mt-3 mb-3",ref_key:"deliveryNoteForm",ref:I,deliveryNote:v(a),onSubmit:te},null,8,["deliveryNote"])):R("",!0),v(a)?(g(),$(Je,{key:1,orders:v(d).salesOrders,canDelete:y.value,onDelete:ae},{header:_(()=>[i("div",We,[Xe,i("div",null,[o(j,{disabled:!y.value,size:"small",label:"Afegir comanda",onClick:r[0]||(r[0]=H=>oe())},null,8,["disabled"])])])]),_:1},8,["orders","canDelete"])):R("",!0),o(B,{closable:!0,visible:D.value,"onUpdate:visible":r[1]||(r[1]=H=>D.value=H),header:Ye,modal:!0,style:{width:"50rem"},breakpoints:{"1199px":"75vw","575px":"90vw"}},{default:_(()=>[o(ke,{orders:v(d).salesOrdersToDeliver,onSelected:se},null,8,["orders"])]),_:1},8,["visible"])],64)}}});export{ht as default};

import{d as J,z as ee,o as Q,r as B,j as X,h as y,a as R,c as H,k as o,e as n,i as l,y as z,n as M,s as L,D as k,l as O,p as re,b as ie,f as ue,J as te,F as x,m as G,w as _,P as W,C as $,v as de,g as ce,u as me,H as pe}from"./index-46043a45.js";import{a as oe,u as K}from"./purchaseInvoices-5d6fd980.js";import{c as ve,g as ae,f as Ie}from"./functions-1a09c2e2.js";import{F as be}from"./FileEntityPicker-d635fb23.js";import{c as se,a as Z,F as ne,d as fe}from"./form-validator-591216ce.js";import{l as q}from"./lodash-229f97ff.js";import"./index-7b8f1609.js";import"./base.service-1c5fc4fe.js";import"./index-bbc23160.js";import"./suppliers.service-774ab327.js";import"./v4-a960c1f4.js";import"./file.service-a7cd45eb.js";const U=C=>(re("data-v-6fa65e83"),C=C(),ie(),C),_e={key:0},he={class:"four-columns"},Ae=U(()=>n("label",{class:"block text-900 mb-2"},"Exercici",-1)),xe=U(()=>n("label",{class:"block text-900 mb-2"},"Sèrie",-1)),ye=U(()=>n("label",{class:"block text-900 mb-2"},"Estat",-1)),Ve={class:"four-columns"},De={class:"mt-1"},ge=U(()=>n("label",{class:"block text-900 mb-2"},"Proveïdor",-1)),Te={class:"mt-1"},we={class:"mt-1"},Ee=U(()=>n("label",{class:"block text-900 mb-2"},"Data Factura",-1)),Fe={class:"mt-1"},Ce=U(()=>n("label",{class:"block text-900 mb-2"},"Forma de pagament",-1)),Pe={class:"four-columns"},Se={class:"mt-1"},ke={class:"mt-1"},Ue={class:"mt-1"},Ne={class:"four-columns"},Re={class:"mt-1"},Be=U(()=>n("label",{class:"block text-900 mb-2"},"Base",-1)),Me={class:"summary-field"},$e={class:"mt-1"},Le=U(()=>n("label",{class:"block text-900 mb-2"},"Impostos",-1)),Ye={class:"summary-field"},ze={class:"mt-1"},Oe=U(()=>n("label",{class:"block text-900 mb-2"},"Total",-1)),je={class:"summary-field"},qe=J({__name:"FormPurchaseInvoice",emits:["submit","cancel"],setup(C,{expose:T,emit:p}){const D=oe(),g=K(),{purchaseInvoice:e}=ee(D);Q(()=>{setTimeout(()=>{e.value&&e.value.purchaseInvoiceImports.length>0&&(e.value.taxAmount=h())},500)});const E=se().shape({exerciceId:Z().required("L'exercici es obligatori"),supplierId:Z().required("El proveïdor es obligatori")}),m=B({result:!1,errors:{}}),s=()=>{var t,b;const c=new ne(E);m.value=c.validate(e.value),console.log("after validate",(t=e.value)==null?void 0:t.purchaseInvoiceDate),console.log("after validate",ve((b=e.value)==null?void 0:b.purchaseInvoiceDate))},V=()=>{var c;return((c=e.value)==null?void 0:c.purchaseInvoiceImports.length)===0?(a.add({severity:"warn",summary:"Formulari inválid",detail:"Ha d'introduir els imports de factura",life:5e3}),!1):!0};let f=!1;Q(()=>{setTimeout(()=>{f=!0},500)});const a=X(),u=async()=>{if(s(),m.value.result){if(!V())return;p("submit",e.value)}else{let c="";Object.entries(m.value.errors).forEach(t=>{c+=`${t[1].map(b=>b)}.   `}),a.add({severity:"warn",summary:"Formulari inválid",detail:c,life:5e3})}},v=()=>{var t;const c=(t=g.masterData.suppliers)==null?void 0:t.find(b=>{var F;return b.id===((F=e.value)==null?void 0:F.supplierId)});c&&(e.value.paymentMethodId=c.paymentMethodId,I())},I=async()=>{if(f){if(e.value){let c=0,t=0,b=0,F=0,r=0,d=0,i=0,A=0,w=0,P=0;c=Y(),F=h(),e.value.transportAmount&&(t=parseFloat(e.value.transportAmount.toFixed(2))),e.value.discountPercentage&&(i=parseFloat(e.value.discountPercentage.toFixed(2))),e.value.extraTaxPercentatge&&(w=e.value.extraTaxPercentatge),b=(c+t)*1,P=b*(w/100),A=b+F*1-P*1,d=A*(1*i)/100,r=parseFloat((A-d).toFixed(2)),e.value.baseAmount=c,e.value.transportAmount=t,e.value.subtotal=b,e.value.taxAmount=F,e.value.grossAmount=A,e.value.netAmount=r,e.value.discountPercentage=i,e.value.discountAmount=d,e.value.extraTaxPercentatge=w,e.value.extraTaxAmount=P,e.value.purchaseInvoiceDueDates=await D.GetDueDates(e.value)}console.log("calcAmounts",e.value)}},Y=()=>{let c=0;return e.value&&e.value.purchaseInvoiceImports.forEach(t=>c+=t.baseAmount),c},h=()=>{let c=0;return e.value&&e.value.purchaseInvoiceImports.forEach(t=>c+=t.taxAmount),c};return T({submitForm:u,calcAmounts:I}),(c,t)=>{const b=y("Dropdown"),F=y("Calendar");return R(),H("div",null,[o(e)?(R(),H("form",_e,[n("section",he,[l(z,{label:"Num. Fra. Intern",id:"number",modelValue:o(e).number,"onUpdate:modelValue":t[0]||(t[0]=r=>o(e).number=r),disabled:""},null,8,["modelValue"]),n("div",null,[Ae,l(b,{modelValue:o(e).exerciceId,"onUpdate:modelValue":t[1]||(t[1]=r=>o(e).exerciceId=r),editable:"",options:o(g).masterData.exercises,optionValue:"id",optionLabel:"name",class:M(["w-full",{"p-invalid":m.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),n("div",null,[xe,l(b,{modelValue:o(e).purchaseInvoiceSerieId,"onUpdate:modelValue":t[2]||(t[2]=r=>o(e).purchaseInvoiceSerieId=r),editable:"",options:o(g).masterData.series,optionValue:"id",optionLabel:"name",class:M(["w-full",{"p-invalid":m.value.errors.purchaseInvoiceSerieId}])},null,8,["modelValue","options","class"])]),n("div",null,[ye,l(b,{modelValue:o(e).purchaseInvoiceStatusId,"onUpdate:modelValue":t[3]||(t[3]=r=>o(e).purchaseInvoiceStatusId=r),editable:"",options:o(g).masterData.statuses,optionValue:"id",optionLabel:"name",class:M(["w-full",{"p-invalid":m.value.errors.purchaseInvoiceStatusId}])},null,8,["modelValue","options","class"])])]),n("section",Ve,[n("div",De,[ge,l(b,{modelValue:o(e).supplierId,"onUpdate:modelValue":t[4]||(t[4]=r=>o(e).supplierId=r),editable:"",options:o(g).masterData.suppliers,optionValue:"id",optionLabel:"comercialName",onChange:v,class:M(["w-full",{"p-invalid":m.value.errors.supplierId}])},null,8,["modelValue","options","class"])]),n("div",Te,[l(z,{label:"Num. Fra. Proveïdor",id:"supplierNumber",modelValue:o(e).supplierNumber,"onUpdate:modelValue":t[5]||(t[5]=r=>o(e).supplierNumber=r)},null,8,["modelValue"])]),n("div",we,[Ee,l(F,{id:"purchaseInvoiceDate",modelValue:o(e).purchaseInvoiceDate,"onUpdate:modelValue":t[6]||(t[6]=r=>o(e).purchaseInvoiceDate=r),onDateSelect:t[7]||(t[7]=r=>I())},null,8,["modelValue"])]),n("div",Fe,[Ce,l(b,{modelValue:o(e).paymentMethodId,"onUpdate:modelValue":[t[8]||(t[8]=r=>o(e).paymentMethodId=r),t[9]||(t[9]=r=>I())],editable:"",options:o(g).masterData.paymentMethods,optionValue:"id",optionLabel:"name",class:M(["w-full",{"p-invalid":m.value.errors.paymentmethod}])},null,8,["modelValue","options","class"])])]),n("section",Pe,[n("div",Se,[l(z,{type:o(L).CURRENCY,label:"Ports",id:"transportAmount",modelValue:o(e).transportAmount,"onUpdate:modelValue":[t[10]||(t[10]=r=>o(e).transportAmount=r),t[11]||(t[11]=r=>I())]},null,8,["type","modelValue"])]),n("div",ke,[l(z,{type:o(L).NUMERIC,label:"% IRPF",id:"extraTaxPercentatge",modelValue:o(e).extraTaxPercentatge,"onUpdate:modelValue":[t[12]||(t[12]=r=>o(e).extraTaxPercentatge=r),t[13]||(t[13]=r=>I())]},null,8,["type","modelValue"])]),n("div",Ue,[l(z,{type:o(L).NUMERIC,label:"% Dto.",id:"discountPercentage",modelValue:o(e).discountPercentage,"onUpdate:modelValue":[t[14]||(t[14]=r=>o(e).discountPercentage=r),t[15]||(t[15]=r=>I())]},null,8,["type","modelValue"])])]),n("section",Ne,[n("div",Re,[Be,n("span",Me,k(o(e).baseAmount)+" €",1)]),n("div",$e,[Le,n("span",Ye,k(o(e).taxAmount)+" €",1)]),n("div",ze,[Oe,n("span",je,k(o(e).netAmount)+" €",1)])])])):O("",!0)])}}});const Ge=ue(qe,[["__scopeId","data-v-6fa65e83"]]),He={key:0},Je={class:"two-columns"},Ke=n("label",{class:"block text-900 mb-2"},"IVA",-1),Qe={class:"two-columns"},We=J({__name:"FormPurchaseInvoiceImport",props:{formAction:{},invoiceImport:{}},emits:["submit"],setup(C,{emit:T}){const p=C,D=K(),g=X(),e=te(()=>p.formAction===x.CREATE?"Afegir":"Modificar"),E=()=>{const a=D.masterData.taxes.find(u=>u.id===p.invoiceImport.taxId);if(a&&q.isNumber(p.invoiceImport.baseAmount)){const u=p.invoiceImport.baseAmount,v=u/100*a.percentatge,I=u+v;p.invoiceImport.baseAmount=u,p.invoiceImport.taxAmount=q.round(v,2),p.invoiceImport.netAmount=q.round(I,2),console.log("netAmount, rounded netAmount",I,q.round(I,2))}},m=se().shape({baseAmount:fe().required("L'import base és obligatori").min(1,"L'import base ha de ser un número positiu")}),s=B({result:!1,errors:{}}),V=()=>{const a=new ne(m);s.value=a.validate(p.invoiceImport)},f=async()=>{if(V(),s.value.result)T("submit",p.invoiceImport);else{let a="";Object.entries(s.value.errors).forEach(u=>{a+=`${u[1].map(v=>v)}.   `}),g.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}};return(a,u)=>{const v=y("Dropdown"),I=y("BaseInput"),Y=y("Button");return a.invoiceImport?(R(),H("form",He,[n("section",Je,[n("div",null,[Ke,l(v,{modelValue:a.invoiceImport.taxId,"onUpdate:modelValue":[u[0]||(u[0]=h=>a.invoiceImport.taxId=h),u[1]||(u[1]=h=>E())],editable:"",options:o(D).masterData.taxes,optionValue:"id",optionLabel:"name"},null,8,["modelValue","options"])]),l(I,{class:M(["mb-2",{"p-invalid":s.value.errors.baseAmount}]),label:"Import Base",modelValue:a.invoiceImport.baseAmount,"onUpdate:modelValue":[u[2]||(u[2]=h=>a.invoiceImport.baseAmount=h),u[3]||(u[3]=h=>E())],type:o(L).CURRENCY},null,8,["modelValue","type","class"])]),n("section",Qe,[l(I,{class:"mb-2",label:"Import Impost",modelValue:a.invoiceImport.taxAmount,"onUpdate:modelValue":u[4]||(u[4]=h=>a.invoiceImport.taxAmount=h),type:o(L).CURRENCY,disabled:""},null,8,["modelValue","type"]),l(I,{class:"mb-2",label:"Total",modelValue:a.invoiceImport.netAmount,"onUpdate:modelValue":u[5]||(u[5]=h=>a.invoiceImport.netAmount=h),type:o(L).CURRENCY,disabled:""},null,8,["modelValue","type"])]),l(Y,{label:e.value,onClick:f,style:{float:"right"}},null,8,["label"])])):O("",!0)}}}),Xe=["onClick"],Ze=J({__name:"TablePurchaseInvoiceImports",props:{purchaseInvoiceImports:{}},emits:["add","edit","delete"],setup(C,{emit:T}){const p=C,D=K(),g=s=>{var f;const V=(f=D.masterData.taxes)==null?void 0:f.find(a=>a.id===s);if(V)return V.percentatge},e=()=>{var f;const s=(f=D.masterData.taxes)==null?void 0:f.find(a=>a.name.includes("21")),V={id:ae(),baseAmount:null,taxId:s?s.id:"",taxAmount:0,netAmount:0,purchaseInvoiceId:""};T("add",V)},E=s=>{s.originalEvent.target.className.includes("grid_delete_column_button")||T("edit",s.data)},m=(s,V)=>{T("delete",V)};return(s,V)=>{const f=y("Button"),a=y("Column"),u=y("DataTable");return R(),G(u,{onRowClick:E,value:p.purchaseInvoiceImports,tableStyle:"min-width: 100%"},{default:_(()=>[l(f,{onClick:e,rounded:"",icon:o(W).PLUS,class:"grid_add_row_button",style:{"margin-right":"1.5rem"}},null,8,["icon"]),l(a,{field:"baseAmount",header:"Base",style:{width:"25%"}},{body:_(v=>[$(k(v.data.baseAmount)+" € ",1)]),_:1}),l(a,{field:"taxId",header:"% IVA",style:{width:"25%"}},{body:_(v=>[$(k(g(v.data.taxId)),1)]),_:1}),l(a,{field:"taxAmount",header:"Cuota IVA",style:{width:"25%"}},{body:_(v=>[$(k(v.data.taxAmount)+" € ",1)]),_:1}),l(a,{field:"netAmount",header:"Total",style:{width:"25%"}},{body:_(v=>[$(k(v.data.netAmount)+" € ",1)]),_:1}),l(a,{style:{width:"10%"}},{body:_(v=>[n("i",{class:M([o(W).TIMES,"grid_delete_column_button"]),onClick:I=>m(I,v.data)},null,10,Xe)]),_:1})]),_:1},8,["value"])}}}),mt=J({__name:"PurchaseInvoice",setup(C){const T=B(),p=B(x.EDIT),D=de(),g=ce(),e=me(),E=K(),m=oe(),{purchaseInvoice:s}=ee(m),V=te(()=>a.value===x.CREATE?"Introducció import":"Modificació import"),f=B(!1),a=B(x.EDIT),u=B(void 0),v=async()=>{let d="";await m.GetById(D.params.id),s.value?(p.value=x.EDIT,d=`Factura de compra: ${s.value.number}`,s.value.purchaseInvoiceDate=new Date(s.value.purchaseInvoiceDate)):(p.value=x.CREATE,m.setNewPurchaseInvoice(D.params.id),d="Alta de factures de compra",I()),e.setMenuItem({icon:W.POUND,backButtonVisible:!0,title:d})},I=()=>{var d,i,A;if(s.value){const w=(d=E.masterData.exercises)==null?void 0:d.find(N=>N.name===new Date().getFullYear().toString());w&&(s.value.exerciceId=w.id);const P=(i=E.masterData.series)==null?void 0:i.find(N=>N.name==="Nacional");P&&(s.value.purchaseInvoiceSerieId=P.id);const j=(A=E.masterData.statuses)==null?void 0:A.find(N=>N.name==="Nova");j&&(s.value.purchaseInvoiceStatusId=j.id)}};Q(async()=>{await v()});const Y=()=>{T.value.submitForm()},h=(d,i)=>{d===x.CREATE&&(i.id=ae()),i.purchaseInvoiceId=s.value.id,u.value=i,a.value=d,f.value=!0},c=X(),t=async d=>{let i=!1,A="";p.value===x.CREATE?(i=await m.Create(d),A=i?"Factura creada":"Error al crear la factura"):(i=await m.Update(d),A=i?"Factura actualizada":"Error al actualizar la factura"),c.add({life:5e3,severity:i?"success":"error",summary:A}),i&&g.back()},b=async d=>{var i;a.value===x.CREATE?(p.value===x.EDIT&&await m.CreateInvoiceImport(d),(i=s.value)==null||i.purchaseInvoiceImports.push(d)):a.value===x.EDIT&&p.value===x.EDIT&&await m.UpdateInvoiceImport(d),r()},F=async d=>{console.log("deleteInvoiceImport"),p.value===x.EDIT&&await m.DeleteInvoiceImport(d);const i=s.value.purchaseInvoiceImports.filter(A=>A.id!==d.id);s.value.purchaseInvoiceImports=i,r()},r=()=>{T.value.calcAmounts(),f.value=!1};return(d,i)=>{const A=y("Button"),w=y("TabPanel"),P=y("Column"),j=y("DataTable"),N=y("TabView"),le=y("Dialog");return R(),H(pe,null,[l(A,{label:"Guardar",class:"grid_add_row_button",onClick:Y}),l(N,null,{default:_(()=>[o(s)?(R(),G(w,{key:0,header:"Factura"},{default:_(()=>[l(Ge,{ref_key:"purchaseInvoiceForm",ref:T,purchaseInvoice:o(s),onSubmit:t},null,8,["purchaseInvoice"]),l(N,null,{default:_(()=>[l(w,{header:"Imports"},{default:_(()=>[l(Ze,{"purchase-invoice-imports":o(s).purchaseInvoiceImports,onAdd:i[0]||(i[0]=S=>h(o(x).CREATE,S)),onEdit:i[1]||(i[1]=S=>h(o(x).EDIT,S)),onDelete:F},null,8,["purchase-invoice-imports"])]),_:1}),l(w,{header:"Venciments"},{default:_(()=>[l(j,{value:o(s).purchaseInvoiceDueDates,tableStyle:"min-width: 100%"},{default:_(()=>[l(P,{field:"dueDate",header:"Venciment",style:{width:"50%"}},{body:_(S=>[$(k(o(Ie)(S.data.dueDate)),1)]),_:1}),l(P,{field:"amount",header:"Import",style:{width:"50%"}},{body:_(S=>[$(k(S.data.amount)+" € ",1)]),_:1})]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})):O("",!0),l(w,{header:"Fitxers"},{default:_(()=>[o(s)?(R(),G(be,{key:0,title:"Factures",entity:"PurchaseInvoice",id:o(D).params.id},null,8,["id"])):O("",!0)]),_:1})]),_:1}),u.value?(R(),G(le,{key:0,closable:!0,visible:f.value,"onUpdate:visible":i[2]||(i[2]=S=>f.value=S),header:V.value,position:"bottom"},{default:_(()=>[l(We,{formAction:a.value,invoiceImport:u.value,onSubmit:b},null,8,["formAction","invoiceImport"])]),_:1},8,["visible","header"])):O("",!0)],64)}}});export{mt as default};

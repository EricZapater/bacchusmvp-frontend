import{K as me,a as F,c as $,e as a,L as ee,M as K,d as q,j as X,r as R,o as Q,h as E,i,w as g,D as S,k as t,P as L,G as oe,N as pe,n as P,l as z,f as ae,z as se,y as j,s as G,p as ve,b as Ie,I as ne,F as V,m as J,C as Y,v as be,g as fe,u as _e}from"./index-bbf90bc6.js";import{a as le,u as Z}from"./purchaseInvoices-e6ca58ca.js";import{c as ye,g as ie,f as he}from"./functions-fa75c0c2.js";import{F as Ae}from"./file.service-83c849d8.js";import{c as re,a as te,F as ue,d as ge}from"./form-validator-482c3685.js";import{l as W}from"./lodash-6ef63f51.js";import"./index-e0e54c50.js";import"./base.service-e042a6a2.js";import"./index-00cc246e.js";import"./suppliers.service-92da4c44.js";import"./v4-a960c1f4.js";var de={name:"Toolbar",extends:me,props:{"aria-labelledby":{type:String,default:null}}};const xe=["aria-labelledby"];function De(p,y,d,v,I,e){return F(),$("div",K({class:"p-toolbar p-component",role:"toolbar","aria-labelledby":p.ariaLabelledby},p.ptm("root")),[a("div",K({class:"p-toolbar-group-start p-toolbar-group-left"},p.ptm("start")),[ee(p.$slots,"start")],16),a("div",K({class:"p-toolbar-group-center"},p.ptm("center")),[ee(p.$slots,"center")],16),a("div",K({class:"p-toolbar-group-end p-toolbar-group-right"},p.ptm("end")),[ee(p.$slots,"end")],16)],16,xe)}function we(p,y){y===void 0&&(y={});var d=y.insertAt;if(!(!p||typeof document>"u")){var v=document.head||document.getElementsByTagName("head")[0],I=document.createElement("style");I.type="text/css",d==="top"&&v.firstChild?v.insertBefore(I,v.firstChild):v.appendChild(I),I.styleSheet?I.styleSheet.cssText=p:I.appendChild(document.createTextNode(p))}}var Ve=`
.p-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
}
.p-toolbar-group-start,
.p-toolbar-group-center,
.p-toolbar-group-end {
    display: flex;
    align-items: center;
}
.p-toolbar-group-left,
.p-toolbar-group-right {
    display: flex;
    align-items: center;
}
`;we(Ve);de.render=De;const Ee={class:"base_input"},Fe={class:"file-viewer"},Te={class:"file-viewer-item-type"},Ce={class:"file-viewer-item-actions"},Pe=["onClick"],ke=["onClick"],$e=q({__name:"FileEntityPicker",props:{title:{},entity:{},id:{}},setup(p){const y=p,d=X(),v=new Ae,I=R(void 0),e=async()=>{I.value=await v.GetEntityFiles(y.entity,y.id)};Q(async()=>{await e()});const T=async()=>{const m=document.createElement("input");m.type="file",m.onchange=async b=>{const s=b.target.files[0];if(!await v.Upload(s,y.entity,y.id)){d.add({severity:"error",detail:"Error al carregar l'arxiu"});return}await e()},m.click()},f=async m=>{const b=await v.Download(m);ye(m.originalName,b)},n=async m=>{var b=await v.Delete(m.id);if(!b){d.add({severity:"error",detail:"Error al eliminar l'arxiu"});return}await e()};return(m,b)=>{const s=E("Button");return F(),$("div",Ee,[i(t(de),null,{start:g(()=>[a("h4",null,S(m.title),1)]),end:g(()=>[i(s,{size:"small",rounded:"",icon:t(L).UPLOAD,onClick:T},null,8,["icon"])]),_:1}),a("section",Fe,[(F(!0),$(oe,null,pe(I.value,l=>(F(),$("article",{class:"file-viewer-item",key:m.id},[a("div",Te,[l.type===0?(F(),$("i",{key:0,class:P(t(L).FILE_PDF),style:{"font-size":"3.5rem"}},null,2)):z("",!0),l.type===1?(F(),$("i",{key:1,class:P(t(L).IMAGE),style:{"font-size":"3.5rem"}},null,2)):z("",!0),a("p",null,S(l.originalName.substring(0,20)),1)]),a("div",Ce,[a("div",{class:"file-viewer-item-action file-viewer-item-action-download",onClick:h=>f(l)},[a("i",{class:P(t(L).DOWNLOAD),style:{"font-size":"1rem"}},null,2)],8,Pe),a("div",{class:"file-viewer-item-action file-viewer-item-action-delete",onClick:h=>n(l)},[a("i",{class:P(t(L).TIMES)},null,2)],8,ke)])]))),128))])])}}});const Se=ae($e,[["__scopeId","data-v-dd7a228d"]]),B=p=>(ve("data-v-af2c4833"),p=p(),Ie(),p),Ne={key:0},Ue={class:"four-columns"},Be=B(()=>a("label",{class:"block text-900 mb-2"},"Exercici",-1)),Me=B(()=>a("label",{class:"block text-900 mb-2"},"Sèrie",-1)),Re=B(()=>a("label",{class:"block text-900 mb-2"},"Estat",-1)),Le={class:"four-columns"},ze={class:"mt-1"},Ge=B(()=>a("label",{class:"block text-900 mb-2"},"Proveïdor",-1)),Oe={class:"mt-1"},je={class:"mt-1"},Ye=B(()=>a("label",{class:"block text-900 mb-2"},"Data Factura",-1)),qe={class:"mt-1"},He=B(()=>a("label",{class:"block text-900 mb-2"},"Forma de pagament",-1)),Ke={class:"four-columns"},We={class:"mt-1"},Je={class:"mt-1"},Qe={class:"mt-1"},Xe={class:"four-columns"},Ze={class:"mt-1"},et=B(()=>a("label",{class:"block text-900 mb-2"},"Base",-1)),tt={class:"summary-field"},ot={class:"mt-1"},at=B(()=>a("label",{class:"block text-900 mb-2"},"Impostos",-1)),st={class:"summary-field"},nt={class:"mt-1"},lt=B(()=>a("label",{class:"block text-900 mb-2"},"Total",-1)),it={class:"summary-field"},rt=q({__name:"FormPurchaseInvoice",emits:["submit","cancel"],setup(p,{expose:y,emit:d}){const v=le(),I=Z(),{purchaseInvoice:e}=se(v);Q(()=>{e.value&&e.value.purchaseInvoiceImports.length>0&&(e.value.taxAmount=D())});const T=re().shape({exerciceId:te().required("L'exercici es obligatori"),supplierId:te().required("El proveïdor es obligatori")}),f=R({result:!1,errors:{}}),n=()=>{const _=new ue(T);f.value=_.validate(e.value)},m=()=>{var _;return((_=e.value)==null?void 0:_.purchaseInvoiceImports.length)===0?(s.add({severity:"warn",summary:"Formulari inválid",detail:"Ha d'introduir els imports de factura",life:5e3}),!1):!0};let b=!1;Q(()=>{setTimeout(()=>{b=!0},500)});const s=X(),l=async()=>{if(n(),f.value.result){if(!m())return;d("submit",e.value)}else{let _="";Object.entries(f.value.errors).forEach(o=>{_+=`${o[1].map(x=>x)}.   `}),s.add({severity:"warn",summary:"Formulari inválid",detail:_,life:5e3})}},h=()=>{var o;const _=(o=I.masterData.suppliers)==null?void 0:o.find(x=>{var k;return x.id===((k=e.value)==null?void 0:k.supplierId)});_&&(e.value.paymentMethodId=_.paymentMethodId,A())},A=async()=>{if(b){if(e.value){let _=0,o=0,x=0,k=0,r=0,c=0,u=0,w=0,C=0,N=0;_=O(),k=D(),e.value.transportAmount&&(o=parseFloat(e.value.transportAmount.toFixed(2))),e.value.discountPercentage&&(u=parseFloat(e.value.discountPercentage.toFixed(2))),e.value.extraTaxPercentatge&&(C=e.value.extraTaxPercentatge),x=(_+o)*1,N=x*(C/100),w=x+k*1-N*1,c=w*(1*u)/100,r=parseFloat((w-c).toFixed(2)),e.value.baseAmount=_,e.value.transportAmount=o,e.value.subtotal=x,e.value.taxAmount=k,e.value.grossAmount=w,e.value.netAmount=r,e.value.discountPercentage=u,e.value.discountAmount=c,e.value.extraTaxPercentatge=C,e.value.extraTaxAmount=N,e.value.purchaseInvoiceDueDates=await v.GetDueDates(e.value)}console.log("calcAmounts",e.value)}},O=()=>{let _=0;return e.value&&e.value.purchaseInvoiceImports.forEach(o=>_+=o.baseAmount),_},D=()=>{let _=0;return e.value&&e.value.purchaseInvoiceImports.forEach(o=>_+=o.taxAmount),_};return y({submitForm:l,calcAmounts:A}),(_,o)=>{const x=E("Dropdown"),k=E("Calendar");return F(),$("div",null,[t(e)?(F(),$("form",Ne,[a("section",Ue,[i(j,{label:"Num. Fra. Intern",id:"number",modelValue:t(e).number,"onUpdate:modelValue":o[0]||(o[0]=r=>t(e).number=r),disabled:""},null,8,["modelValue"]),a("div",null,[Be,i(x,{modelValue:t(e).exerciceId,"onUpdate:modelValue":o[1]||(o[1]=r=>t(e).exerciceId=r),editable:"",options:t(I).masterData.exercises,optionValue:"id",optionLabel:"name",class:P(["w-full",{"p-invalid":f.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),a("div",null,[Me,i(x,{modelValue:t(e).purchaseInvoiceSerieId,"onUpdate:modelValue":o[2]||(o[2]=r=>t(e).purchaseInvoiceSerieId=r),editable:"",options:t(I).masterData.series,optionValue:"id",optionLabel:"name",class:P(["w-full",{"p-invalid":f.value.errors.purchaseInvoiceSerieId}])},null,8,["modelValue","options","class"])]),a("div",null,[Re,i(x,{modelValue:t(e).purchaseInvoiceStatusId,"onUpdate:modelValue":o[3]||(o[3]=r=>t(e).purchaseInvoiceStatusId=r),editable:"",options:t(I).masterData.statuses,optionValue:"id",optionLabel:"name",class:P(["w-full",{"p-invalid":f.value.errors.purchaseInvoiceStatusId}])},null,8,["modelValue","options","class"])])]),a("section",Le,[a("div",ze,[Ge,i(x,{modelValue:t(e).supplierId,"onUpdate:modelValue":o[4]||(o[4]=r=>t(e).supplierId=r),editable:"",options:t(I).masterData.suppliers,optionValue:"id",optionLabel:"comercialName",onChange:h,class:P(["w-full",{"p-invalid":f.value.errors.supplierId}])},null,8,["modelValue","options","class"])]),a("div",Oe,[i(j,{label:"Num. Fra. Proveïdor",id:"supplierNumber",modelValue:t(e).supplierNumber,"onUpdate:modelValue":o[5]||(o[5]=r=>t(e).supplierNumber=r)},null,8,["modelValue"])]),a("div",je,[Ye,i(k,{id:"purchaseInvoiceDate",modelValue:t(e).purchaseInvoiceDate,"onUpdate:modelValue":o[6]||(o[6]=r=>t(e).purchaseInvoiceDate=r),onDateSelect:o[7]||(o[7]=r=>A())},null,8,["modelValue"])]),a("div",qe,[He,i(x,{modelValue:t(e).paymentMethodId,"onUpdate:modelValue":[o[8]||(o[8]=r=>t(e).paymentMethodId=r),o[9]||(o[9]=r=>A())],editable:"",options:t(I).masterData.paymentMethods,optionValue:"id",optionLabel:"name",class:P(["w-full",{"p-invalid":f.value.errors.paymentmethod}])},null,8,["modelValue","options","class"])])]),a("section",Ke,[a("div",We,[i(j,{type:t(G).CURRENCY,label:"Ports",id:"transportAmount",modelValue:t(e).transportAmount,"onUpdate:modelValue":[o[10]||(o[10]=r=>t(e).transportAmount=r),o[11]||(o[11]=r=>A())]},null,8,["type","modelValue"])]),a("div",Je,[i(j,{type:t(G).NUMERIC,label:"% IRPF",id:"extraTaxPercentatge",modelValue:t(e).extraTaxPercentatge,"onUpdate:modelValue":[o[12]||(o[12]=r=>t(e).extraTaxPercentatge=r),o[13]||(o[13]=r=>A())]},null,8,["type","modelValue"])]),a("div",Qe,[i(j,{type:t(G).NUMERIC,label:"% Dto.",id:"discountPercentage",modelValue:t(e).discountPercentage,"onUpdate:modelValue":[o[14]||(o[14]=r=>t(e).discountPercentage=r),o[15]||(o[15]=r=>A())]},null,8,["type","modelValue"])])]),a("section",Xe,[a("div",Ze,[et,a("span",tt,S(t(e).baseAmount)+" €",1)]),a("div",ot,[at,a("span",st,S(t(e).taxAmount)+" €",1)]),a("div",nt,[lt,a("span",it,S(t(e).netAmount)+" €",1)])])])):z("",!0)])}}});const ut=ae(rt,[["__scopeId","data-v-af2c4833"]]),dt={key:0},ct={class:"two-columns"},mt=a("label",{class:"block text-900 mb-2"},"IVA",-1),pt={class:"two-columns"},vt=q({__name:"FormPurchaseInvoiceImport",props:{formAction:{},invoiceImport:{}},emits:["submit"],setup(p,{emit:y}){const d=p,v=Z(),I=X(),e=ne(()=>d.formAction===V.CREATE?"Afegir":"Modificar"),T=()=>{const s=v.masterData.taxes.find(l=>l.id===d.invoiceImport.taxId);if(s&&W.isNumber(d.invoiceImport.baseAmount)){const l=d.invoiceImport.baseAmount,h=l/100*s.percentatge,A=l+h;d.invoiceImport.baseAmount=l,d.invoiceImport.taxAmount=W.round(h,2),d.invoiceImport.netAmount=W.round(A,2),console.log("netAmount, rounded netAmount",A,W.round(A,2))}},f=re().shape({baseAmount:ge().required("L'import base és obligatori").min(1,"L'import base ha de ser un número positiu")}),n=R({result:!1,errors:{}}),m=()=>{const s=new ue(f);n.value=s.validate(d.invoiceImport)},b=async()=>{if(m(),n.value.result)y("submit",d.invoiceImport);else{let s="";Object.entries(n.value.errors).forEach(l=>{s+=`${l[1].map(h=>h)}.   `}),I.add({severity:"warn",summary:"Formulari inválid",detail:s,life:5e3})}};return(s,l)=>{const h=E("Dropdown"),A=E("BaseInput"),O=E("Button");return s.invoiceImport?(F(),$("form",dt,[a("section",ct,[a("div",null,[mt,i(h,{modelValue:s.invoiceImport.taxId,"onUpdate:modelValue":[l[0]||(l[0]=D=>s.invoiceImport.taxId=D),l[1]||(l[1]=D=>T())],editable:"",options:t(v).masterData.taxes,optionValue:"id",optionLabel:"name"},null,8,["modelValue","options"])]),i(A,{class:P(["mb-2",{"p-invalid":n.value.errors.baseAmount}]),label:"Import Base",modelValue:s.invoiceImport.baseAmount,"onUpdate:modelValue":[l[2]||(l[2]=D=>s.invoiceImport.baseAmount=D),l[3]||(l[3]=D=>T())],type:t(G).CURRENCY},null,8,["modelValue","type","class"])]),a("section",pt,[i(A,{class:"mb-2",label:"Import Impost",modelValue:s.invoiceImport.taxAmount,"onUpdate:modelValue":l[4]||(l[4]=D=>s.invoiceImport.taxAmount=D),type:t(G).CURRENCY,disabled:""},null,8,["modelValue","type"]),i(A,{class:"mb-2",label:"Total",modelValue:s.invoiceImport.netAmount,"onUpdate:modelValue":l[5]||(l[5]=D=>s.invoiceImport.netAmount=D),type:t(G).CURRENCY,disabled:""},null,8,["modelValue","type"])]),i(O,{label:e.value,onClick:b,style:{float:"right"}},null,8,["label"])])):z("",!0)}}}),It=["onClick"],bt=q({__name:"TablePurchaseInvoiceImports",props:{purchaseInvoiceImports:{}},emits:["add","edit","delete"],setup(p,{emit:y}){const d=p,v=Z(),I=n=>{var b;const m=(b=v.masterData.taxes)==null?void 0:b.find(s=>s.id===n);if(m)return m.name},e=()=>{var b;const n=(b=v.masterData.taxes)==null?void 0:b.find(s=>s.name.includes("21")),m={id:ie(),baseAmount:null,taxId:n?n.id:"",taxAmount:0,netAmount:0,purchaseInvoiceId:""};y("add",m)},T=n=>{n.originalEvent.target.className.includes("grid_delete_column_button")||y("edit",n.data)},f=(n,m)=>{y("delete",m)};return(n,m)=>{const b=E("Button"),s=E("Column"),l=E("DataTable");return F(),J(l,{onRowClick:T,value:d.purchaseInvoiceImports,tableStyle:"min-width: 100%"},{default:g(()=>[i(b,{onClick:e,rounded:"",icon:t(L).PLUS,class:"grid_add_row_button",style:{"margin-right":"1.5rem"}},null,8,["icon"]),i(s,{field:"baseAmount",header:"Base",style:{width:"25%"}},{body:g(h=>[Y(S(h.data.baseAmount)+" € ",1)]),_:1}),i(s,{field:"taxId",header:"% IVA",style:{width:"25%"}},{body:g(h=>[Y(S(I(h.data.taxId)),1)]),_:1}),i(s,{field:"netAmount",header:"Import",style:{width:"25%"}},{body:g(h=>[Y(S(h.data.netAmount)+" € ",1)]),_:1}),i(s,{style:{width:"10%"}},{body:g(h=>[a("i",{class:P([t(L).TIMES,"grid_delete_column_button"]),onClick:A=>f(A,h.data)},null,10,It)]),_:1})]),_:1},8,["value"])}}}),Ft=q({__name:"PurchaseInvoice",setup(p){const y=R(),d=R(V.EDIT),v=be(),I=fe(),e=_e(),T=Z(),f=le(),{purchaseInvoice:n}=se(f),m=ne(()=>s.value===V.CREATE?"Introducció import":"Modificació import"),b=R(!1),s=R(V.EDIT),l=R(void 0),h=async()=>{let c="";await f.GetById(v.params.id),n.value?(d.value=V.EDIT,c=`Factura de compra: ${n.value.number}`,n.value.purchaseInvoiceDate=new Date(n.value.purchaseInvoiceDate)):(d.value=V.CREATE,f.setNewPurchaseInvoice(v.params.id),c="Alta de factures de compra",A()),e.setMenuItem({icon:L.POUND,backButtonVisible:!0,title:c})},A=()=>{var c,u,w;if(n.value){const C=(c=T.masterData.exercises)==null?void 0:c.find(M=>M.name===new Date().getFullYear().toString());C&&(n.value.exerciceId=C.id);const N=(u=T.masterData.series)==null?void 0:u.find(M=>M.name==="Nacional");N&&(n.value.purchaseInvoiceSerieId=N.id);const H=(w=T.masterData.statuses)==null?void 0:w.find(M=>M.name==="Nova");H&&(n.value.purchaseInvoiceStatusId=H.id)}};Q(async()=>{await h()});const O=()=>{y.value.submitForm()},D=(c,u)=>{c===V.CREATE&&(u.id=ie()),u.purchaseInvoiceId=n.value.id,l.value=u,s.value=c,b.value=!0},_=X(),o=async c=>{let u=!1,w="";d.value===V.CREATE?(u=await f.Create(c),w=u?"Factura creada":"Error al crear la factura"):(u=await f.Update(c),w=u?"Factura actualizada":"Error al actualizar la factura"),_.add({life:5e3,severity:u?"success":"error",summary:w}),u&&I.back()},x=async c=>{var u;s.value===V.CREATE?(d.value===V.EDIT&&await f.CreateInvoiceImport(c),(u=n.value)==null||u.purchaseInvoiceImports.push(c)):s.value===V.EDIT&&d.value===V.EDIT&&await f.UpdateInvoiceImport(c),r()},k=async c=>{console.log("deleteInvoiceImport"),d.value===V.EDIT&&await f.DeleteInvoiceImport(c);const u=n.value.purchaseInvoiceImports.filter(w=>w.id!==c.id);n.value.purchaseInvoiceImports=u,r()},r=()=>{y.value.calcAmounts(),b.value=!1};return(c,u)=>{const w=E("Button"),C=E("TabPanel"),N=E("Column"),H=E("DataTable"),M=E("TabView"),ce=E("Dialog");return F(),$(oe,null,[i(w,{label:"Guardar",class:"grid_add_row_button",onClick:O}),i(M,null,{default:g(()=>[t(n)?(F(),J(C,{key:0,header:"Factura"},{default:g(()=>[i(ut,{ref_key:"purchaseInvoiceForm",ref:y,purchaseInvoice:t(n),onSubmit:o},null,8,["purchaseInvoice"]),i(M,null,{default:g(()=>[i(C,{header:"Imports"},{default:g(()=>[i(bt,{"purchase-invoice-imports":t(n).purchaseInvoiceImports,onAdd:u[0]||(u[0]=U=>D(t(V).CREATE,U)),onEdit:u[1]||(u[1]=U=>D(t(V).EDIT,U)),onDelete:k},null,8,["purchase-invoice-imports"])]),_:1}),i(C,{header:"Venciments"},{default:g(()=>[i(H,{value:t(n).purchaseInvoiceDueDates,tableStyle:"min-width: 100%"},{default:g(()=>[i(N,{field:"dueDate",header:"Venciment",style:{width:"50%"}},{body:g(U=>[Y(S(t(he)(U.data.dueDate)),1)]),_:1}),i(N,{field:"amount",header:"Import",style:{width:"50%"}},{body:g(U=>[Y(S(U.data.amount)+" € ",1)]),_:1})]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})):z("",!0),i(C,{header:"Fitxers"},{default:g(()=>[t(n)?(F(),J(Se,{key:0,title:"Factures",entity:"PurchaseInvoice",id:t(v).params.id},null,8,["id"])):z("",!0)]),_:1})]),_:1}),l.value?(F(),J(ce,{key:0,closable:!0,visible:b.value,"onUpdate:visible":u[2]||(u[2]=U=>b.value=U),header:m.value,position:"bottom"},{default:g(()=>[i(vt,{formAction:s.value,invoiceImport:l.value,onSubmit:x},null,8,["formAction","invoiceImport"])]),_:1},8,["visible","header"])):z("",!0)],64)}}});export{Ft as default};

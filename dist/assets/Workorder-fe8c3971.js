import{d as N,j as A,H as ae,r as E,h as P,a as T,c as j,e as t,i as r,k as w,n as C,s as L,y as U,l as B,E as G,x as le,w as k,P as M,C as D,D as S,m as F,G as x,K as se,v as de,g as ne,u as ie,z as ue,o as ce,p as me,b as pe,f as ke}from"./index-50afd4ff.js";import{u as H}from"./plantmodel-7022a20f.js";import{u as J}from"./workorder-69844914.js";import{c as K,a as $,d as Q,F as X}from"./form-validator-f8953ae6.js";import{_ as fe}from"./DropdownReference.vue_vue_type_script_setup_true_lang-a3f5dbf0.js";import{u as z}from"./lifecycle-31bb0ab7.js";import{_ as we,a as be}from"./FormWorkorderPhase.vue_vue_type_script_setup_true_lang-fee29e63.js";import{g as Y,e as ve,f as ye,c as he}from"./functions-79f2dbc4.js";import{u as Z}from"./productionpart-4e1c992c.js";import{u as _e}from"./reference-a134c9cc.js";import"./index-fa80c822.js";import"./base.service-f381296e.js";import"./_commonjsHelpers-725317a4.js";import"./index-fe67f03a.js";import"./reference.service-b9737163.js";import"./v4-a960c1f4.js";const Pe={key:0},Ie={class:"mt-2"},Oe=t("label",{class:"block text-900 mb-2"},"Fase | Activitat",-1),Ve={class:"three-columns mt-2"},ge=t("label",{class:"block text-900 mb-2"},"Operari",-1),De=t("label",{class:"block text-900 mb-2"},"Màquina",-1),Te=t("label",{class:"block text-900 mb-2"},"Data Tíquet",-1),Ce={class:"two-columns mt-2"},Se=t("br",null,null,-1),$e={class:"flex-right"},qe=N({__name:"FormWorkOrderProductionPart",props:{productionPart:{},avoidWorkOrderRefresh:{type:Boolean}},emits:["submit","cancel"],setup(O,{emit:V}){const h=O,_=A(),g=H(),f=J(),y=ae(()=>{var c,d,m;if(!h.productionPart.workOrderPhaseId)return[];const n=(d=(c=f.workorder)==null?void 0:c.phases)==null?void 0:d.find(p=>p.id===h.productionPart.workOrderPhaseId);return n?(m=g.workcenters)==null?void 0:m.filter(p=>p.workcenterTypeId===n.workcenterTypeId):g.workcenters}),s=E(void 0),o=()=>{s.value.value&&(h.productionPart.workOrderId=s.value.value.workOrderId,h.productionPart.workOrderPhaseId=s.value.value.workOrderPhaseId,h.productionPart.workOrderPhaseDetailId=s.value.value.workOrderPhaseDetailId)},a=K().shape({operatorId:$().required("Escull un operari"),workcenterId:$().required("Escull una màquina"),workOrderId:$().required("Escull una ordre de fabricació"),workOrderPhaseId:$().required("Escull una fase"),workOrderPhaseDetailId:$().required("Escull una activitat"),quantity:Q().required("Has d'introduir una quantitat entera (pot ser 0)").integer(),time:Q().required("Has d'introduir el temps i ha de ser major que 0").moreThan(0)}),l=E({result:!1,errors:{}}),b=()=>{const n=new X(a);l.value=n.validate(h.productionPart)},I=async n=>{h.avoidWorkOrderRefresh||(s.value=void 0,await f.fetchByWorkcenterId(n))},i=async()=>{if(b(),l.value.result)V("submit",h.productionPart);else{let n="";Object.entries(l.value.errors).forEach(c=>{n+=`${c[1].map(d=>d)}.   `}),_.add({severity:"warn",summary:"Formulari inválid",detail:n,life:5e3})}};return(n,c)=>{var v,q,W;const d=P("Dropdown"),m=P("Calendar"),p=P("Button");return n.productionPart?(T(),j("form",Pe,[t("section",Ie,[t("div",null,[Oe,r(d,{modelValue:s.value,"onUpdate:modelValue":c[0]||(c[0]=e=>s.value=e),editable:"",filter:!0,options:(v=w(f).detailedWorkOrders)==null?void 0:v.sort((e,u)=>e.workOrderCode.localeCompare(u.workOrderCode)).map(e=>({label:"Fase "+e.workOrderPhaseCode+"  ("+e.workOrderPhaseDescription+") | "+e.machineStatusDescription,value:e})),optionLabel:"label",class:C(["w-full",{"p-invalid":l.value.errors.workOrderId}]),onChange:o},null,8,["modelValue","options","class"])])]),t("section",Ve,[t("div",null,[ge,r(d,{modelValue:n.productionPart.operatorId,"onUpdate:modelValue":c[1]||(c[1]=e=>n.productionPart.operatorId=e),editable:"",filter:!0,options:(q=w(g).operators)==null?void 0:q.sort((e,u)=>e.surname.localeCompare(u.surname)).map(e=>({value:e.id,label:e.name+" "+e.surname})),optionValue:"value",optionLabel:"label",class:C(["w-full",{"p-invalid":l.value.errors.operatorid}])},null,8,["modelValue","options","class"])]),t("div",null,[De,r(d,{modelValue:n.productionPart.workcenterId,"onUpdate:modelValue":c[2]||(c[2]=e=>n.productionPart.workcenterId=e),editable:"",filter:!0,options:(W=y.value)==null?void 0:W.sort((e,u)=>e.description.localeCompare(u.description)),optionValue:"id",optionLabel:"description",class:"w-full",onChange:c[3]||(c[3]=e=>I(n.productionPart.workcenterId))},null,8,["modelValue","options"])]),t("div",null,[Te,r(m,{modelValue:n.productionPart.date,"onUpdate:modelValue":c[4]||(c[4]=e=>n.productionPart.date=e),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),t("section",Ce,[t("div",null,[r(U,{type:w(L).NUMERIC,label:"Quantitat",id:"quantity",modelValue:n.productionPart.quantity,"onUpdate:modelValue":c[5]||(c[5]=e=>n.productionPart.quantity=e)},null,8,["type","modelValue"])]),t("div",null,[r(U,{type:w(L).NUMERIC,label:"Temps total (minuts)",id:"time",modelValue:n.productionPart.time,"onUpdate:modelValue":c[6]||(c[6]=e=>n.productionPart.time=e)},null,8,["type","modelValue"])])]),Se,t("div",$e,[r(p,{label:"Guardar",size:"small",onClick:i})])])):B("",!0)}}}),We={key:0},Be=t("br",null,null,-1),Ee={class:"four-columns"},Ue=t("label",{class:"block text-900 mb-2"},"Data Prevista",-1),Fe={class:"four-columns"},Me=t("label",{class:"block text-900 mb-2"},"Data Inici",-1),Ne=t("label",{class:"block text-900 mb-2"},"Data Fi",-1),Re=t("label",{class:"block text-900 mb-2"},"Comentari Fabricació",-1),Le=N({__name:"FormWorkorder",props:{workorder:{}},emits:["submit","cancel"],setup(O,{emit:V}){const h=O;z();const _=A(),g=K().shape({plannedQuantity:Q().min(1,"La quantitat ha de ser superior a 0").required("La quanitat és obligatoria"),referenceId:$().required("La referència és obligatoria"),order:Q().required("L'ordre és obligatori"),plannedDate:$().required("La data prevista és obligatoria")}),f=E({result:!1,errors:{}}),y=()=>{const o=new X(g);f.value=o.validate(h.workorder)},s=async()=>{if(y(),f.value.result)V("submit",h.workorder);else{let o="";Object.entries(f.value.errors).forEach(a=>{o+=`${a[1].map(l=>l)}.   `}),_.add({severity:"warn",summary:"Formulari inválid",detail:o,life:5e3})}};return(o,a)=>{const l=P("Button"),b=P("Calendar"),I=P("Textarea");return o.workorder?(T(),j("form",We,[t("div",null,[r(l,{label:"Guardar",class:"grid_add_row_button",size:"small",onClick:s}),Be]),t("section",Ee,[t("div",null,[r(U,{label:"Codi",modelValue:o.workorder.code,"onUpdate:modelValue":a[0]||(a[0]=i=>o.workorder.code=i),disabled:""},null,8,["modelValue"])]),t("div",null,[r(fe,{label:"Referència",modelValue:o.workorder.referenceId,"onUpdate:modelValue":a[1]||(a[1]=i=>o.workorder.referenceId=i),fullName:!0,disabled:""},null,8,["modelValue"])]),t("div",null,[r(U,{type:w(L).NUMERIC,label:"Quantitat",modelValue:o.workorder.plannedQuantity,"onUpdate:modelValue":a[2]||(a[2]=i=>o.workorder.plannedQuantity=i),class:C({"p-invalid":f.value.errors.plannedQuantity})},null,8,["type","modelValue","class"])]),t("div",null,[Ue,r(b,{modelValue:o.workorder.plannedDate,"onUpdate:modelValue":a[3]||(a[3]=i=>o.workorder.plannedDate=i),dateFormat:"dd/mm/yy",class:C(["mt-2",{"p-invalid":f.value.errors.plannedDate}])},null,8,["modelValue","class"])])]),t("section",Fe,[t("div",null,[r(we,{label:"Estat",modelValue:o.workorder.statusId,"onUpdate:modelValue":a[4]||(a[4]=i=>o.workorder.statusId=i),class:C({"p-invalid":f.value.errors.statusId})},null,8,["modelValue","class"])]),t("div",null,[Me,r(b,{modelValue:o.workorder.startTime,"onUpdate:modelValue":a[5]||(a[5]=i=>o.workorder.startTime=i),dateFormat:"dd/mm/yy",class:"mt-2"},null,8,["modelValue"])]),t("div",null,[Ne,r(b,{modelValue:o.workorder.endTime,"onUpdate:modelValue":a[6]||(a[6]=i=>o.workorder.endTime=i),dateFormat:"dd/mm/yy",class:"mt-2"},null,8,["modelValue"])]),t("div",null,[r(U,{type:w(L).NUMERIC,label:"Ordre",modelValue:o.workorder.order,"onUpdate:modelValue":a[7]||(a[7]=i=>o.workorder.order=i),class:C({"p-invalid":f.value.errors.plannedorderQuantity})},null,8,["type","modelValue","class"])])]),t("div",null,[Re,r(I,{class:"w-full",modelValue:o.workorder.comment,"onUpdate:modelValue":a[8]||(a[8]=i=>o.workorder.comment=i)},null,8,["modelValue"])])])):B("",!0)}}}),Qe={class:"flex flex-wrap align-items-center justify-content-between gap-2"},je=t("span",{class:"text-xl text-900 font-bold"},"Fases",-1),He=["onClick"],Ae=N({__name:"TableWorkorderPhases",props:{workorder:{},workorderPhases:{}},emits:["add","edit","delete"],setup(O,{emit:V}){const h=O,_=G({visible:!1,title:"Nova fase",closable:!0,position:"center",modal:!0}),g=le(),f=H(),y=z(),s=d=>{var p;if(!f.workcenterTypes)return"";const m=(p=f.workcenterTypes)==null?void 0:p.find(v=>d===v.id);return m?m.name:""},o=d=>{var p;if(!f.workcenters)return"";const m=(p=f.workcenters)==null?void 0:p.find(v=>d===v.id);return m?m.name:""},a=d=>{var p;if(!f.operatorTypes)return"";const m=(p=f.operatorTypes)==null?void 0:p.find(v=>d===v.id);return m?m.name:""},l=d=>{var p;if(!y.lifecycle||!y.lifecycle.statuses)return"";const m=(p=y.lifecycle.statuses)==null?void 0:p.find(v=>d===v.id);return m?m.name:""},b=E({}),I=()=>{b.value={id:Y(),workOrderId:h.workorder.id,disabled:!1,code:((h.workorder.phases.length+1)*10).toString(),description:"",operatorTypeId:null,workcenterTypeId:null,preferredWorkcenterId:null,isExternalWork:!1,externalWorkCost:0,statusId:"",startTime:null,endTime:null,workOrderPhaseDetails:[],workOrderPhaseBillOfMaterials:[]},_.visible=!0},i=d=>{_.visible=!1,V("add",d)},n=d=>{d.originalEvent.target.className.includes("grid_delete_column_button")||V("edit",d.data)},c=(d,m)=>{g.require({target:d.currentTarget,message:"Está segur que vol eliminar la fase?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{V("delete",m)}})};return(d,m)=>{const p=P("Button"),v=P("Column"),q=P("BooleanColumn"),W=P("DataTable"),e=P("Dialog");return T(),j(x,null,[r(W,{onRowClick:n,value:d.workorderPhases,tableStyle:"min-width: 100%"},{header:k(()=>[t("div",Qe,[je,r(p,{icon:w(M).PLUS,rounded:"",raised:"",onClick:I},null,8,["icon"])])]),default:k(()=>[r(v,{field:"code",header:"Codi",style:{width:"10%"}}),r(v,{field:"description",header:"Descripció",style:{width:"15%"}}),r(v,{header:"Tipus de màquina",style:{width:"15%"}},{body:k(u=>[D(S(s(u.data.workcenterTypeId)),1)]),_:1}),r(v,{header:"Màquina preferida",style:{width:"15%"}},{body:k(u=>[D(S(o(u.data.preferredWorkcenterId)),1)]),_:1}),r(v,{header:"Tipus d'operari",style:{width:"15%"}},{body:k(u=>[D(S(a(u.data.operatorTypeId)),1)]),_:1}),r(v,{header:"Estat",style:{width:"15%"}},{body:k(u=>[D(S(l(u.data.statusId)),1)]),_:1}),r(v,{header:"Extern",style:{width:"5%"}},{body:k(u=>[r(q,{value:u.data.isExternalWork},null,8,["value"])]),_:1}),r(v,{style:{width:"5%"}},{body:k(u=>[t("i",{class:C([w(M).TIMES,"grid_delete_column_button"]),onClick:R=>c(R,u.data)},null,10,He)]),_:1})]),_:1},8,["value"]),r(e,{visible:_.visible,"onUpdate:visible":m[0]||(m[0]=u=>_.visible=u),header:_.title,closable:_.closable,modal:_.modal},{default:k(()=>[b.value?(T(),F(be,{key:0,workorder:d.workorder,phase:b.value,onSubmit:i},null,8,["workorder","phase"])):B("",!0)]),_:1},8,["visible","header","closable","modal"])],64)}}}),ze=["onClick"],Ge=N({__name:"TableProductionParts",emits:["delete"],setup(O,{emit:V}){const h=Z(),_=H(),g=y=>{if(!y)return"";if(y.workOrderPhase&&y.workOrderPhaseDetail){const s=_.getMachineStatusNameById(y.workOrderPhaseDetail.machineStatusId);return`(${y.workOrderPhase.code}) ${y.workOrderPhase.description} - ${s}`}},f=(y,s)=>{y.stopPropagation(),V("delete",s)};return(y,s)=>{const o=P("Column"),a=P("DataTable");return T(),F(a,{value:w(h).productionParts,class:"p-datatable-sm",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"40vh"},{header:k(()=>[se(y.$slots,"header")]),empty:k(()=>[D(" No s'han trobat tiquets. ")]),loading:k(()=>[D(" Carregant tiquets. Si us plau espera. ")]),default:k(()=>[r(o,{field:"operatorId",header:"Operari",style:{width:"15%"}},{body:k(l=>[D(S(w(_).getOperatorNameById(l.data.operatorId)),1)]),_:1}),r(o,{field:"workcenterId",header:"Màquina",style:{width:"20%"}},{body:k(l=>[D(S(w(_).getWorkcenterNameById(l.data.workcenterId)),1)]),_:1}),r(o,{field:"workOrderPhaseId",header:"Fase/Estat",style:{width:"25%"}},{body:k(l=>[D(S(g(l.data)),1)]),_:1}),r(o,{field:"date",header:"Data",style:{width:"15%"}},{body:k(l=>[D(S(w(ve)(l.data.date)),1)]),_:1}),r(o,{field:"quantity",header:"Quantitat",style:{width:"10%"}}),r(o,{field:"time",header:"Temps Total (min)",style:{width:"15%"}}),r(o,{style:{width:"5%"}},{body:k(l=>[t("i",{class:C([w(M).TIMES,"grid_delete_column_button"]),onClick:b=>f(b,l.data)},null,10,ze)]),_:1})]),_:3},8,["value"])}}}),xe=O=>(me("data-v-c3d4bf88"),O=O(),pe(),O),Je={class:"main"},Ke={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Xe=xe(()=>t("span",{class:"text-xl text-900 font-bold"},"Hores",-1)),Ye=N({__name:"Workorder",setup(O){const V=de(),h=ne(),_=ie(),g=A(),f=z(),y=_e(),s=J(),o=H(),a=Z(),{workorder:l}=ue(s),b=E(""),I=G({visible:!1,title:"Crear tíquet de producció",closable:!0,position:"center",modal:!0});ce(async()=>{b.value=V.params.id,s.detailedWorkOrders=void 0,await i();let e="";e="Ordre de fabricació",l.value&&(e=`${e} ${l.value.code}`),_.setMenuItem({icon:M.BUILDING,backButtonVisible:!0,title:e})});const i=async()=>{await y.fetchReferencesByModule("sales"),await s.fetchOne(b.value),o.fetchActiveModel(),f.fetchOneByName("WorkOrder"),a.fetchByWorkOrderId(b.value),s.workorder&&(s.workorder.plannedDate=ye(s.workorder.plannedDate))},n=async e=>{s.workorder&&(s.workorder.plannedDate=he(s.workorder.plannedDate)),await s.update(b.value,e)&&await i()},c=async e=>{await s.createPhase(e)?h.push({path:`/workorder/${b.value}/phase/${e.id}`}):g.add({severity:"error",summary:"Error al crear la fase",detail:"Revisi el log per a més informació"})},d=e=>{h.push({path:`/workorder/${b.value}/phase/${e.id}`})},m=async e=>{await s.deletePhase(e.id)},p=E({}),v=()=>{p.value={id:Y(),workOrderId:b.value,workOrderPhaseId:"",workOrderPhaseDetailId:"",operatorId:"",workcenterId:"",time:0,quantity:0,date:new Date},l.value&&s.fetchByWorkOrderId(l.value.id),I.visible=!0},q=async()=>{I.visible=!1,await a.create(p.value)&&a.fetchByWorkOrderId(b.value)},W=async e=>{await a.delete(e.id),a.fetchByWorkOrderId(b.value)};return(e,u)=>{const R=P("TabPanel"),ee=P("Button"),re=P("TabView"),te=P("Dialog");return T(),j(x,null,[t("header",null,[w(l)?(T(),F(Le,{key:0,workorder:w(l),onSubmit:n},null,8,["workorder"])):B("",!0)]),t("main",Je,[r(re,null,{default:k(()=>[r(R,{header:"Fases"},{default:k(()=>[w(l)&&w(l).phases?(T(),F(Ae,{key:0,workorder:w(l),workorderPhases:w(l).phases,onAdd:c,onEdit:d,onDelete:m},null,8,["workorder","workorderPhases"])):B("",!0)]),_:1}),r(R,{header:"Hores"},{default:k(()=>[w(a).productionParts?(T(),F(Ge,{key:0,productionParts:w(a).productionParts,onDelete:W},{header:k(()=>[t("div",Ke,[Xe,r(ee,{icon:w(M).PLUS,rounded:"",raised:"",onClick:v},null,8,["icon"])])]),_:1},8,["productionParts"])):B("",!0)]),_:1})]),_:1})]),r(te,{visible:I.visible,"onUpdate:visible":u[0]||(u[0]=oe=>I.visible=oe),header:I.title,closable:I.closable,modal:I.modal},{default:k(()=>[r(qe,{productionPart:p.value,"avoid-work-order-refresh":!0,onSubmit:q},null,8,["productionPart"])]),_:1},8,["visible","header","closable","modal"])],64)}}});const fr=ke(Ye,[["__scopeId","data-v-c3d4bf88"]]);export{fr as default};
